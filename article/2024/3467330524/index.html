<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Redis 主从复制 - relication 源码分析, Lcn29">
    <meta name="description" content="1 replicationUnsetMaster  -  断开主从关系/**
 * 断开主从关系
 */ 
void replicationUnsetMaster(void) &amp;#123;

     // 没有设置主节点的, 直接返回
 ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Redis 主从复制 - relication 源码分析 | Lcn29</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Lcn29" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.svg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Lcn29</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.svg" class="logo-img circle responsive-img">
        
        <div class="logo-name">Lcn29</div>
        <div class="logo-desc">
            
            Technical System
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/lcn29" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #121317;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/lcn29" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Redis 主从复制 - relication 源码分析</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Redis/">
                                <span class="chip bg-color">Redis</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-08-26
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-10-10
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.7k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    25 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-replicationUnsetMaster-断开主从关系"><a href="#1-replicationUnsetMaster-断开主从关系" class="headerlink" title="1 replicationUnsetMaster  -  断开主从关系"></a>1 replicationUnsetMaster  -  断开主从关系</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * 断开主从关系
 */</span> 
<span class="token keyword">void</span> <span class="token function">replicationUnsetMaster</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

     <span class="token comment">// 没有设置主节点的, 直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// 释放主节点的 host 配置</span>
    <span class="token function">sdsfree</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost<span class="token punctuation">)</span><span class="token punctuation">;</span>f
    server<span class="token punctuation">.</span>masterhost <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// 把当前的 replid 复制到 replid2</span>
    <span class="token comment">// 重新生成一个新的 40 位随机 id 并赋值到 replid</span>
    <span class="token function">shiftReplicationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 释放代表主节点的 client 对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token punctuation">)</span> 
        <span class="token function">freeClient</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 server.cached_server 设置为空, 同时设置释放对应的内存</span>
    <span class="token function">replicationDiscardCachedMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取消主从复制的握手</span>
    <span class="token function">cancelReplicationHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭所有的从节点客户端</span>
    <span class="token function">disconnectSlaves</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前节点的主从复制状态设置为 REPL_STATE_NONE</span>
    server<span class="token punctuation">.</span>repl_state <span class="token operator">=</span> REPL_STATE_NONE<span class="token punctuation">;</span>

    <span class="token comment">// 从节点选中的数据库为 - 1</span>
    server<span class="token punctuation">.</span>slaveseldb <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>repl_no_slaves_since <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span>      
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="1-1-shiftReplicationId-切换第一组-replid-和-offset-到第二组"><a href="#1-1-shiftReplicationId-切换第一组-replid-和-offset-到第二组" class="headerlink" title="1.1 shiftReplicationId - 切换第一组 replid 和 offset 到第二组"></a>1.1 shiftReplicationId - 切换第一组 replid 和 offset 到第二组</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">shiftReplicationId</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 将 replid 复制到 replid2</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid2<span class="token punctuation">,</span> server<span class="token punctuation">.</span>replid<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将原本的复制积压缓冲区的偏移量 master_repl_offset + 1 放到第二组的  second_replid_offset </span>
    server<span class="token punctuation">.</span>second_replid_offset <span class="token operator">=</span> server<span class="token punctuation">.</span>master_repl_offset<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 重新生成一个 replid, 并赋值到 server.replid</span>
    <span class="token function">changeReplicationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="1-2-changeReplicationId-重新生成一个-replid"><a href="#1-2-changeReplicationId-重新生成一个-replid" class="headerlink" title="1.2 changeReplicationId - 重新生成一个 replid"></a>1.2 changeReplicationId - 重新生成一个 replid</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">changeReplicationId</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// CONFIG_RUN_ID_SIZE = 40, 重新随机生成一个 40 位的 id 并赋值到 replid</span>
    <span class="token function">getRandomHexChars</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid<span class="token punctuation">,</span> CONFIG_RUN_ID_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>replid<span class="token punctuation">[</span>CONFIG_RUN_ID_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="1-3-replicationDiscardCachedMaster-清空缓存的-cached-master"><a href="#1-3-replicationDiscardCachedMaster-清空缓存的-cached-master" class="headerlink" title="1.3 replicationDiscardCachedMaster - 清空缓存的 cached_master"></a>1.3 replicationDiscardCachedMaster - 清空缓存的 cached_master</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">replicationDiscardCachedMaster</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>cached_master <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token comment">// CLIENT_MASTER = 1&lt;&lt;1 = 1</span>
    <span class="token comment">// 先设置为 cashed_master 的 flags = flag &amp; (~CLIENT_MASTER), 简单理解就是把主节点的标识去掉</span>
    server<span class="token punctuation">.</span>cached_master<span class="token operator">-></span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>CLIENT_MASTER<span class="token punctuation">;</span>

    <span class="token comment">// 然后再释放 cached_master</span>
    <span class="token function">freeClient</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>cached_master<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>cached_master <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="1-4-cancelReplicationHandshake-取消主从复制的握手"><a href="#1-4-cancelReplicationHandshake-取消主从复制的握手" class="headerlink" title="1.4 cancelReplicationHandshake -  取消主从复制的握手"></a>1.4 cancelReplicationHandshake -  取消主从复制的握手</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">cancelReplicationHandshake</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_state <span class="token operator">==</span> REPL_STATE_TRANSFER<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 当前从节点的状态为 REPL_STATE_TRANSFER (正在接收从主节点发送过来的 RDB 文件)</span>

        <span class="token comment">// 停止同步传输</span>
        <span class="token comment">// 关闭从节点同步主节点的 socket 和临时文件描述符 repl_transfer_tmpfile</span>
        <span class="token function">replicationAbortSyncTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新状态为 REPL_STATE_CONNECT (未连接上主节点)</span>
        server<span class="token punctuation">.</span>repl_state <span class="token operator">=</span> REPL_STATE_CONNECT<span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_state <span class="token operator">==</span> REPL_STATE_CONNECTING <span class="token operator">||</span> <span class="token function">slaveIsInHandshakeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 当前的状态为 REPL_STATE_CONNECTING (正在建立连接) 或者处于握手阶段</span>

        <span class="token comment">// 关闭从节点同步主节点信息的 Socket, 对应的 Socket 文件描述符为 repl_transfer_s</span>
        <span class="token function">undoConnectWithMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新状态为 REPL_STATE_CONNECT (未连接上主节点)</span>
        server<span class="token punctuation">.</span>repl_state <span class="token operator">=</span> REPL_STATE_CONNECT<span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 3. 其他的情况 </span>

        <span class="token comment">// 其他状态返回 0</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="1-5-replicationAbortSyncTransfer-停止文件同步传输"><a href="#1-5-replicationAbortSyncTransfer-停止文件同步传输" class="headerlink" title="1.5 replicationAbortSyncTransfer - 停止文件同步传输"></a>1.5 replicationAbortSyncTransfer - 停止文件同步传输</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">replicationAbortSyncTransfer</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">serverAssert</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_state <span class="token operator">==</span> REPL_STATE_TRANSFER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭从节点同步主节点信息的 Socket repl_transfer_s 和对应的文件描述符 repl_transfer_tmpfile</span>
    <span class="token function">undoConnectWithMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_transfer_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unlink</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_transfer_tmpfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zfree</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_transfer_tmpfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="1-6-undoConnectWithMaster-断开和主节点的连接"><a href="#1-6-undoConnectWithMaster-断开和主节点的连接" class="headerlink" title="1.6 undoConnectWithMaster - 断开和主节点的连接"></a>1.6 undoConnectWithMaster - 断开和主节点的连接</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">undoConnectWithMaster</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> server<span class="token punctuation">.</span>repl_transfer_s<span class="token punctuation">;</span>

    <span class="token comment">// 删除 repl_transfer_s 这个文件描述符的事件</span>
    <span class="token function">aeDeleteFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>fd<span class="token punctuation">,</span>AE_READABLE<span class="token operator">|</span>AE_WRITABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 关闭这个文件描述符</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 重置为 - 1 </span>
    server<span class="token punctuation">.</span>repl_transfer_s <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="1-7-slaveIsInHandshakeState-判断当前从节点是否处于握手阶段"><a href="#1-7-slaveIsInHandshakeState-判断当前从节点是否处于握手阶段" class="headerlink" title="1.7 slaveIsInHandshakeState - 判断当前从节点是否处于握手阶段"></a>1.7 slaveIsInHandshakeState - 判断当前从节点是否处于握手阶段</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">slaveIsInHandshakeState</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 3 &lt;= server.repl_state &lt;= 13 </span>
    <span class="token keyword">return</span> server<span class="token punctuation">.</span>repl_state <span class="token operator">>=</span> REPL_STATE_RECEIVE_PONG <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>repl_state <span class="token operator">&lt;=</span> REPL_STATE_RECEIVE_PSYNC<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="1-8-disconnectSlaves-关闭所有的从节点"><a href="#1-8-disconnectSlaves-关闭所有的从节点" class="headerlink" title="1.8 disconnectSlaves - 关闭所有的从节点"></a>1.8 disconnectSlaves - 关闭所有的从节点</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">disconnectSlaves</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 遍历自身所有的从节点</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        listNode <span class="token operator">*</span>ln <span class="token operator">=</span> <span class="token function">listFirst</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">freeClient</span><span class="token punctuation">(</span><span class="token punctuation">(</span>client<span class="token operator">*</span><span class="token punctuation">)</span>ln<span class="token operator">-></span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="2-replicationSetMaster-保存主节点信息并进入待连接状态"><a href="#2-replicationSetMaster-保存主节点信息并进入待连接状态" class="headerlink" title="2 replicationSetMaster - 保存主节点信息并进入待连接状态"></a>2 replicationSetMaster - 保存主节点信息并进入待连接状态</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">replicationSetMaster</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>ip<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token operator">/</span> was_master <span class="token operator">=</span> 当前从节点的原本的主节点为 null
    <span class="token keyword">int</span> was_master <span class="token operator">=</span> server<span class="token punctuation">.</span>masterhost <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// 将入参的 IP 和 端口赋值给对应的字段</span>
    <span class="token function">sdsfree</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>masterhost<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>masterhost <span class="token operator">=</span> <span class="token function">sdsnew</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>masterport <span class="token operator">=</span> port<span class="token punctuation">;</span>

    <span class="token comment">// 旧的主节点客户端存在, 进行释放</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">freeClient</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 解除所有阻塞状态的客户端</span>
    <span class="token function">disconnectAllBlockedClients</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token comment">// 释放所有的从节点信息 </span>
    <span class="token function">disconnectSlaves</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取消主从复制的握手</span>
    <span class="token function">cancelReplicationHandshake</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// was_master = true, 也就是当前的从节点是第一次被设置为从节点</span>
    <span class="token comment">// 创建出一个 cache_server, 用于后续数据复制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>was_master<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 将 server.cached_server 设置为空, 同时设置释放对应的内存</span>
        <span class="token function">replicationDiscardCachedMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据当前参数合成出一个 client, 同时将其放到 cached_master</span>
        <span class="token function">replicationCacheMasterUsingMyself</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 设置当前的主从复制状态为待连接上主节点 (REPL_STATE_CONNECT)</span>
    server<span class="token punctuation">.</span>repl_state <span class="token operator">=</span> REPL_STATE_CONNECT<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="2-1-disconnectAllBlockedClients-释放所有阻塞状态的客户端"><a href="#2-1-disconnectAllBlockedClients-释放所有阻塞状态的客户端" class="headerlink" title="2.1 disconnectAllBlockedClients - 释放所有阻塞状态的客户端"></a>2.1 disconnectAllBlockedClients - 释放所有阻塞状态的客户端</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">disconnectAllBlockedClients</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    listNode <span class="token operator">*</span>ln<span class="token punctuation">;</span>
    listIter li<span class="token punctuation">;</span>

    <span class="token comment">// 将 server.clients 的信息转移到 li 上</span>
    <span class="token function">listRewind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>clients<span class="token punctuation">,</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历 li</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        client <span class="token operator">*</span>c <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 客户端为阻塞状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-></span>flags <span class="token operator">&amp;</span> CLIENT_BLOCKED<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            
            <span class="token function">addReplySds</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token function">sdsnew</span><span class="token punctuation">(</span><span class="token string">"-UNBLOCKED force unblock from blocking operation, instance state changed (master -> replica?)\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 解除所有阻塞状态的客户端</span>
            <span class="token function">unblockClient</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            c<span class="token operator">-></span>flags <span class="token operator">|=</span> CLIENT_CLOSE_AFTER_REPLY<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="2-2-replicationCacheMasterUsingMyself-为-server-cached-master-赋值一个默认合成的客户端"><a href="#2-2-replicationCacheMasterUsingMyself-为-server-cached-master-赋值一个默认合成的客户端" class="headerlink" title="2.2 replicationCacheMasterUsingMyself - 为 server.cached_master 赋值一个默认合成的客户端"></a>2.2 replicationCacheMasterUsingMyself - 为 server.cached_master 赋值一个默认合成的客户端</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">replicationCacheMasterUsingMyself</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 设置当前的 master_initial_offset 等于 master_repl_offset</span>
    server<span class="token punctuation">.</span>master_initial_offset <span class="token operator">=</span> server<span class="token punctuation">.</span>master_repl_offset<span class="token punctuation">;</span>

    <span class="token comment">// 创建一个新的主节点客户端, 并存放发到 server.master 中</span>
    <span class="token function">replicationCreateMasterClient</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 server.replid 拷贝到创建出来的节点的 replid</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token operator">-></span>replid<span class="token punctuation">,</span> server<span class="token punctuation">.</span>replid<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 通过 replicationCreateMasterClient 创建出来的客户端, unlinkClient 里面的逻辑都不符合条件, 直接结束了</span>
    <span class="token comment">// 可以看成是没有这个方法的逻辑</span>
    <span class="token function">unlinkClient</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置 cached_master = master, 同时置空 master </span>
    server<span class="token punctuation">.</span>cached_master <span class="token operator">=</span> server<span class="token punctuation">.</span>master<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>master <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="2-3-replicationCreateMasterClient-创建主节点客户端"><a href="#2-3-replicationCreateMasterClient-创建主节点客户端" class="headerlink" title="2.3 replicationCreateMasterClient - 创建主节点客户端"></a>2.3 replicationCreateMasterClient - 创建主节点客户端</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 *  创建主节点客户端
 */</span>
<span class="token keyword">void</span> <span class="token function">replicationCreateMasterClient</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> dbid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 创建新的客户端, 赋值到 master, createClient 创建出来的 flag 默认为 0 </span>
    <span class="token comment">// 具体的创建逻辑可以查看 networking.c 中的 createClient 函数</span>
    server<span class="token punctuation">.</span>master <span class="token operator">=</span> <span class="token function">createClient</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 此时 flag = CLIENT_MASTER = 1, 主节点</span>
    server<span class="token punctuation">.</span>master<span class="token operator">-></span>flags <span class="token operator">|=</span> CLIENT_MASTER<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>master<span class="token operator">-></span>authenticated <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>master<span class="token operator">-></span>reploff <span class="token operator">=</span> server<span class="token punctuation">.</span>master_initial_offset<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>master<span class="token operator">-></span>read_reploff <span class="token operator">=</span> server<span class="token punctuation">.</span>master<span class="token operator">-></span>reploff<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token operator">-></span>replid<span class="token punctuation">,</span> server<span class="token punctuation">.</span>master_replid<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master_replid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果一个主节点的偏移量为 -1, 那么这个主节点是旧的, 并且是无法进行 psync 的, 所以将其设置为 CLIENT_PRE_PSYNC (1 &lt;&lt; 16, 65536)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token operator">-></span>reploff <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">// | CLIENT_PRE_PSYNC 后, flags 等于 65537</span>
        server<span class="token punctuation">.</span>master<span class="token operator">-></span>flags <span class="token operator">|=</span> CLIENT_PRE_PSYNC<span class="token punctuation">;</span>
    <span class="token comment">// 指定当前的数据库 (0 - 16 个数据库)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dbid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
        <span class="token function">selectDb</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token punctuation">,</span> dbid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="3-connectWithMaster-尝试和主节点建立-TCP-连接"><a href="#3-connectWithMaster-尝试和主节点建立-TCP-连接" class="headerlink" title="3 connectWithMaster -  尝试和主节点建立 TCP 连接"></a>3 connectWithMaster -  尝试和主节点建立 TCP 连接</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">connectWithMaster</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">int</span> fd<span class="token punctuation">;</span>

    <span class="token comment">// 建立非阻塞的 Tcp 连接</span>
    fd <span class="token operator">=</span> <span class="token function">anetTcpNonBlockBestEffortBindConnect</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>masterhost<span class="token punctuation">,</span> server<span class="token punctuation">.</span>masterport<span class="token punctuation">,</span> NET_FIRST_BIND_ADDR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 文件描述符为 -1, 建立连接失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 为 Tcp 连接的文件描述符注册一个的可读可写的事件, 处理的逻辑函数为 syncWithMaster</span>
    <span class="token comment">// 注意这里注册的类型为 AE_READABLE|AE_WRITABLE, 在 epoll 中, 底层注册的是 EPOLLIN | EPOLLOUT</span>
    <span class="token comment">// epoll 有个机制, 同时注册 EPOLLIN | EPOLLOUT 事件, 会立即触发一次 EPOLLOUT 事件, 也就是 AE_WRITABLE 事件</span>
    <span class="token comment">// 也就是在下次事件轮询中会执行一次 syncWithMaster 函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> fd<span class="token punctuation">,</span>AE_READABLE<span class="token operator">|</span>AE_WRITABLE<span class="token punctuation">,</span> syncWithMaster<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 更新从节点和主节点最近一次进行数据同步的时间, 默认为当前时间</span>
    server<span class="token punctuation">.</span>repl_transfer_lastio <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>repl_transfer_s <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token comment">// 当前从节点的主从复制的状态为 REPL_STATE_CONNECTING (正在连接主节点)</span>
    server<span class="token punctuation">.</span>repl_state <span class="token operator">=</span> REPL_STATE_CONNECTING<span class="token punctuation">;</span>
    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="4-sendSynchronousCommand-发送命令到主节点"><a href="#4-sendSynchronousCommand-发送命令到主节点" class="headerlink" title="4 sendSynchronousCommand - 发送命令到主节点"></a>4 sendSynchronousCommand - 发送命令到主节点</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">sendSynchronousCommand</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 发送写命令</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> SYNC_CMD_WRITE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 发送 ping 命令时, 入参为 (SYNC_CMD_WRITE,fd,"PING",NULL)</span>
        <span class="token comment">// flags = SYNC_CMD_WRITE</span>
        
        <span class="token keyword">char</span> <span class="token operator">*</span>arg<span class="token punctuation">;</span>

        <span class="token comment">// 下面的 va_ 开头的函数, 都是用来处理动态入参的</span>
        va_list ap<span class="token punctuation">;</span>
        sds cmd <span class="token operator">=</span> <span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sds cmdargs <span class="token operator">=</span> <span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">size_t</span> argslen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            arg <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>arg <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token comment">// 拼接 cmd 命令的参数</span>
            cmdargs <span class="token operator">=</span> <span class="token function">sdscatprintf</span><span class="token punctuation">(</span>cmdargs<span class="token punctuation">,</span><span class="token string">"$%zu\r\n%s\r\n"</span><span class="token punctuation">,</span><span class="token function">strlen</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            argslen<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        cmd <span class="token operator">=</span> <span class="token function">sdscatprintf</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span><span class="token string">"*%zu\r\n"</span><span class="token punctuation">,</span>argslen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cmd <span class="token operator">=</span> <span class="token function">sdscatsds</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span>cmdargs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sdsfree</span><span class="token punctuation">(</span>cmdargs<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 发送给对应的文件描述符, 这里的 fd 是 Socket 通道</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">syncWrite</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> cmd<span class="token punctuation">,</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>repl_syncio_timeout<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">sdsfree</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">sdscatprintf</span><span class="token punctuation">(</span><span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"-Writing to master: %s"</span><span class="token punctuation">,</span><span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">sdsfree</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 接受读操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> SYNC_CMD_READ<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 读取数据到 buf 中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">syncReadLine</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>server<span class="token punctuation">.</span>repl_syncio_timeout<span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">sdscatprintf</span><span class="token punctuation">(</span><span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"-Reading from master: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        server<span class="token punctuation">.</span>repl_transfer_lastio <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">sdsnew</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="5-slaveTryPartialResynchronization-根据条件判断是发送部分同步复制还是全量同步复制-同时支持读取主节点发送信息"><a href="#5-slaveTryPartialResynchronization-根据条件判断是发送部分同步复制还是全量同步复制-同时支持读取主节点发送信息" class="headerlink" title="5 slaveTryPartialResynchronization - 根据条件判断是发送部分同步复制还是全量同步复制, 同时支持读取主节点发送信息"></a>5 slaveTryPartialResynchronization - 根据条件判断是发送部分同步复制还是全量同步复制, 同时支持读取主节点发送信息</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">slaveTryPartialResynchronization</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> read_reply<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 入参的 read_reply 0: 表示向主节点写读取 1: 表示读取主节点的数据</span>

    <span class="token keyword">char</span> <span class="token operator">*</span>psync_replid<span class="token punctuation">;</span>
    <span class="token keyword">char</span> psync_offset<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    sds reply<span class="token punctuation">;</span>

    <span class="token comment">// 写操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>read_reply<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 设置初始的偏移量为 -1</span>
        <span class="token comment">// -1 表示示主节点的 replid 和全局复制偏移量是无效的</span>
        server<span class="token punctuation">.</span>master_initial_offset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">// 主节点的缓存不为空，可以尝试进行部分重同步</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>cached_master<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// psync_replid 为缓存的主节点的 replid</span>
            psync_replid <span class="token operator">=</span> server<span class="token punctuation">.</span>cached_master<span class="token operator">-></span>replid<span class="token punctuation">;</span>

            <span class="token comment">// 获取部分同步的开始位置 , 赋值给 psync_offset</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>psync_offset<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>psync_offset<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"%lld"</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>cached_master<span class="token operator">-></span>reploff<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 没有主节点缓存, 进行全量同步</span>
            psync_replid <span class="token operator">=</span> <span class="token string">"?"</span><span class="token punctuation">;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>psync_offset<span class="token punctuation">,</span><span class="token string">"-1"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">// 部分复制, 最终发送的命令 psync replid repl_offset</span>
        <span class="token comment">// 全量复制, 最终发送的命令 psync ? -1</span>
        reply <span class="token operator">=</span> <span class="token function">sendSynchronousCommand</span><span class="token punctuation">(</span>SYNC_CMD_WRITE<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token string">"PSYNC"</span><span class="token punctuation">,</span>psync_replid<span class="token punctuation">,</span>psync_offset<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 写失败, 删除对应的文件描述符的读监听</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>reply <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">sdsfree</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">aeDeleteFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>fd<span class="token punctuation">,</span>AE_READABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> PSYNC_WRITE_ERROR<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> PSYNC_WAIT_REPLY<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 下面的读操作可以等待下面的 psync 命令应答在回来看, 现在下面不影响整个的流程</span>

    <span class="token comment">// 读操作</span>
    reply <span class="token operator">=</span> <span class="token function">sendSynchronousCommand</span><span class="token punctuation">(</span>SYNC_CMD_READ<span class="token punctuation">,</span>fd<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sdslen</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 没有响应数据</span>
        <span class="token function">sdsfree</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> PSYNC_WAIT_REPLY<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// strncmp 比较字符串是否一样, 一样返回 0, 不一样, 返回值为非 0 </span>
    <span class="token comment">// 比较 reply 前 11 个字符是否为 +FULLRESYNC</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span><span class="token string">"+FULLRESYNC"</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
        <span class="token comment">// 响应的数据前面的内容为 +FULLRESYNC</span>

        <span class="token keyword">char</span> <span class="token operator">*</span>replid <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>offset <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token comment">// 这个是 psync 命令, 全量复制的响应 </span>

        <span class="token comment">// 定位到第一个空格的位置</span>
        replid <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span><span class="token char">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 获取响应的 replid</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>replid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 定位到 replid 的位置</span>
            replid<span class="token operator">++</span><span class="token punctuation">;</span>
            offset <span class="token operator">=</span> <span class="token function">strchr</span><span class="token punctuation">(</span>replid<span class="token punctuation">,</span><span class="token char">' '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>offset<span class="token punctuation">)</span> 
                <span class="token comment">// 定位到 offset 的位置</span>
                offset<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// replid 为  0 || offset 为 0 || offset - replid - 1 不等于 40 (replid 的长度为 40)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>replid <span class="token operator">||</span> <span class="token operator">!</span>offset <span class="token operator">||</span> <span class="token punctuation">(</span>offset<span class="token operator">-</span>replid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> CONFIG_RUN_ID_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// 设置 replid 为 0</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master_replid<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>CONFIG_RUN_ID_SIZE<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        
            <span class="token comment">// 将 replid 复制给 server.master_replid </span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master_replid<span class="token punctuation">,</span> replid<span class="token punctuation">,</span> offset<span class="token operator">-</span>replid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>master_replid<span class="token punctuation">[</span>CONFIG_RUN_ID_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

            <span class="token comment">// server.master_initial_offset = 获取到的 offset</span>
            server<span class="token punctuation">.</span>master_initial_offset <span class="token operator">=</span> <span class="token function">strtoll</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">// 全量复制了, 缓存的主节点没有意义, 清空了</span>
        <span class="token comment">// 将 server.cached_server 设置为空, 同时设置释放对应的内存</span>
        <span class="token function">replicationDiscardCachedMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sdsfree</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> PSYNC_FULLRESYNC<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 响应的前面的数据为 +CONTINUE</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span><span class="token string">"+CONTINUE"</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
        <span class="token keyword">char</span> <span class="token operator">*</span>start <span class="token operator">=</span> reply<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>end <span class="token operator">=</span> reply<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\r'</span> <span class="token operator">&amp;&amp;</span> end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\n'</span> <span class="token operator">&amp;&amp;</span> end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">)</span> 
            end<span class="token operator">++</span><span class="token punctuation">;</span>
            
        <span class="token comment">// 结束的位置 - 开始的位置 = 40 </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start <span class="token operator">==</span> CONFIG_RUN_ID_SIZE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// 新的 replid </span>
            <span class="token keyword">char</span> new<span class="token punctuation">[</span>CONFIG_RUN_ID_SIZE<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">memcpy</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span>start<span class="token punctuation">,</span> CONFIG_RUN_ID_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            new<span class="token punctuation">[</span>CONFIG_RUN_ID_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

            <span class="token comment">// replid 和当前的缓存主节点 cached_master 的 replid 不一致</span>
            <span class="token comment">// 只能进行全量复制</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>new<span class="token punctuation">,</span> server<span class="token punctuation">.</span>cached_master<span class="token operator">-></span>replid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

                <span class="token comment">// 缓存的主节点的 replid 和参数的 replid 不一致</span>

                <span class="token comment">// 将当前的 cached_master 的 replid 赋值给 replid2</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid2<span class="token punctuation">,</span> server<span class="token punctuation">.</span>cached_master<span class="token operator">-></span>replid<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                server<span class="token punctuation">.</span>second_replid_offset <span class="token operator">=</span> server<span class="token punctuation">.</span>master_repl_offset<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>

                <span class="token comment">// 新的 replid 赋值到 server.replid</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid<span class="token punctuation">,</span> new<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 设置缓存的客户端的 cached_master 的 replid = server.replid</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>cached_master<span class="token operator">-></span>replid<span class="token punctuation">,</span> new<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 释放从节点</span>
                <span class="token function">disconnectSlaves</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> 
        
        <span class="token function">sdsfree</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 重新将 cached_master 作为主节点使用</span>
        <span class="token function">replicationResurrectCachedMaster</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
            <span class="token comment">// 没有复制积压缓冲区, 进行创建</span>
            <span class="token function">createReplicationBacklog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> PSYNC_CONTINUE<span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 主节点无法响应 psync 命令</span>
    <span class="token comment">// 主节点处于一个特殊的状态, 无法处理对应的请求</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span><span class="token string">"-NOMASTERLINK"</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">strncmp</span><span class="token punctuation">(</span>reply<span class="token punctuation">,</span><span class="token string">"-LOADING"</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">sdsfree</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> PSYNC_TRY_LATER<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 响应了异常</span>

    <span class="token function">sdsfree</span><span class="token punctuation">(</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将 server.cached_server 设置为空, 同时设置释放对应的内存</span>
    <span class="token function">replicationDiscardCachedMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> PSYNC_NOT_SUPPORTED<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="5-1-replicationResurrectCachedMaster-重新将-cached-master-作为主节点使用"><a href="#5-1-replicationResurrectCachedMaster-重新将-cached-master-作为主节点使用" class="headerlink" title="5.1 replicationResurrectCachedMaster - 重新将 cached_master 作为主节点使用"></a>5.1 replicationResurrectCachedMaster - 重新将 cached_master 作为主节点使用</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">replicationResurrectCachedMaster</span><span class="token punctuation">(</span><span class="token keyword">int</span> newfd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    server<span class="token punctuation">.</span>master <span class="token operator">=</span> server<span class="token punctuation">.</span>cached_master<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>cached_master <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>master<span class="token operator">-></span>fd <span class="token operator">=</span> newfd<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>master<span class="token operator">-></span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>CLIENT_CLOSE_AFTER_REPLY<span class="token operator">|</span>CLIENT_CLOSE_ASAP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>master<span class="token operator">-></span>authenticated <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>master<span class="token operator">-></span>lastinteraction <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span>
    <span class="token comment">// 修改状态为 REPL_STATE_CONNECTED (已连接上主节点)</span>
    server<span class="token punctuation">.</span>repl_state <span class="token operator">=</span> REPL_STATE_CONNECTED<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>repl_down_since <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">linkClient</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加事件</span>
    <span class="token comment">// 为当前的主节点添加一个读事件, 触发逻辑为 readQueryFromClient</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> newfd<span class="token punctuation">,</span> AE_READABLE<span class="token punctuation">,</span> readQueryFromClient<span class="token punctuation">,</span> server<span class="token punctuation">.</span>master<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">freeClientAsync</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 当前的主节点有数据需要发送 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clientHasPendingReplies</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 添加一个写事件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> newfd<span class="token punctuation">,</span> AE_WRITABLE<span class="token punctuation">,</span> sendReplyToClient<span class="token punctuation">,</span> server<span class="token punctuation">.</span>master<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">freeClientAsync</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="5-2-clientHasPendingReplies-判断当前的入参的客户端是否有数据需要发送"><a href="#5-2-clientHasPendingReplies-判断当前的入参的客户端是否有数据需要发送" class="headerlink" title="5.2 clientHasPendingReplies - 判断当前的入参的客户端是否有数据需要发送"></a>5.2 clientHasPendingReplies - 判断当前的入参的客户端是否有数据需要发送</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">clientHasPendingReplies</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 固定缓存区有数据 或者 回复列表有数据</span>
    <span class="token keyword">return</span> c<span class="token operator">-></span>bufpos <span class="token operator">||</span> <span class="token function">listLength</span><span class="token punctuation">(</span>c<span class="token operator">-></span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="5-3-createReplicationBacklog-创建复制积压缓冲区"><a href="#5-3-createReplicationBacklog-创建复制积压缓冲区" class="headerlink" title="5.3 createReplicationBacklog - 创建复制积压缓冲区"></a>5.3 createReplicationBacklog - 创建复制积压缓冲区</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">createReplicationBacklog</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token function">serverAssert</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    server<span class="token punctuation">.</span>repl_backlog <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>repl_backlog_histlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>repl_backlog_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 虽然没有任何数据, 但是第一个字节是数据写入的位置</span>
    server<span class="token punctuation">.</span>repl_backlog_off <span class="token operator">=</span> server<span class="token punctuation">.</span>master_repl_offset<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="6-clearReplicationId2-清除-replid2-和-second-replid-offset"><a href="#6-clearReplicationId2-清除-replid2-和-second-replid-offset" class="headerlink" title="6 clearReplicationId2 - 清除 replid2 和 second_replid_offset"></a>6 clearReplicationId2 - 清除 replid2 和 second_replid_offset</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * 清除 replid2 和 second_replid_offset
 */</span>
<span class="token keyword">void</span> <span class="token function">clearReplicationId2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid2<span class="token punctuation">,</span><span class="token char">'0'</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>replid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>replid2<span class="token punctuation">[</span>CONFIG_RUN_ID_SIZE<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>second_replid_offset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="7-masterTryPartialResynchronization-尝试和从节点进行部分同步复制"><a href="#7-masterTryPartialResynchronization-尝试和从节点进行部分同步复制" class="headerlink" title="7 masterTryPartialResynchronization - 尝试和从节点进行部分同步复制"></a>7 masterTryPartialResynchronization - 尝试和从节点进行部分同步复制</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">masterTryPartialResynchronization</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// client 进到这里面执行的命令为 psync ? -1 或 psync master_repl_id repl_offset</span>

    <span class="token keyword">long</span> <span class="token keyword">long</span> psync_offset<span class="token punctuation">,</span> psync_len<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>master_replid <span class="token operator">=</span> c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">-></span>ptr<span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> buflen<span class="token punctuation">;</span>

    <span class="token comment">// 读取入参的第 3 个参数到 psync_offset</span>
    <span class="token comment">// 读取失败, 直接全量同步</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLongLongFromObjectOrReply</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>psync_offset<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> 
        <span class="token keyword">goto</span> need_full_resync<span class="token punctuation">;</span>

    <span class="token comment">// 在入参的 repl_id 和当前主节点的 replid 不一样的条件下</span>
    <span class="token comment">// 1. 入参的 repl_id 和当前主节点一样的 replid2 不一样</span>
    <span class="token comment">// 2. 请求的偏移量 大于 second_replid_offset (也就是 replid2)</span>
    <span class="token comment">// replid2 可以看出当前节点同步了旧主节点数据的位置, second_replid_offset 可以看出是从节点同步了旧节点数据的位置</span>
    <span class="token comment">// 如果 second_replid_offset > replid2, 表示从节点同步的数据快于当前节点的, 从节点的数据比主节点多, 不合理, 直接全量同步</span>
    <span class="token comment">// 满足其中一种情况, 直接进入全量赋值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>master_replid<span class="token punctuation">,</span> server<span class="token punctuation">.</span>replid<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>master_replid<span class="token punctuation">,</span> server<span class="token punctuation">.</span>replid2<span class="token punctuation">)</span> <span class="token operator">||</span> psync_offset <span class="token operator">></span> server<span class="token punctuation">.</span>second_replid_offset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 这 2 种请求都不能进行部分同步, 直接进入全量同步</span>
        <span class="token keyword">goto</span> need_full_resync<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// psync_offset 可以看做是从复制积压缓冲区的哪个位置开始复制</span>
    <span class="token comment">// 当前复制积压缓冲区没有数据</span>
    <span class="token comment">// 请求的偏移量小于 repl_backlog_off (复制积压缓冲区 backlog 的第一个字节的逻辑位置是下次复制的开始位置), 说明 backlog 所备份的数据的已经太新了, 有一些数据被覆盖，则需要进行全量复制</span>
    <span class="token comment">// 请求的偏移量大于 repl_backlog_off + repl_backlog_histlen (backlog 的实际数据大小) 表示当前 backlog 的数据不够全，则需要进行全量复制</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>repl_backlog <span class="token operator">||</span> psync_offset <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>repl_backlog_off <span class="token operator">||</span> psync_offset <span class="token operator">></span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog_off <span class="token operator">+</span> server<span class="token punctuation">.</span>repl_backlog_histlen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">goto</span> need_full_resync<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 部分复制</span>

    <span class="token comment">// 设置为从节点标识 </span>
    c<span class="token operator">-></span>flags <span class="token operator">|=</span> CLIENT_SLAVE<span class="token punctuation">;</span>
    <span class="token comment">// 设置状态为 在线状态</span>
    c<span class="token operator">-></span>replstate <span class="token operator">=</span> SLAVE_STATE_ONLINE<span class="token punctuation">;</span>
    <span class="token comment">// 设置当前客户端, 也就是从节点的 应答时间为当前时间</span>
    c<span class="token operator">-></span>repl_ack_time <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span>
    <span class="token comment">// 设置当前客户端, 也就是从节点需要向主节点发送 ack 的标志 为 0, 没有 ack</span>
    c<span class="token operator">-></span>repl_put_online_on_ack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 当前节点的从节点列表添加当前的节点</span>
    <span class="token function">listAddNodeTail</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">,</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从节点的复制能力支持 psync2</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-></span>slave_capa <span class="token operator">&amp;</span> SLAVE_CAPA_PSYNC2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 发送内容 +CONTINUE 主节点当前的 repl_id \r\n</span>
        buflen <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"+CONTINUE %s\r\n"</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>replid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 不支持</span>
        <span class="token comment">// 发送内容 +CONTINUE\r\n</span>
        buflen <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"+CONTINUE\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 发送数据给从节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>c<span class="token operator">-></span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>buflen<span class="token punctuation">)</span> <span class="token operator">!=</span> buflen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">freeClientAsync</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    psync_len <span class="token operator">=</span> <span class="token function">addReplyReplicationBacklog</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>psync_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 计算延迟值小于 min-slaves-max-lag 的从节点的个数</span>
    <span class="token function">refreshGoodSlavesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>              

need_full_resync<span class="token operator">:</span>
    <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="7-1-addReplyReplicationBacklog-进行部分同步复制"><a href="#7-1-addReplyReplicationBacklog-进行部分同步复制" class="headerlink" title="7.1 addReplyReplicationBacklog - 进行部分同步复制"></a>7.1 addReplyReplicationBacklog - 进行部分同步复制</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">addReplyReplicationBacklog</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> offset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">long</span> <span class="token keyword">long</span> j<span class="token punctuation">,</span> skip<span class="token punctuation">,</span> len<span class="token punctuation">;</span>

    <span class="token comment">// 复制积压缓冲区没有数据实际没有数据, 直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog_histlen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/* Compute the amount of bytes we need to discard. */</span>

    <span class="token comment">// 跳过初始位置多少个字节</span>
    skip <span class="token operator">=</span> offset <span class="token operator">-</span> server<span class="token punctuation">.</span>repl_backlog_off<span class="token punctuation">;</span>

    <span class="token comment">// 因为复用着这一个复制积压缓冲区 repl_backlog, 写满了, 新的数据又重开始位置进行写</span>
    <span class="token comment">// repl_backlog 的容量 repl_backlog_size 和当前容量 repl_backlog_histlen 基本不会大于 repl_backlog 的容量大小</span>
    <span class="token comment">// 但是几个代表位置的字段 repl_backlog_idx repl_backlog_off 会大于 repl_backlog_size</span>
    <span class="token comment">// 所以下面位置的计算才那么复杂</span>

    <span class="token comment">// 计算出我们的复制积压缓冲区中数据实际最旧的位置, 在复制积压缓冲区的位置</span>
    <span class="token comment">// （下一个字节写入的位置 + 复制积压缓冲区的大小 - 复制积压缓冲区当前实际的容量）% 复制积压缓冲区的大小</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog_idx <span class="token operator">+</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog_size <span class="token operator">-</span> server<span class="token punctuation">.</span>repl_backlog_histlen<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> server<span class="token punctuation">.</span>repl_backlog_size<span class="token punctuation">;</span>

     <span class="token comment">// 计算当前复制的开始位置</span>
    j <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">+</span> skip<span class="token punctuation">)</span> <span class="token operator">%</span> server<span class="token punctuation">.</span>repl_backlog_size<span class="token punctuation">;</span>

    <span class="token comment">// 需要发送发送的数据长度</span>
    len <span class="token operator">=</span> server<span class="token punctuation">.</span>repl_backlog_histlen <span class="token operator">-</span> skip<span class="token punctuation">;</span>

    <span class="token comment">// 不为空</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
        <span class="token comment">// (复制积压缓冲区的容量 - 开始发送的位置) &lt; 需要发送的数据的长度 的话, 表示当前可以发送的数据有部分在复制积压缓冲区的开头</span>
        <span class="token comment">// 计算这次发送的数据长度</span>
        <span class="token keyword">long</span> <span class="token keyword">long</span> thislen <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog_size <span class="token operator">-</span> j<span class="token punctuation">)</span> <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog_size <span class="token operator">-</span> j<span class="token punctuation">)</span> <span class="token operator">:</span> len<span class="token punctuation">;</span>

        <span class="token comment">// 发送数据</span>
        <span class="token function">addReplySds</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token function">sdsnewlen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog <span class="token operator">+</span> j<span class="token punctuation">,</span> thislen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 重新计算下次需要发送的数据长度</span>
        len <span class="token operator">-=</span> thislen<span class="token punctuation">;</span>
        <span class="token comment">// 开始的位置重新从 0 开始</span>
        j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 返回写入的长度</span>
    <span class="token keyword">return</span> server<span class="token punctuation">.</span>repl_backlog_histlen <span class="token operator">-</span> skip<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="8-replicationSetupSlaveForFullResync-将最新的-repl-id-和-repl-offset-发送给从节点"><a href="#8-replicationSetupSlaveForFullResync-将最新的-repl-id-和-repl-offset-发送给从节点" class="headerlink" title="8 replicationSetupSlaveForFullResync - 将最新的 repl_id 和 repl_offset 发送给从节点"></a>8 replicationSetupSlaveForFullResync - 将最新的 repl_id 和 repl_offset 发送给从节点</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">replicationSetupSlaveForFullResync</span><span class="token punctuation">(</span>client <span class="token operator">*</span>slave<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> offset<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> buflen<span class="token punctuation">;</span>

    <span class="token comment">// 更新入参的客户端的 psync 偏移量为 offset </span>
    slave<span class="token operator">-></span>psync_initial_offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> buflen<span class="token punctuation">;</span>

    <span class="token comment">// 更新入参的客户端的 psync 偏移量为 offset </span>
    slave<span class="token operator">-></span>psync_initial_offset <span class="token operator">=</span> offset<span class="token punctuation">;</span>

    <span class="token comment">// 更新状态为 SLAVE_STATE_WAIT_BGSAVE_END (等待 bgsave 结束)</span>
    slave<span class="token operator">-></span>replstate <span class="token operator">=</span> SLAVE_STATE_WAIT_BGSAVE_END<span class="token punctuation">;</span>

    server<span class="token punctuation">.</span>slaveseldb <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 

    <span class="token comment">// 如果从节点的状态是 CLIENT_PRE_PSYNC，则表示是 Redis 是 2.8 之前的版本，则不将这些信息发送给从节点</span>
    <span class="token comment">// 在 2.8 之前只支持 SYNC 的全量复制同步，而在之后的版本提供了部分的重同步</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>slave<span class="token operator">-></span>flags <span class="token operator">&amp;</span> CLIENT_PRE_PSYNC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
        <span class="token comment">// 发送全量复制的消息给从节点</span>
        <span class="token comment">// 发送 +FULLRESYNC replid offset\r\n 给从节点 </span>
        buflen <span class="token operator">=</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"+FULLRESYNC %s %lld\r\n"</span><span class="token punctuation">,</span> server<span class="token punctuation">.</span>replid<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>slave<span class="token operator">-></span>fd<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>buflen<span class="token punctuation">)</span> <span class="token operator">!=</span> buflen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">freeClientAsync</span><span class="token punctuation">(</span>slave<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="9-startBgsaveForReplication-通过执行-Bgsave-进行全量同步"><a href="#9-startBgsaveForReplication-通过执行-Bgsave-进行全量同步" class="headerlink" title="9 startBgsaveForReplication - 通过执行 Bgsave 进行全量同步"></a>9 startBgsaveForReplication - 通过执行 Bgsave 进行全量同步</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">startBgsaveForReplication</span><span class="token punctuation">(</span><span class="token keyword">int</span> mincapa<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">int</span> retval<span class="token punctuation">;</span>

    <span class="token comment">// 是否支持 socket 同步, 支持无盘同步同时同步复制能力支持 EOF</span>
    <span class="token keyword">int</span> socket_target <span class="token operator">=</span> server<span class="token punctuation">.</span>repl_diskless_sync <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>mincapa <span class="token operator">&amp;</span> SLAVE_CAPA_EOF<span class="token punctuation">)</span><span class="token punctuation">;</span>
    listIter li<span class="token punctuation">;</span>
    listNode <span class="token operator">*</span>ln<span class="token punctuation">;</span>

    rdbSaveInfo rsi<span class="token punctuation">,</span> <span class="token operator">*</span>rsiptr<span class="token punctuation">;</span>

    <span class="token comment">// 创建出一个初始的 rdbSaveInfo</span>
    rsiptr <span class="token operator">=</span> <span class="token function">rdbPopulateSaveInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rsi<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rsiptr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
        <span class="token comment">// 创建处理的 rdbSaveInfo 不为空</span>
        
        <span class="token comment">// 支持 socket </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket_target<span class="token punctuation">)</span>
            <span class="token comment">// 大体的流程和正常的 RDB 相关, 就不张开了, 太长了, 可以查看 rdb.c 这个文件进行了解</span>
            <span class="token comment">// 1. 在节点客户端列表中找到所有状态为 SLAVE_STATE_WAIT_BGSAVE_START (等待 bgsave 开始, 也就是开始创建 RDB 文件) 并且支持 psync 命令的客户端, 向他们发送 +FULLRESYNC replid offset\r\n, 并修改状态为 SLAVE_STATE_WAIT_BGSAVE_END (等待 RDB 创建文件结束), 同时设置他们的 Socket 为阻塞模式 (可以理解为数据先堆积在 Socket 中, 后序一起发送)</span>
            <span class="token comment">// 2. 创建出一个子进程, 将当前主节点的数据以 EOF 要求的格式写入到满足上一步的所有从节点的 Socket 中</span>
            <span class="token comment">// EOF 格式</span>
            <span class="token comment">// 开头 $EOF: + 长度 40 的 16 位字符串 + \r\n</span>
            <span class="token comment">// 中间 RDB 内容</span>
            <span class="token comment">// 结尾 一开始的 长度 40 的 16 位字符串 </span>
            <span class="token comment">// 3. 全部写完后, 发送给对应的从节点</span>
            retval <span class="token operator">=</span> <span class="token function">rdbSaveToSlavesSockets</span><span class="token punctuation">(</span>rsiptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token comment">// 正常的 RDB 持久化, 将数据写入到一个文件中, rdb 类型为 RDB_CHILD_TYPE_DISK</span>
            retval <span class="token operator">=</span> <span class="token function">rdbSaveBackground</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>rdb_filename<span class="token punctuation">,</span>rsiptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 为空, 直接返回失败</span>
        retval <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 执行同步失败</span>
        <span class="token function">listRewind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">,</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            client <span class="token operator">*</span>slave <span class="token operator">=</span> ln<span class="token operator">-></span>value<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>slave<span class="token operator">-></span>replstate <span class="token operator">==</span> SLAVE_STATE_WAIT_BGSAVE_START<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

                <span class="token comment">// 删除对应的从节点</span>
                slave<span class="token operator">-></span>replstate <span class="token operator">=</span> REPL_STATE_NONE<span class="token punctuation">;</span>
                slave<span class="token operator">-></span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>CLIENT_SLAVE<span class="token punctuation">;</span>
                <span class="token function">listDelNode</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">,</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 响应一个失败的提示</span>
                <span class="token function">addReplyError</span><span class="token punctuation">(</span>slave<span class="token punctuation">,</span><span class="token string">"BGSAVE failed, replication can't continue"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                slave<span class="token operator">-></span>flags <span class="token operator">|=</span> CLIENT_CLOSE_AFTER_REPLY<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 磁盘同步类型处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>socket_target<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 无盘同步, 已经在 rdbSaveToSlavesSockets 中已更新从节点的信息</span>
        <span class="token comment">// 有盘同步, 在这一步处理</span>

        <span class="token function">listRewind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">,</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            client <span class="token operator">*</span>slave <span class="token operator">=</span> ln<span class="token operator">-></span>value<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>slave<span class="token operator">-></span>replstate <span class="token operator">==</span> SLAVE_STATE_WAIT_BGSAVE_START<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>、
                <span class="token comment">// 更新从节点客户端的偏移量, 状态和发送全量复制的消息给从节点</span>
                <span class="token comment">// 当前的从节点的状态将会变为 SLAVE_STATE_WAIT_BGSAVE_END</span>
                <span class="token function">replicationSetupSlaveForFullResync</span><span class="token punctuation">(</span>slave<span class="token punctuation">,</span> <span class="token function">getPsyncInitialOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 同步成功</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> 
        <span class="token comment">// 清除脚本缓存</span>
        <span class="token function">replicationScriptCacheFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="9-1-replicationScriptCacheFlush-清除-Lua-脚本的缓存"><a href="#9-1-replicationScriptCacheFlush-清除-Lua-脚本的缓存" class="headerlink" title="9.1 replicationScriptCacheFlush - 清除 Lua 脚本的缓存"></a>9.1 replicationScriptCacheFlush - 清除 Lua 脚本的缓存</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">replicationScriptCacheFlush</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">dictEmpty</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_scriptcache_dict<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">listRelease</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_scriptcache_fifo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>repl_scriptcache_fifo <span class="token operator">=</span> <span class="token function">listCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="10-freeReplicationBacklog-清空复制积压缓冲区"><a href="#10-freeReplicationBacklog-清空复制积压缓冲区" class="headerlink" title="10 freeReplicationBacklog - 清空复制积压缓冲区"></a>10 freeReplicationBacklog - 清空复制积压缓冲区</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">freeReplicationBacklog</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">serverAssert</span><span class="token punctuation">(</span><span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">zfree</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>repl_backlog <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="11-putSlaveOnline-更新从节点的状态"><a href="#11-putSlaveOnline-更新从节点的状态" class="headerlink" title="11 putSlaveOnline - 更新从节点的状态"></a>11 putSlaveOnline - 更新从节点的状态</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">putSlaveOnline</span><span class="token punctuation">(</span>client <span class="token operator">*</span>slave<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 更新从节点的状态为 SLAVE_STATE_ONLINE (在线状态)</span>
    slave<span class="token operator">-></span>replstate <span class="token operator">=</span> SLAVE_STATE_ONLINE<span class="token punctuation">;</span>
    <span class="token comment">// 未 ack 应答</span>
    slave<span class="token operator">-></span>repl_put_online_on_ack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新 ack 为未应答</span>
    slave<span class="token operator">-></span>repl_ack_time <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span> 
    <span class="token comment">// 新增写事件, 将当前客户端的输出缓冲区数据发生给从节点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> slave<span class="token operator">-></span>fd<span class="token punctuation">,</span> AE_WRITABLE<span class="token punctuation">,</span> sendReplyToClient<span class="token punctuation">,</span> slave<span class="token punctuation">)</span> <span class="token operator">==</span> AE_ERR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">freeClient</span><span class="token punctuation">(</span>slave<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 更新当前从节点中延迟值小于配置的</span>
    <span class="token function">refreshGoodSlavesCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="11-1-refreshGoodSlavesCount-刷新在线从节点且超时时间小于配置的从节点数量"><a href="#11-1-refreshGoodSlavesCount-刷新在线从节点且超时时间小于配置的从节点数量" class="headerlink" title="11.1 refreshGoodSlavesCount - 刷新在线从节点且超时时间小于配置的从节点数量"></a>11.1 refreshGoodSlavesCount - 刷新在线从节点且超时时间小于配置的从节点数量</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">refreshGoodSlavesCount</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    listIter li<span class="token punctuation">;</span>
    listNode <span class="token operator">*</span>ln<span class="token punctuation">;</span>
    <span class="token keyword">int</span> good <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 没有配置这 2 个配置, 直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>server<span class="token punctuation">.</span>repl_min_slaves_to_write <span class="token operator">||</span> <span class="token operator">!</span>server<span class="token punctuation">.</span>repl_min_slaves_max_lag<span class="token punctuation">)</span> 
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token function">listRewind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">,</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历当前所有的从节点, 找出状态为 SLAVE_STATE_ONLINE 和 超时时间小于配置的 repl_min_slaves_max_lag 的节点</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        client <span class="token operator">*</span>slave <span class="token operator">=</span> ln<span class="token operator">-></span>value<span class="token punctuation">;</span>
        <span class="token class-name">time_t</span> lag <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime <span class="token operator">-</span> slave<span class="token operator">-></span>repl_ack_time<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>slave<span class="token operator">-></span>replstate <span class="token operator">==</span> SLAVE_STATE_ONLINE <span class="token operator">&amp;&amp;</span> lag <span class="token operator">&lt;=</span> server<span class="token punctuation">.</span>repl_min_slaves_max_lag<span class="token punctuation">)</span> 
            good<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 更新个数</span>
    server<span class="token punctuation">.</span>repl_good_slaves_count <span class="token operator">=</span> good<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="12-cancelReplicationHandshake-从节点取消和主节点的握手"><a href="#12-cancelReplicationHandshake-从节点取消和主节点的握手" class="headerlink" title="12 cancelReplicationHandshake - 从节点取消和主节点的握手"></a>12 cancelReplicationHandshake - 从节点取消和主节点的握手</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">cancelReplicationHandshake</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_state <span class="token operator">==</span> REPL_STATE_TRANSFER<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">replicationAbortSyncTransfer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>repl_state <span class="token operator">=</span> REPL_STATE_CONNECT<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_state <span class="token operator">==</span> REPL_STATE_CONNECTING <span class="token operator">||</span> <span class="token function">slaveIsInHandshakeState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">undoConnectWithMaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>repl_state <span class="token operator">=</span> REPL_STATE_CONNECT<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="13-feedReplicationBacklogWithObject-向复制积压缓冲区-backlog-写数据"><a href="#13-feedReplicationBacklogWithObject-向复制积压缓冲区-backlog-写数据" class="headerlink" title="13 feedReplicationBacklogWithObject - 向复制积压缓冲区 backlog 写数据"></a>13 feedReplicationBacklogWithObject - 向复制积压缓冲区 backlog 写数据</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">feedReplicationBacklogWithObject</span><span class="token punctuation">(</span>robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">char</span> llstr<span class="token punctuation">[</span>LONG_STR_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> len<span class="token punctuation">;</span>

    <span class="token comment">// 写入的对象为 int 整数, 转为字符串处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>encoding <span class="token operator">==</span> OBJ_ENCODING_INT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        len <span class="token operator">=</span> <span class="token function">ll2string</span><span class="token punctuation">(</span>llstr<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>llstr<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>o<span class="token operator">-></span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p <span class="token operator">=</span> llstr<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        len <span class="token operator">=</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>o<span class="token operator">-></span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        p <span class="token operator">=</span> o<span class="token operator">-></span>ptr<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">feedReplicationBacklog</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h3 id="13-1-feedReplicationBacklog-更新复制积压缓冲区-backlog"><a href="#13-1-feedReplicationBacklog-更新复制积压缓冲区-backlog" class="headerlink" title="13.1 feedReplicationBacklog - 更新复制积压缓冲区 backlog"></a>13.1 feedReplicationBacklog - 更新复制积压缓冲区 backlog</h3><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">feedReplicationBacklog</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> ptr<span class="token punctuation">;</span>

    <span class="token comment">// 更新全局复制的偏移量</span>
    server<span class="token punctuation">.</span>master_repl_offset <span class="token operator">+=</span> len<span class="token punctuation">;</span>

    <span class="token comment">// 复制积压缓冲区, 随着是一个字符串数组, 但是可以看成是一个环形的, 写的尾部</span>
    <span class="token comment">// 会重新回到头部继续写, 所以每次写入时, 都需要更新写入位置的索引 repl_backlog_idx</span>

    <span class="token comment">// 写入的对象的长度不为 0, 就一直写 </span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 计算环形缓冲区还有多少空间</span>
        <span class="token class-name">size_t</span> thislen <span class="token operator">=</span> server<span class="token punctuation">.</span>repl_backlog_size <span class="token operator">-</span> server<span class="token punctuation">.</span>repl_backlog_idx<span class="token punctuation">;</span>
        <span class="token comment">// 如果空间足够，设置 thislen 写的长度为 len</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>thislen <span class="token operator">></span> len<span class="token punctuation">)</span> 
            thislen <span class="token operator">=</span> len<span class="token punctuation">;</span>
        <span class="token comment">// 空间不足够或着刚刚好，那么只写入剩余的空间数，等待下次循环时写入</span>

        <span class="token comment">// 将数据拷贝到复制积压缓冲区中    </span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog<span class="token operator">+</span>server<span class="token punctuation">.</span>repl_backlog_idx<span class="token punctuation">,</span>p<span class="token punctuation">,</span>thislen<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新下次写的下标</span>
        server<span class="token punctuation">.</span>repl_backlog_idx <span class="token operator">+=</span> thislen<span class="token punctuation">;</span>

        <span class="token comment">// 如果 repl_backlog_idx 已经到达缓冲区的尾部，那么重置它</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog_idx <span class="token operator">==</span> server<span class="token punctuation">.</span>repl_backlog_size<span class="token punctuation">)</span>
            server<span class="token punctuation">.</span>repl_backlog_idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新未写入的数据长度    </span>
        len <span class="token operator">-=</span> thislen<span class="token punctuation">;</span>
        <span class="token comment">// 更新未写入数据的地址</span>
        p <span class="token operator">+=</span> thislen<span class="token punctuation">;</span>
        <span class="token comment">// 更新实际数据的长度</span>
        server<span class="token punctuation">.</span>repl_backlog_histlen <span class="token operator">+=</span> thislen<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 实际数据的长度最大只能为复制缓冲区的大小，因为之后环形写入时会覆盖开头位置的数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>repl_backlog_histlen <span class="token operator">></span> server<span class="token punctuation">.</span>repl_backlog_size<span class="token punctuation">)</span>
        server<span class="token punctuation">.</span>repl_backlog_histlen <span class="token operator">=</span> server<span class="token punctuation">.</span>repl_backlog_size<span class="token punctuation">;</span>

    <span class="token comment">// 设置 backlog 所备份已复制的数据的偏移量，用于处理复制时的断线</span>
    server<span class="token punctuation">.</span>repl_backlog_off <span class="token operator">=</span> server<span class="token punctuation">.</span>master_repl_offset <span class="token operator">-</span> server<span class="token punctuation">.</span>repl_backlog_histlen <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h2 id="14-replicationSendAck-从节点发送心跳-ack-给主节点"><a href="#14-replicationSendAck-从节点发送心跳-ack-给主节点" class="headerlink" title="14 replicationSendAck - 从节点发送心跳 ack 给主节点"></a>14 replicationSendAck - 从节点发送心跳 ack 给主节点</h2><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">replicationSendAck</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    client <span class="token operator">*</span>c <span class="token operator">=</span> server<span class="token punctuation">.</span>master<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        c<span class="token operator">-></span>flags <span class="token operator">|=</span> CLIENT_MASTER_FORCE_REPLY<span class="token punctuation">;</span>
        <span class="token function">addReplyMultiBulkLen</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 内容: REPLCONF ACK repl_offset</span>
        <span class="token function">addReplyBulkCString</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token string">"REPLCONF"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addReplyBulkCString</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span><span class="token string">"ACK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addReplyBulkLongLong</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span>c<span class="token operator">-></span>reploff<span class="token punctuation">)</span><span class="token punctuation">;</span>
        c<span class="token operator">-></span>flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>CLIENT_MASTER_FORCE_REPLY<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
                
            </div>
            <hr/>
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/article/2024/2904586595/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="Redis 集群槽设计原理">
                        
                        <span class="card-title">Redis 集群槽设计原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-09-09
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Lcn29
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Redis/">
                        <span class="chip bg-color">Redis</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/article/2024/3467330528/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="Redis 主从复制 - 源码">
                        
                        <span class="card-title">Redis 主从复制 - 源码</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-08-26
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Lcn29
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Redis/">
                        <span class="chip bg-color">Redis</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <br/>

            Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            &nbsp; | &nbsp;&nbsp;Theme <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>

            
            <br>
            
            
                <span id="busuanzi_container_site_pv">
                    总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
            
            
                <span id="busuanzi_container_site_uv">
                    &nbsp; | &nbsp;&nbsp;总访问人数:&nbsp; <span id="busuanzi_value_site_uv" class="white-color"></span>
                </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
