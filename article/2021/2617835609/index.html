<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Redis ZipList 编码, Lcn29">
    <meta name="description" content="1 介绍官方的介绍
The ziplist is a specially encoded dually linked list that is designed
to be very memory efficient. It stores ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Redis ZipList 编码 | Lcn29</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Lcn29" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.svg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Lcn29</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.svg" class="logo-img circle responsive-img">
        
        <div class="logo-name">Lcn29</div>
        <div class="logo-desc">
            
            Technical System
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/lcn29" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #121317;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/lcn29" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/9.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Redis ZipList 编码</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Redis/">
                                <span class="chip bg-color">Redis</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-11-21
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-10-10
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    19 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1 介绍"></a>1 介绍</h2><p>官方的介绍</p>
<pre class="language-log" data-language="log"><code class="language-log">The ziplist is a specially encoded dually linked list that is designed
to be very memory efficient<span class="token punctuation">.</span> It stores both strings and integer values<span class="token punctuation">,</span>
where integers are encoded as actual integers instead of a series of
characters<span class="token punctuation">.</span> It allows push and pop operations on either side of the list
in O<span class="token operator">(</span><span class="token number">1</span><span class="token operator">)</span> time<span class="token punctuation">.</span> However<span class="token punctuation">,</span> because every operation requires a reallocation of
the memory used by the ziplist<span class="token punctuation">,</span> the actual complexity is related to the
amount of memory used by the ziplist<span class="token punctuation">.</span>

ziplist 是一个经过特殊编码的内存高效的双向链表。
它同时存储字符串和整数值<span class="token punctuation">,</span> 其中整数被编码为实际整数<span class="token punctuation">,</span> 而不是一系列字符。
它允许在 O<span class="token operator">(</span><span class="token number">1</span><span class="token operator">)</span> 时间内对列表的两边进行 push 和 pop 操作。
但是<span class="token punctuation">,</span> 因为每个操作都需要重新分配 ziplist 所使用的内存<span class="token punctuation">,</span> 所以实际的复杂性与 ziplist 所使用的内存数量有关。</code></pre>

<p>ziplist 是一个双向链表。但是它不存储指向上一个链表节点和指向下一个链表节点的指针, 而是存储上一个节点长度和当前节点长度。<br>通过牺牲部分读写性能, 来换取高效的内存空间利用率, 是一种时间换空间的思想。</p>
<p>注: 下面的分析也是按照 <strong>Redis 5.x</strong> 进行分析。</p>
<h2 id="2-ziplist-的实现逻辑"><a href="#2-ziplist-的实现逻辑" class="headerlink" title="2 ziplist 的实现逻辑"></a>2 ziplist 的实现逻辑</h2><p>在 Redis 中, ziplist 虽然是一个双向链表, 却是通过一个 <strong>char[]</strong> 数组实现的, 先后遍历时, 借助在存储数据时冗余的上一个节点长度和当前节点长度, 计算后得到上下节点的位置。<br>所以, 在 Reids 中, **ziplist &#x3D;&#x3D; char[]**。</p>
<p>首先明确一点, 在 C 语言中, char 类型只占 8 位 (这个很重要, 因为下面的内容基本都是会涉及到很多的字节内容), 整个 char[] 数组会被按照下面的格式进行划分。</p>
<p><img src="https://pic.imgdb.cn/item/655b1625c458853aef5649a6.png" alt="Alt &#39;char[] 实现 ziplist 的方式&#39;"></p>
<p>整个 char[] 数组的划分如下:  </p>
<blockquote>
<ol>
<li>0 ~ 3 位, 4 个字节, 叫做 <strong>zlbytes</strong>, 表示当前整个 ziplist 的字节长度, 也就是整个数组的长度, 因此压缩列表最多有 2^32 - 1 个字节</li>
<li>4 ~ 7 位, 4 个字节, 叫做 <strong>zltail</strong>, 表示当前 ziplist 的起始位置到最后一个 entry 元素的起始位置相差的字节数, 也就是 ziplist 的起始位置 + zltail &#x3D; ziplist 最后一个 entry 的起始位置 (简单理解就是, 数组的第几位是最后一个 entry 的开始位置)  </li>
<li>8 ~ 9 位, 2 个字节, 叫做 <strong>zllen</strong>, 表示当前整个 ziplist 中的 entry 个数, 也就是整个 ziplist 最多有 2^16 - 1 个 entry</li>
<li>10 ~ n 位, 字节数不定, 就是真正存储数据的 entry 集合</li>
<li>最后 1 位, 1 个字节, 叫做 <strong>zlend</strong>, 表示整个 ziplist 的结束位, 固定为 0xFF (255, 1111 1111)</li>
</ol>
</blockquote>
<p>整个数组中, 只有 entry 是存储数据的地方。</p>
<h3 id="2-1-entry-的结构"><a href="#2-1-entry-的结构" class="headerlink" title="2.1 entry 的结构"></a>2.1 entry 的结构</h3><p>整个 ziplist 的大体布局了解完了, 看一下存储数据的 entry, 整个 entry 的话分成了 3 部分</p>
<blockquote>
<ol>
<li>previous_entry_length: 当前 entry 的前一个 entry 的占的字节长度</li>
<li>encoding: 当前 entry 存储的数据内容是什么类型, 大体有 2 种：整数和字节数组 (也就是字符串)</li>
<li>content: 需要存储的内容</li>
</ol>
</blockquote>
<p><strong>previous_entry_length</strong>  </p>
<p>表示前一个 entry 的字节长度, 会占 1 个或者 5 个字节, 占的字节数取决于上一个 entry 的的字节长度。<br>当前一个 entry 的长度小于 254 字节时, 用 1 个字节表示。<br>当前一个 entry 的长度大于或等于 254 字节时, 用 5 个字节来表示, 这 5 个字节中第一个固定为 0xFE (254, 1111 1110)</p>
<p><strong>encoding</strong>  </p>
<p>当前 entry 的编码, 不同的编码, 表示后面的 content 是不同的内容, 会占 1, 2 或者 5 个字节, 占的字节取决于存储在当前 entry 内的内容的格式</p>
<table>
<thead>
<tr>
<th align="center">encoding 占的字节数</th>
<th align="center">encoding 的二进制</th>
<th align="center">二进制的前 2 位的</th>
<th align="center">表示的内容</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">00 bbbbbb</td>
<td align="center">00</td>
<td align="center">长度最大为 63 的字节数组,  encoding 后面的 6 位用来存储字节数组的长度</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1100 0000</td>
<td align="center">11</td>
<td align="center">int_16 的整数</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1101 0000</td>
<td align="center">11</td>
<td align="center">int 32 的整数</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1110 0000</td>
<td align="center">11</td>
<td align="center">int 64 的整数</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1111 0000</td>
<td align="center">11</td>
<td align="center">int 24 位的整数</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1111 1110</td>
<td align="center">11</td>
<td align="center">8 位的整数</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1111 bbbb</td>
<td align="center">11</td>
<td align="center">后面的 bbbb 的取值范围为 0001 到 1101 (避免和上面的 24 位和 8 位整数的影响), 表示 1 - 13, 这个编码表示的是后面没有 content 字段, 值存储在 encoding 后面 4 位, 表示值为 0 - 12, 进制值减 1</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">01 bbbbbb aaaa aaaa</td>
<td align="center">01</td>
<td align="center">长度最大为 2^14 - 1 的字节数组, 2 个字节的 encoding 后面的 14 位用来存储字节数组的长度</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">10_ bbbb bbbb aaaa aaaa cccc cccc dddd dddd</td>
<td align="center">10</td>
<td align="center">长度最大为 2^32 - 1 的字节数组, 5 个字节的 encoding 用后面的 4 个字节, 32 位用来存储字节数组的长度</td>
</tr>
</tbody></table>
<p>从上面的编码可以看出, encoding 的第一个字节的前二位可以确定后面 content 的数据类型了, 11xx xxxx 为整数, 不是 11xx xxxx 就是字节数组, 字节数组再判断前二位, 知道具体的长度类型, 最终得到了存储数据长度。</p>
<p><strong>content</strong><br>没什么好说的, 真正存储的数据。</p>
<h3 id="2-1-1-entry-代码中的实现-zlentry"><a href="#2-1-1-entry-代码中的实现-zlentry" class="headerlink" title="2.1.1 entry 代码中的实现 zlentry"></a>2.1.1 entry 代码中的实现 zlentry</h3><p>通过上面的 entry 组成分析可以知道, 整体的数据都是压缩在 entry 中的, 这个存储没问题。<br>但是在代码的处理中, 不可能说每次需要用就进行进行一次解析, 比如需要内容的长度, 解析对应的 entry, 需要内容的具体值, 再解析对应的 entry。<br>这个基本不实际, 一般都是直接将一个 entry 解析完成, 在整个<strong>方法域</strong>中都能起作用。  </p>
<p>在 <strong>Redis 5.x</strong> 中, entry 会被解析成 ZlEntry 对象, 解析后, 在整个方法的执行中都能通过这个 zlentry 获取到整个 entry 的内容。</p>
<p>zlentry 的定义  </p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zlentry</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/** previous_entry_length 占用了多少个字节, 取值为 1 或者 5 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> prevrawlensize<span class="token punctuation">;</span> 

    <span class="token comment">/** previous_entry_length 的表示的值 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> prevrawlen<span class="token punctuation">;</span> 

    <span class="token comment">/** encoding 占用了多少个字节  1,2,5 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> lensize<span class="token punctuation">;</span> 

    <span class="token comment">/** content 占用的字节数 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">;</span> 

    <span class="token comment">/** 
     * content 的数据类型, 用一些枚举替代, 不保存具体的值
     * 取值范围:
     * 0000 0000 长度最大为 63 的字节数组
     * 0100 0000 最大长度为 2^14 - 1 的字节数组 
     * 1000 0000 最大长度为 2^32 - 1 的字节数组
     * 1100 0000 整数
     */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> encoding<span class="token punctuation">;</span> 

    <span class="token comment">/** 头部的长度占用的长度, 等于 prevrawlensize + lensize */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> headersize<span class="token punctuation">;</span> 

    <span class="token comment">/** 当前 entry 在字节数组中的开始位置, 指向这个 entry 的指针开始 */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span> zlentry<span class="token punctuation">;</span></code></pre>

<p>在 <strong>Redis 5.x</strong> 的源码中, entry 解析为 zlentry 的方法有 2 个 <strong>zipEntry</strong> 和 <strong>zipEntrySafe</strong>, 2 个的逻辑的一样的。<br>不同的是后面的 zipEntrySafe 会加上字节长度的校验, 确保当前 entry 的内容不会超过当前存储内容的 char[] 数组的长度。</p>
<p><strong>下面的代码, 经过调整, 逻辑不变, 但是相对更容易理解, 所以和源码有点区别</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * zlentry 解析
 * @param p 就是需要解析的 entry 的指针地址, 转为为 Java 就是 可以理解为一个 int, 表示在 char[] 数组的这个位置 entry 的开始位置
 * @param e 就是一个 zlentry 的地址引用, 将解析后的结果存入到这个 zlentry
 */</span>
<span class="token keyword">void</span> <span class="token function">zipEntry</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> zlentry <span class="token operator">*</span>e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 从 p 的开始位置, 也就是 previous_entry_length 的位置解析出 prevrawlensize 和 prevrawlen, 存入到 e 对应的位置</span>
    <span class="token function">zip_decode_prevlen</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> e<span class="token operator">-></span>prevrawlensize<span class="token punctuation">,</span> e<span class="token operator">-></span>prevrawlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从 p + prevrawlensize 的位置, 也就是到了 encoding 的位置, 解析出 encoding,</span>
    <span class="token function">zip_entry_encoding</span><span class="token punctuation">(</span>p <span class="token operator">+</span> e<span class="token operator">-></span>prevrawlensize<span class="token punctuation">,</span> e<span class="token operator">-></span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 从 p + prevrawlensize 的位置, 也就是到了 encoding 的位置, 解析出 encoding, lensize, len 存入到 e 对应的位置</span>
    <span class="token function">zip_decode_length</span><span class="token punctuation">(</span>p <span class="token operator">+</span> e<span class="token operator">-></span>prevrawlensize<span class="token punctuation">,</span> e<span class="token operator">-></span> encoding<span class="token punctuation">,</span> e<span class="token operator">-></span>lensize<span class="token punctuation">,</span> e<span class="token operator">-></span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// e 的 headersize 的值等于 prevrawlensize + lensize 的值</span>
    e<span class="token operator">-></span>headersize <span class="token operator">=</span> e<span class="token operator">-></span>prevrawlensize <span class="token operator">+</span> e<span class="token operator">-></span>lensize<span class="token punctuation">;</span> 

    <span class="token comment">// e 的 p 值等于入参的 p 值, 也就是 entry 开始的位置</span>
    e<span class="token operator">-></span>p <span class="token operator">=</span> p<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">zip_decode_prevlen</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> prevlensize<span class="token punctuation">,</span> prevlen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 解析 previous_entry_length 占的字节数</span>
    <span class="token comment">// ZIP_BIG_PREVLEN = 0xfe, 1111 1110 </span>
    <span class="token comment">// 上面说过了 previous_entry_length 的字节长度只有 1 和 5</span>
    <span class="token comment">// 如果 5 个字节的话, 第一位必定是 0xfe</span>
    <span class="token comment">// 所以 第一位如果是 0xfe, 那么 previous_entry_length 必定是 5 个字节, 否则就是 1 个字节</span>
    <span class="token punctuation">(</span>prevlensize<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>prt<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> ZIP_BIG_PREVLEN <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>prevlensize<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 1 个字节, 那么第一个字节就是 previous_entry_length 的值</span>
        <span class="token punctuation">(</span>prevlen<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>prt<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 不是 1 个字节, 那么就是 5 个字节, 取后面的 4 个字节拼接成一个 int 值</span>
        <span class="token punctuation">(</span>prevlen<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>prt<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>prt<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>prt<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span>  <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>prt<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">zip_entry_encoding</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 注意此处的 ptr 不是 entry 的开始位置, 而是 entry + previous_entry_length 后的位置, 也就是 encoding 的开始位置</span>
    <span class="token comment">// encoding 等于当前 encoding 的第一个字节</span>
    <span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ZIP_STR_MASK = 0xc0, 二进制 1100 0000</span>
    <span class="token comment">// 当前 ptr[0] 小于 1100 0000, 表示 encoding 当前表示的是字节数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ZIP_STR_MASK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// encoding &amp; 1100 0000, 只取前 2 位, 即可</span>
        <span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">&amp;=</span> ZIP_STR_MASK<span class="token punctuation">;</span> 
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> <span class="token function">zip_decode_length</span><span class="token punctuation">(</span>ptr<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> lensize<span class="token punctuation">,</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// encoding &lt; 1100 0000, 字节数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">&lt;</span> ZIP_STR_MASK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">==</span> ZIP_STR_06B<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// ZIP_STR_06B = 0, 二进制 0000 0000</span>
            <span class="token comment">// 结果: 字节数组, 长度最大为 63 的字节数组, encoding 只需要使用 1 个字节存储</span>
            <span class="token punctuation">(</span>lensize<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                                            
            <span class="token comment">// 0x3f = 63, 二进制 0011 1111, &amp; 上 0011 1111, 得到 encoding 去掉前 2 位后的值, 也就是 content 的字节长度          </span>
            <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">;</span> 

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">==</span> ZIP_STR_14B<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  

            <span class="token comment">// ZIP_STR_14B = 64, 二进制 0100 0000</span>
            <span class="token comment">// 结果: 字节数组, 2^14 - 1 的字节数组, encoding 需要使用 2 个字节存储</span>
            <span class="token punctuation">(</span>lensize<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                                             
            <span class="token comment">// 得到存储在 encoding 2 个字节中 content 字节长度        </span>
            <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">==</span> ZIP_STR_32B<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// ZIP_STR_32B = 128, 二进制 10000000</span>
            <span class="token comment">// 结果: 字节数组, 2^32 - 1 的字节数组, encoding 需要使用 5 个字节存储</span>
            <span class="token punctuation">(</span>lensize<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>  
            <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// 异常情况处理</span>
            <span class="token punctuation">(</span>lensize<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>    

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 整数处理</span>
        <span class="token comment">// 整数的话, 默认 encoding 只需要一个字节</span>
        <span class="token punctuation">(</span>lensize<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">// ZIP_INT_8B = 254, 二进制 11111110, 表示 8 位的整数, content 只需要 1 个字节</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">==</span> ZIP_INT_8B<span class="token punctuation">)</span>  <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> 
        
        <span class="token comment">// ZIP_INT_16B = 192, 二进制 1100 0000, 表示 16 位的整数, content 需要 2 个字节</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">==</span> ZIP_INT_16B<span class="token punctuation">)</span> <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                         
        
        <span class="token comment">// ZIP_INT_24B = 240, 二进制 1111 0000, 表示 24 位的整数, content 需要 3 个字节</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">==</span> ZIP_INT_24B<span class="token punctuation">)</span> <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>  

        <span class="token comment">// ZIP_INT_32B = 208, 二进制 1101 0000, 表示 32 位的整数, content 需要 4 个字节</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">==</span> ZIP_INT_32B<span class="token punctuation">)</span> <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>                         

        <span class="token comment">// ZIP_INT_64B = 224, 二进制 1110 0000, 表示 64 位的整数, content 需要 5 个字节</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span> <span class="token operator">==</span> ZIP_INT_64B<span class="token punctuation">)</span> <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> 

        <span class="token comment">// ZIP_INT_IMM_MIN = 241, 二进制 1111 0001 </span>
        <span class="token comment">// ZIP_INT_IMM_MAX = 253, 二进制 1111 1101</span>
        <span class="token comment">// 1111 0001 &lt;= encoding &lt;= 1111 1101, 没有 content，值直接存储在 encoding </span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>encoding <span class="token operator">>=</span> ZIP_INT_IMM_MIN <span class="token operator">&amp;&amp;</span> encoding <span class="token operator">&lt;=</span> ZIP_INT_IMM_MAX<span class="token punctuation">)</span>
            <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> 
        <span class="token comment">// 异常情况处理</span>
            <span class="token punctuation">(</span>lensize<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>上面的就是 entry 解码为 zlentry 的过程, 同样的 zlentry 编码为 entry， 就是过程逆过来的处理, 就不展开了。</p>
<h2 id="3-ziplist-节省了哪些空间"><a href="#3-ziplist-节省了哪些空间" class="headerlink" title="3  ziplist 节省了哪些空间"></a>3  ziplist 节省了哪些空间</h2><p>我们可以知道 ziplist 是一个双向链表, 可以从 2 侧遍历。<br>通过 <strong>zltail</strong> 可以获取到最后一个 entry 的起始位置, 同时通过 entry 的 previous_entry_length 属性, 可以得到上一个 entry 的字节长度, 从而达到从后到前的遍历。<br>而从 ziplist 的 char[] 数组的第 10 位开始就是第一个 entry, 通过解码每一个 entry, 获取到每一个 entry 的长度, 也可以得到下一个 entry 的开始位置, 从而达到从前往后的遍历。<br>通过这种方式达到了用数组实现双向链表的操作。 </p>
<p>这种方式每次遍历都需要解码编, 浪费了时间, 影响执行效率, 但是节省了空间, 那么节省了哪些空间呢?</p>
<p>在传统的双向链表中的每一个节点需要</p>
<blockquote>
<ol>
<li>指向前一个节点的指针, 64 位的系统中, 这个指针需要 8 个字节的内存</li>
<li>指向后一个节点的指针, 同样是 8 个字节的内存</li>
<li>节点中的内容指针, 指向存储的字符串的指针, 8 个字节</li>
<li>C 语言中, 字符串的特殊处理, 末尾加上 \0 的结束符</li>
</ol>
</blockquote>
<p>最终需要 25 个字节的辅助, 假设现在有 3 个字符串 <strong>one</strong>, <strong>two</strong>, <strong>three</strong>, 内存中的情况如下:</p>
<p><img src="https://pic.imgdb.cn/item/655b1627c458853aef56523b.png" alt="Alt &#39;普通链表的内存形式&#39;"></p>
<p>而通过上面的 entry 进行存储时</p>
<blockquote>
<ol>
<li>previous_entry_length: 受前面的 entry 的长度影响, 但是最大为 5 个字节</li>
<li>encoding: 受当前存储的 entry 的内容影响, 最大为 5 个字节</li>
<li>content: 可以不需要借助 \0 结束<br>所以最终最坏的情况 (不考虑里面存储的内容) 需要 10 个字节的辅助。</li>
</ol>
</blockquote>
<h2 id="4-ziplist-在使用上的一些情况"><a href="#4-ziplist-在使用上的一些情况" class="headerlink" title="4 ziplist 在使用上的一些情况"></a>4 ziplist 在使用上的一些情况</h2><p>下面以插入 (伪代码) 为例, 进行分析</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * @param zl 插入的压缩列表
 * @param p 插入的位置指针, 原位置的 entry 变为当前插入 entry 的后一个节点
 * @param s 需要插入的字符串
 * @param slen 插入的字符串的长度
 */</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">ziplistInsert</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>zl<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> slen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 向压缩列表插入元素有 4 种情况</span>
	<span class="token comment">// 1. 列表没有数据的插入</span>
	<span class="token comment">// 2. 列表有数据, 在尾部插入</span>
	<span class="token comment">// 3. 列表有数据, 在中间插入</span>
	<span class="token comment">// 4. 列表有数据, 在首部插入</span>

    <span class="token comment">// 插入位置当前的 entry 的 previous_entry_length 占的字节数</span>
    <span class="token keyword">int</span> prevlensize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 插入位置当前的 entry 的 previous_entry_length 的值, 也就是当前插入的位置前一个 entry 的字节长度</span>
    <span class="token keyword">int</span> prevlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// ZIP_END = 0xff, 二进制 1111 1111</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> ZIP_END<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 插入的位置不是压缩列表的尾部, 插入的情况 3, 4</span>
        
        <span class="token comment">// 获取当前插入位置的 entry 的 previous_entry_length</span>
        <span class="token comment">// 获取到的 prevlen 就等于插入 entry 的 previous_entry_length</span>
        <span class="token function">zip_decode_prevlen</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> prevlensize<span class="token punctuation">,</span> prevlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        
        <span class="token comment">// 插入的位置是压缩列表的尾部, 插入的情况 1，2</span>

        <span class="token comment">// 获取到 zltail 指向的位置, zltail 一般指向的是最后一个 entry 的起始位置</span>
        <span class="token comment">// 当没有 entry 在当前压缩列表, zltai 指向的位置就是 zllen, 值为 0xff</span>
        <span class="token keyword">char</span> <span class="token operator">*</span>ptail <span class="token operator">=</span> <span class="token function">getZlTailPos</span><span class="token punctuation">(</span>zl<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>ptail<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> ZIP_END<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// ptail 也就是 zltail 对应的位置的第一个字节不是 0xff, 表示插入的压缩列表有数据了, 情况 2</span>
            <span class="token comment">// 获取 ptail 位置 entry 的字节长度, 也就是插入 entry 的 previous_entry_length</span>
            prevlen <span class="token operator">=</span> <span class="token function">getPreEntryLength</span><span class="token punctuation">(</span>zl<span class="token punctuation">,</span> ptail<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 给予一个初始值, 避免警告, 同时给一个容易排查的值, 便于后面没有初始时排查</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> value <span class="token operator">=</span> <span class="token number">123456789</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 插入的 entry 的编码</span>
    <span class="token keyword">char</span> encoding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 插入的 entry 的 content 需要的字节长度</span>
    <span class="token keyword">int</span> reqlen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// zipTryEncoding 的作用</span>
    <span class="token comment">// 尝试将传入的 s 转为整数, 如果可以转换将转换后的值放到 value, 同时将其编码放到 encoding, 同时返回 true</span>
    <span class="token comment">// 不能转换, 返回 false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zipTryEncoding</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> slen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encoding<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 可以转换</span>
        <span class="token comment">// 通过 encoding 获取当前的 int 需要的字节数, 也就是 content 的字节长度</span>
        reqlen <span class="token operator">=</span> <span class="token function">zipIntSize</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 不可以转换   </span>
        <span class="token comment">// 那么字符串的长度是多少, 需要的字节数就是多少</span>
        reqlen <span class="token operator">=</span> slen<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 加上上一个 entry 的长度</span>
    <span class="token comment">// reqLen 的长度 = previous_entry_length + content</span>
    reqlen <span class="token operator">+=</span> prevlen<span class="token punctuation">;</span>

    <span class="token comment">// 加上当前的 encoding 需要的字节数</span>
    <span class="token comment">// previous_entry_length + encoding + content, 这时候 reqLen 就是当前存储内容需要的字节数</span>
    reqlen <span class="token operator">+=</span> <span class="token function">getEncodingLength</span><span class="token punctuation">(</span>encoding<span class="token punctuation">,</span> slen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 当前的位置已经有 entry 的情况</span>
    <span class="token comment">// 插入的位置的当前的 entry, 将会变为插入 entry 的后一个 entry </span>
    <span class="token comment">// 那么当前的 entry 的 previous_entry_length 的字节数存储插入 entry 的字节长度 reqlen, 还需要多少个字节</span>
    
    <span class="token comment">// 三种情况 4, -4, 0</span>
    <span class="token keyword">int</span> nextdiff <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> ZIP_END<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">zipPrevLenByteDiff</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>reqlen<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>


    <span class="token comment">// 获取当前的压缩列表的字节长度</span>
    <span class="token keyword">int</span> curlen <span class="token operator">=</span> <span class="token function">getZlbytes</span><span class="token punctuation">(</span>zl<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 最新的压缩列表需要的在字节长度</span>
    newlen <span class="token operator">=</span> curlen <span class="token operator">+</span> reqlen <span class="token operator">+</span> nextdiff<span class="token punctuation">;</span>

    <span class="token comment">// 按照新内存重新分配一个新的压缩列表, 会将旧的压缩列表的内容全部拷贝到新的压缩列表</span>
    zl <span class="token operator">=</span> <span class="token function">ziplistResize</span><span class="token punctuation">(</span>zl<span class="token punctuation">,</span>newlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新 zlBytes 属性</span>
    <span class="token function">updateZlBytes</span><span class="token punctuation">(</span>zl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 更新 zlend 属性</span>
    <span class="token function">updateZlend</span><span class="token punctuation">(</span>zl<span class="token punctuation">,</span> newlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 插入的位置不是尾部, 需要迁移数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> ZIP_END<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 空出一个 reqlen + nextdiff 的空间, 存放插入的 entry</span>
        <span class="token function">memmove</span><span class="token punctuation">(</span>p<span class="token operator">+</span>reqlen<span class="token punctuation">,</span> p <span class="token operator">-</span> nextdiff<span class="token punctuation">,</span> curlen <span class="token operator">-</span> offset <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">+</span> nextdiff<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新当前需要插入的位置的下一个 entry 的 previous_entry_length</span>
        <span class="token function">updateNextEntryPreviousEntryLength</span><span class="token punctuation">(</span>p <span class="token operator">+</span> reqlen<span class="token punctuation">,</span> reqlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新 zlTail 属性</span>
        <span class="token function">updateZlTail</span><span class="token punctuation">(</span><span class="token function">getZlTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> reqlen <span class="token operator">+</span> nextdiff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 当后一个 entry 的 previous_entry_length 的字节有变动, 进行连续更新的检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextdiff <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 连续更新检查, 如果需要进行连续更新处理</span>
        <span class="token comment">// 连续更新后面聊</span>
        zl <span class="token operator">=</span> <span class="token function">ziplistCascadeUpdate</span><span class="token punctuation">(</span>zl<span class="token punctuation">,</span>p<span class="token operator">+</span>reqlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 更新当前 entry 的 previous_entry_length</span>
    <span class="token function">updateCurEntryPreviousEntryLength</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> prevlen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新当前 entry 的 encoding</span>
    <span class="token function">updateCurEntryEncoding</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> encoding<span class="token punctuation">,</span> slen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新当前 entry 的 content</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">zip2Str</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 字符串内容</span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">,</span> slen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 整数内容</span>
        <span class="token function">zipSaveInteger</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> value<span class="token punctuation">,</span> encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 更新 zlLen 属性</span>
    <span class="token function">updateZlLen</span><span class="token punctuation">(</span><span class="token function">getZlLen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> zl<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>从中可以看到整个新增的过程</p>
<blockquote>
<ol>
<li>如果插入的位置, 后面有 entry, 获取插入位置的 entry 的 previous_entry_length, 这个就是等一下插入 entry 的 previous_entry_length 值</li>
<li>如果插入的位置, 后面没有 entry, 需要获取到前一个 entry 的字节长度, 这个长度就是等一下插入 entry 的 previous_entry_length 值</li>
<li>获取当前插入的 entry 的编码 encoding</li>
<li>计算插入的 entry 需要的字节长度</li>
<li>计算插入的 entry 需要的字节长度 存入到插入位置的 entry 的 previous_entry_length, 还需要多少个字节 (0, 4, -4)</li>
<li>重新分配新的压缩列表, 更新 zlbytes, zlend</li>
<li>将新分配的压缩列表的要插入位置后面的内容, 往后移动, 空出需要插入的 entry 的空间</li>
<li>更新当前需要插入的位置的下一个 entry 的 previous_entry_length 为插入 entry 的字节长度</li>
<li>更新新的压缩列表的 zltail</li>
<li>当前需要插入的位置的下一个 entry 的 previous_entry_length 变动了, 进行连续更新的检查</li>
<li>逐步将需要插入的 entry 的 previous_entry_length, encoding, content 更新到新的压缩列表</li>
<li>更新新的压缩列表的 zllen</li>
</ol>
</blockquote>
<p>整个过程很复杂</p>
<blockquote>
<ol>
<li>涉及到插入 entry 的解码, 编码</li>
<li>新压缩列表的内存分配和旧数据的迁移</li>
<li>新的 entry 的编码</li>
<li>还有一个连续更新的问题</li>
</ol>
</blockquote>
<p><strong>连锁更新</strong></p>
<p>假设现在有一个列表 A(p_e_l&#x3D;5) B(p_e_l&#x3D;5) C(p_e_l&#x3D;5), 这时候如果插入一个只需要 1 个字节的 entry,  I(p_e_l&#x3D;5)。<br>A(p_e_l&#x3D;1) A 需要的字节数变小了, 假设刚好变为只需要 1 个字节，那么后面的 B 的 previous_entry_length 也需要变小,<br>导致 B 也变为只需要 1 个字节了, 导致 C 也需要变小, 从而引起了后面的连续更新</p>
<p>连锁更新会导致多次重新分配内存及数据复制，效率很低, 出现的情况在新增, 删除, 更新都有可能。<br>但是出现这种情况的概率是很低的, 所以 Redis 并没有为了避免连锁更新而采取措施。</p>
<p>上面的就是新增 entry 的过程, 基本可以从这个过程推导出更新删除的过程。</p>

                
            </div>
            <hr/>
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/article/2021/3272944063/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/20.jpg" class="responsive-img" alt="Redis 事件轮询">
                        
                        <span class="card-title">Redis 事件轮询</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-11-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Lcn29
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Redis/">
                        <span class="chip bg-color">Redis</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/article/2021/2448473522/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="Redis String 的三种编码">
                        
                        <span class="card-title">Redis String 的三种编码</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-11-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Lcn29
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Redis/">
                        <span class="chip bg-color">Redis</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <br/>

            Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            &nbsp; | &nbsp;&nbsp;Theme <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>

            
            <br>
            
            
                <span id="busuanzi_container_site_pv">
                    总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
            
            
                <span id="busuanzi_container_site_uv">
                    &nbsp; | &nbsp;&nbsp;总访问人数:&nbsp; <span id="busuanzi_value_site_uv" class="white-color"></span>
                </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
