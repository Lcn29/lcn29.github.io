<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Java JVM 栈帧, Lcn29">
    <meta name="description" content="执行引擎是 Java 虚拟机核心的组成部分之一。 在《Java虚拟机规范》中制定了 Java 虚拟机字节码执行引擎的概念模型,这个概念模型成为各大发行商的 Java 虚拟机执行引擎的统一外观 (Facade)。 
不同的虚拟机的实现中, 通">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Java JVM 栈帧 | Lcn29</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Lcn29" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.svg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Lcn29</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.svg" class="logo-img circle responsive-img">
        
        <div class="logo-name">Lcn29</div>
        <div class="logo-desc">
            
            Technical System
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/lcn29" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #121317;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/lcn29" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/12.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Java JVM 栈帧</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Java/">
                                <span class="chip bg-color">Java</span>
                            </a>
                        
                            <a href="/tags/JVM/">
                                <span class="chip bg-color">JVM</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-03-18
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-10-10
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.4k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    15 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>执行引擎是 Java 虚拟机核心的组成部分之一。 在《Java虚拟机规范》中制定了 Java 虚拟机字节码执行引擎的概念模型,<br>这个概念模型成为各大发行商的 Java 虚拟机执行引擎的统一外观 (Facade)。 </p>
<p>不同的虚拟机的实现中, 通常会有</p>
<blockquote>
<ol>
<li>解释执行 (通过解释器执行) </li>
<li>编译执行 (通过即时编译器产生本地代码执行)<br>两种选择, 也可能两者兼备, 还可能会有同时包含几个不同级别的即时编译器一起工作的执行引擎。<br>但是从外观上看, 所有的 Java 虚拟机的执行引擎都是: 输入的是<strong>字节码二进制流</strong>, 输出的是<strong>执行结果</strong>。</li>
</ol>
</blockquote>
<p>而这一个的过程, 落实到 HotSpot 的实现就是<strong>运行时栈帧</strong>。<br>下面会对<strong>运行时栈帧</strong>做一个简单的介绍。</p>
<h2 id="1-运行时栈帧"><a href="#1-运行时栈帧" class="headerlink" title="1 运行时栈帧"></a>1 运行时栈帧</h2><p>Java 虚拟机以方法作为最基本的执行单元, “栈帧” (Stack Frame) 则是用于支持虚拟机进行方法调用和方法执行背后的数据结构, 它也是虚拟机运行时数<br>据区中的虚拟机栈 (Virtual Machine Stack) 的栈元素。  </p>
<p>栈帧存储了方法的<strong>局部变量表</strong> + <strong>操作数栈</strong> + <strong>动态连接</strong> + <strong>方法返回地址</strong>等信息。<br>每一个方法从调用开始至执行结束的过程, 都对应着一个栈帧在虚拟机栈里面从入栈到出栈的过程。</p>
<p>在编译 Java 程序源码的时候, 栈帧中需要多大的局部变量表, 需要多深的操作数栈就已经被分析计算出来, 并且写入到方法表的 Code 属性之中。<br>一个栈帧需要分配多少内存, 并不会受到程序运行期变量数据的影响, 而仅仅取决于程序源码和具体的虚拟机实现的栈内存布局形式。</p>
<p>一个线程中的方法调用链可能会很长, 以 Java 程序的角度来看, 同一时刻, 同一条线程里面, 在调用堆栈的所有方法都同时处于执行状态。而对于执行引擎<br>来讲, 在活动线程中, 只有位于栈顶的方法才是在运行的, 只有位于栈顶的栈帧才是生效的, 其被称为 “当前栈帧” (Current Stack Frame), 与这个栈帧<br>所关联的方法被称为 “当前方法” (Current Method)。</p>
<p>综上, 栈帧的结构如下:<br><img src="https://pic.imgdb.cn/item/65a3cf24871b83018a13c595.png" alt="Alt &#39;栈帧结构&#39;"></p>
<h2 id="2-局部变量表-Local-Variables-Table"><a href="#2-局部变量表-Local-Variables-Table" class="headerlink" title="2 局部变量表 - Local Variables Table"></a>2 局部变量表 - Local Variables Table</h2><p>局部变量表是一组变量值的存储空间, 用于存放方法参数和方法内部定义的局部变量。在 Java 程序被编译为 Class 文件时, 就在方法的 Code 属性的<br>max_locals 数据项中确定了该方法所需分配的局部变量表的最大容量。</p>
<p>局部变量表的容量以变量槽 (Variable Slot) 为最小单位。1 个槽的具体大小, 《Java虚拟机规范》中并没有明确指出, 但是引导性地说明了 </p>
<blockquote>
<ol>
<li>boolean </li>
<li>byte</li>
<li>char</li>
<li>short</li>
<li>int</li>
<li>float</li>
<li>reference</li>
<li>returnAddress 类型的数据<br>这 8 种数据类型, 都可以使用 32 位或更小的物理内存来存储。</li>
</ol>
</blockquote>
<p>reference 类型表示对一个对象实例的引用, 《Java虚拟机规范》既没有说明它的长度, 也没有明确指出这种引用应有怎样的结构。<br>但是需要能通过这个引用做到两件事情</p>
<blockquote>
<ol>
<li>从根据引用直接或间接地查找到对象在 Java 堆中的数据存放的起始地址或索引</li>
<li>根据引用直接或间接地查找到对象所属数据类型在方法区中的存储的类型信息</li>
</ol>
</blockquote>
<p>returnAddress 类型模板很少见了, 它是为字节码指令 jsr, jsr_w 和 ret 服务的, 指向了一条字节码指令的地址, 某些很古老的 Java 虚拟机曾<br>经使用这几条指令来实现异常处理时的跳转, 但现在也已经全部改为采用异常表来代替了。</p>
<p>对于 64 位的数据类型, Java 虚拟机会以高位对齐的方式为其分配两个连续的变量槽空间。Java 语言中明确的 64 位的数据类型只有 long 和 double 两种。  </p>
<p>Java 虚拟机通过索引定位的方式使用局部变量表, 索引值的范围是从 0 开始至局部变量表最大的变量槽数量。如果访问的是 32 位数据类型的变量, 索引 N<br>就代表了使用第 N 个变量槽, 如果访问的是 64 位数据类型的变量, 则说明会同时使用第 N 和 N + 1 两个变量槽。 对于两个相邻的共同存放一个 64 位数<br>据的两个变量槽, 虚拟机不允许采用任何方式单独访问其中的某一个。</p>
<p>当一个方法被调用时, Java 虚拟机会使用局部变量表来完成参数值到参数变量列表的传递过程, 即实参到形参的传递。 如果执行的是实例方法 (没有被 static<br>修饰的方法), 那局部变量表中第 0 位索引的变量槽默认是用于传递方法所属对象实例的引用, 在方法中可以通过关键字 “this” 来访问到这个隐含的参数。<br>其余参数则按照参数表顺序排列, 占用从 1 开始的局部变量槽, 参数表分配完毕后, 再根据方法体内部定义的变量顺序和作用域分配其余的变量槽。</p>
<p>为了尽可能节省栈帧耗用的内存空间, 局部变量表中的变量槽是可以重用的, 方法体中定义的变量, 其作用域并不一定会覆盖整个方法体, 如果当前字节码 PC<br>计数器的值已经超出了某个变量的作用域, 那这个变量对应的变量槽就可以交给其他变量来重用。 不过, 这样的设计除了节省栈帧空间以外, 还会伴随有少量<br>额外的副作用, 例如在某些情况下变量槽的复用会直接影响到系统的垃圾收集行为</p>
<p>注: 在虚拟机运行参数中加上 “-verbose:gc” 来看看垃圾收集的过程。 </p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> placeholder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span></code></pre>

<p>输出结果:</p>
<pre class="language-log" data-language="log"><code class="language-log"><span class="token punctuation">[</span>GC <span class="token operator">(</span>System<span class="token punctuation">.</span>gc<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">)</span>  <span class="token number">76402K</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">67232K</span><span class="token operator">(</span><span class="token number">188416K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.0062015</span> secs<span class="token punctuation">]</span>
<span class="token punctuation">[</span>Full GC <span class="token operator">(</span>System<span class="token punctuation">.</span>gc<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">)</span>  <span class="token number">67232K</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">67164K</span><span class="token operator">(</span><span class="token number">188416K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.0253018</span> secs<span class="token punctuation">]</span></code></pre>

<p>发现在 System.gc() 运行后并没有回收掉这 64MB 的内存, 因为在执行 System.gc() 时, 变量 placeholder 还处于作用域之内, 虚拟机自然不敢回收掉 placeholder 的内存。</p>
<p>修改一下代码</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    	<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> placeholder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
	<span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span>
</code></pre>

<p>输出结果:</p>
<pre class="language-log" data-language="log"><code class="language-log"><span class="token punctuation">[</span>GC <span class="token operator">(</span>System<span class="token punctuation">.</span>gc<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">)</span>  <span class="token number">76402K</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">67232K</span><span class="token operator">(</span><span class="token number">188416K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.0062015</span> secs<span class="token punctuation">]</span>
<span class="token punctuation">[</span>Full GC <span class="token operator">(</span>System<span class="token punctuation">.</span>gc<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">)</span>  <span class="token number">67232K</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">67164K</span><span class="token operator">(</span><span class="token number">188416K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.0253018</span> secs<span class="token punctuation">]</span></code></pre>

<p>在 if 判断结束后, placeholder 的作用域被限制在花括号以内, 从代码逻辑上讲, 在执行 System.gc() 的时候, placeholder 已经不可能再被访问了, 但执行这段程序 gc 后, 64MB 的内存还是没释放。</p>
<p>再做一下修改</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> placeholder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>这次的输出结果:</p>
<pre class="language-log" data-language="log"><code class="language-log"><span class="token punctuation">[</span>GC <span class="token operator">(</span>System<span class="token punctuation">.</span>gc<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">)</span>  <span class="token number">76402K</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">67232K</span><span class="token operator">(</span><span class="token number">188416K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.0038170</span> secs<span class="token punctuation">]</span>
<span class="token punctuation">[</span>Full GC <span class="token operator">(</span>System<span class="token punctuation">.</span>gc<span class="token operator">(</span><span class="token operator">)</span><span class="token operator">)</span>  <span class="token number">67232K</span><span class="token operator">-</span><span class="token operator">></span><span class="token number">1629K</span><span class="token operator">(</span><span class="token number">188416K</span><span class="token operator">)</span><span class="token punctuation">,</span> <span class="token number">0.0189803</span> secs<span class="token punctuation">]</span></code></pre>

<p>placeholder 能否被回收的根本原因就是: 局部变量表中的变量槽是否还存有关于 placeholder 数组对象的引用。 第一次修改中, 代码虽然已经离开了 placeholder 的作用域, 但在此之后, 再没有发生过任何对局部变量表的读写操作, placeholder 原本所占用的变量槽还没有被其他变量所复用。 所以作为 GC Roots 一部分的局部变量表仍然保持着对它的关联。 这种关联没有被及时打断,  绝大部分情况下影响都很轻微。 但如果遇到一个方法, 其后面的代码有一些耗时很长的操作, 而前面又定义了占用了大量内存但实际上已经不会再使用的变量, 手动将其设置为 null 值 (用来代替那句 int<br>a&#x3D;12, 把变量对应的局部变量槽清空) 便不见得是一个绝对无意义的操作, 这种操作可以作为一种在极特殊情形 (对象占用内存大, 此方法的栈帧长时间不能被回收, 方法调用次数达不到即时编译器的编译条件) 下的 “奇技” 来使用。</p>
<p>我们知道在类的加载阶段, 对于类的属性值, 会存在 2 次赋值, 第一次在准备阶段, 基于了字段的默认值, 第二次基于字段真正的数值。 但是在局部变量中, 如果只声明了, 但是没有赋值, 这个字段是没法使用的, 因为其不存在默认值。</p>
<h2 id="3-操作数栈-Operand-Stack"><a href="#3-操作数栈-Operand-Stack" class="headerlink" title="3 操作数栈 - Operand Stack"></a>3 操作数栈 - Operand Stack</h2><p>操作数栈也常被称为操作栈, 是一个后入先出 (Last In First Out, LIFO) 的栈。<br>操作数栈的最大深度也在编译的时候被写入到 Code 属性的 max_stacks 数据项之中。 操作数栈的每一个元素都可以是包括 long 和 double 在内的任意 Java 数据类型。 32 位数据类型所占的栈容量为 1, 64 位数据类型所占的栈容量为 2。 当一个方法刚刚开始执行的时候, 这个方法的操作数栈是空的, 在方法的执行过程中, 会有各种<strong>字节码指令</strong>往操作数栈中写入和提取内容, 也就是出栈和入栈操作。 例如: 整数加法的字节码指令 iadd, 会从操作数栈的顶部出去 2 个数, 相加后, 在存入栈顶。</p>
<p>操作数栈中元素的数据类型必须与字节码指令的序列严格匹配。 每个字节码都有其操作的数据类型限制。 这个限制编译程序代码的时候, 编译器会进行保证, 在类校验阶段的数据流分析中还会再次验证这一点。</p>
<p>在概念模型中, 两个不同栈帧作为不同方法的虚拟机栈的元素, 是完全相互独立的。 但是在大多虚拟机的实现里都会进行一些优化处理, 令两个栈帧出现一部分重叠。 让下面栈帧的部分操作数 栈与上面栈帧的部分局部变量表重叠在一起, 这样做不仅节约了一些空间, 更重要的是在进行方法调 用时就可以直接共用一部分数据, 无须进行额外的参数复制传递了。</p>
<p><img src="https://pic.imgdb.cn/item/65a3cf22871b83018a13bdaf.png" alt="Alt &#39;栈帧真实实现&#39;"></p>
<ul>
<li>操作数栈 + 局部变量表配合的流程</li>
</ul>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> add <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span> num1<span class="token punctuation">,</span> <span class="token keyword">int</span> num2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        num1 <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> num1 <span class="token operator">+</span> num2<span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>先通过 <code>javac Application.java</code><br>得到字节码文件, 再通过 <code>javap -c -l -p -v Application.class &gt;&gt; class.txt</code></p>
<p>打开 class.txt 就能得到我们的字节码文件了, 内容如下</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">Compiled</span> from <span class="token string">"Application.java"</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token class-name">Application</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
       <span class="token number">0</span><span class="token operator">:</span> aload_0
       <span class="token number">1</span><span class="token operator">:</span> invokespecial #<span class="token number">1</span>                  <span class="token comment">// Method java/lang/Object."&lt;init>":()V</span>
       <span class="token number">4</span><span class="token operator">:</span> <span class="token keyword">return</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>InterruptedException</span><span class="token punctuation">;</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
       <span class="token number">0</span><span class="token operator">:</span> iconst_1
       <span class="token number">1</span><span class="token operator">:</span> iconst_2
       <span class="token number">2</span><span class="token operator">:</span> invokestatic  #<span class="token number">2</span>                  <span class="token comment">// Method add:(II)I</span>
       <span class="token number">5</span><span class="token operator">:</span> istore_1
       <span class="token number">6</span><span class="token operator">:</span> getstatic     #<span class="token number">3</span>                  <span class="token comment">// Field java/lang/System.out:Ljava/io/PrintStream;</span>
       <span class="token number">9</span><span class="token operator">:</span> iload_1
      <span class="token number">10</span><span class="token operator">:</span> invokevirtual #<span class="token number">4</span>                  <span class="token comment">// Method java/io/PrintStream.println:(I)V</span>
      <span class="token number">13</span><span class="token operator">:</span> <span class="token keyword">return</span>

  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Code</span><span class="token operator">:</span>
       <span class="token number">0</span><span class="token operator">:</span> iconst_3
       <span class="token number">1</span><span class="token operator">:</span> istore_0
       <span class="token number">2</span><span class="token operator">:</span> iload_0
       <span class="token number">3</span><span class="token operator">:</span> iload_1
       <span class="token number">4</span><span class="token operator">:</span> iadd
       <span class="token number">5</span><span class="token operator">:</span> istore_2
       <span class="token number">6</span><span class="token operator">:</span> iload_2
       <span class="token number">7</span><span class="token operator">:</span> ireturn
<span class="token punctuation">&#125;</span></code></pre>

<p>整理成图的话, 调用 add 方法前是这样的</p>
<p><img src="https://pic.imgdb.cn/item/65a3cf20871b83018a13b66d.png" alt="Alt &#39;栈帧处理过程-步骤1&#39;"></p>
<ul>
<li>先看一下 add 方法的局部变量</li>
</ul>
<p>首先我们看到 add 方法的局部变量表有三个属性, 分别是入参的 num1, num2, 还有方法内部声明的 result 变量。</p>
<p>补充说明: 因为这里的 add 方法是静态的, 所以入参有几个变量, 那么局部变量表就有几个。<br>在实际中, 如果方法是非静态的话, 局部变量变的第一个会多 1 个 this 的变量, 后面才是入参。</p>
<ul>
<li>add 方法的操作数栈的变化</li>
</ul>
<p>各个指令的作用可以通过查看官网得知: <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5">地址</a></p>
<p>add 方法  </p>
<ol>
<li>第一个指令 iconst_3, 把一个 int 的数字放入到操作栈, 这里的 iconst_3, 代表的是把 3 放入到操作栈 (注意这里的 iconst_? 只能表示到 5,<br>超过 5 后的指令会变成 bipush 数字)</li>
</ol>
<p>这时候的操作数栈是这样的<br><img src="https://pic.imgdb.cn/item/65a3cf1e871b83018a13abcc.png" alt="Alt &#39;栈帧处理过程-步骤2&#39;"></p>
<ol start="2">
<li>第二个指令 istore_0, 把操作数栈, 最上面的数字 (必须是 int) 出栈, 并覆盖局部变量表第 0 的位置</li>
</ol>
<p>这时候的操作数栈是这样的<br><img src="https://pic.imgdb.cn/item/65a3cf1c871b83018a13a1dd.png" alt="Alt &#39;栈帧处理过程-步骤3&#39;"></p>
<p>通过查看局部变量表的变化, 我们可以知道 <code>num1 = 3</code> 在程序中是分成了 2 个指令完成的</p>
<ol start="3">
<li>第三个指令 iload_0, 把第 0 个局部变量的值放入栈帧(这个值必须是 int 类型)<br>第四个命令为 iload_1, 那么就是把第 1 个局部变量放入到栈帧</li>
</ol>
<p>经过第三, 四个指令后, 这时候的操作数栈是这样的<br><img src="https://pic.imgdb.cn/item/65a3cf19871b83018a13967d.png" alt="Alt &#39;栈帧处理过程-步骤4&#39;"></p>
<ol start="4">
<li>第五个指令 iadd, 把栈帧中的头 2 个 int 操作数弹出来, 进行相加, 然后再把结果入栈。</li>
</ol>
<p>经过第五个指令后, 这时候的操作数栈是这样的<br><img src="https://pic.imgdb.cn/item/65a3cf17871b83018a138c42.png" alt="Alt &#39;栈帧处理过程-步骤5&#39;"></p>
<p>后面的六, 七 就省略了</p>
<p>ireturn 从纸面上就能里面了吧, 把操作数栈中的栈顶(一个 int 的数字)返回出去。</p>
<p>从上面的内容, 可以知道, 操作数栈用于方法执行过程的流转, 局部变量表则用于存储临时的变量数据。</p>
<h2 id="4-动态连接-Dynamic-Linking"><a href="#4-动态连接-Dynamic-Linking" class="headerlink" title="4 动态连接 - Dynamic Linking"></a>4 动态连接 - Dynamic Linking</h2><p>每个栈帧都包含一个指向运行时常量池中该栈帧所属方法的引用, 持有这个引用是为了支持方法调用过程中的动态连接。<br>Class 文件的常量池中存有大量的符号引用, 字节码中的方法调用指令就以常量池里指向方法的符号引用作为参数 (invokevirtual #4 &#x2F;&#x2F; Method java&#x2F;io&#x2F;PrintStream.println:(I)V)<br>这些符号引用一部分会在类加载阶段或者第一次使用的时候就被转化为直接引用, 这种转化被称为静态解析。 另外一部分将在每一次运行期间都转化为直接引用,<br>这部分就称为动态连接。</p>
<h2 id="5-方法返回地址-return-address"><a href="#5-方法返回地址-return-address" class="headerlink" title="5 方法返回地址 - return address"></a>5 方法返回地址 - return address</h2><p>当一个方法开始执行后, 只有两种方式退出这个方法。  </p>
<p>第一种方式是执行引擎遇到任意一个方法返回的字节码指令, 这时候可能会有返回值传递给上层的方法调用者 (调用当前方法的方法称为调用者或者主调方法),<br>方法是否有返回值以及返回值的类型将根据遇到何种方法返回指令来决定, 这种退出方法的方式称为 “正常调用完成” (Normal Method Invocation Completion)</p>
<p>第二种退出方式是在方法执行的过程中遇到了异常, 并且这个异常没有在方法体内得到妥善处理。无论是 Java 虚拟机内部产生的异常, 还是代码中使用 athrow<br>字节码指令产生的异常。只要在本方法的异常表中没有搜索到匹配的异常处理器, 就会导致方法退出, 这种退出方法的方式称为 “异常调用完成 (Abrupt Method Invocation Completion)”。<br>一个方法使用异常完成出口的方式退出, 是不会给它的上层调用者提供任何返回值的。</p>
<p>无论采用何种退出方式, 在方法退出之后, 都必须返回到最初方法被调用时的位置, 程序才能继续执行。<br>方法返回时可能需要在<strong>栈帧</strong>中保存一些信息, 用来帮助恢复它的上层主调方法的执行状态。<br>一般来说, 方法正常退出时, 主调方法的 PC 计数器的值就可以作为返回地址, 栈帧中很可能会保存这个计数器值。而方法异常退出时, 返回地址是要通过异常<br>处理器表来确定的, 栈帧中就一般不会保存这部分信息。</p>
<p>方法退出的过程实际上等同于把当前栈帧出栈, 因此退出时可能执行的操作有: 恢复上层方法的局部变量表和操作数栈, 把返回值 (如果有的话) 压入调用者栈<br>帧的操作数栈中, 调整 PC 计数器的值以指向方法调用指令后面的一条指令等。</p>
<h2 id="6-附加信息-overhead-information"><a href="#6-附加信息-overhead-information" class="headerlink" title="6 附加信息 - overhead information"></a>6 附加信息 - overhead information</h2><p>《Java虚拟机规范》允许虚拟机实现增加一些规范里没有描述的信息到栈帧之中, 例如与调试, 性能收集相关的信息, 这部分信息完全取决于具体的虚拟机实现, 这里不再详述。</p>
<h2 id="7-参考"><a href="#7-参考" class="headerlink" title="7 参考"></a>7 参考</h2><p>《深入理解Java虚拟机》- 周志明</p>

                
            </div>
            <hr/>
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/article/2021/4024797796/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/10.jpg" class="responsive-img" alt="Java JVM 编译和优化">
                        
                        <span class="card-title">Java JVM 编译和优化</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-03-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Lcn29
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                    <a href="/tags/JVM/">
                        <span class="chip bg-color">JVM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/article/2021/1618578639/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/21.jpg" class="responsive-img" alt="Java JVM Class 文件的加载">
                        
                        <span class="card-title">Java JVM Class 文件的加载</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-03-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Lcn29
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                    <a href="/tags/JVM/">
                        <span class="chip bg-color">JVM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <br/>

            Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            &nbsp; | &nbsp;&nbsp;Theme <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>

            
            <br>
            
            
                <span id="busuanzi_container_site_pv">
                    总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
            
            
                <span id="busuanzi_container_site_uv">
                    &nbsp; | &nbsp;&nbsp;总访问人数:&nbsp; <span id="busuanzi_value_site_uv" class="white-color"></span>
                </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
