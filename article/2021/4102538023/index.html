<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Redis AOF 源码, Lcn29">
    <meta name="description" content="在上篇, 我们已经从使用 &amp;#x2F; 机制 &amp;#x2F; AOF 过程中涉及的辅助功能等方面简单了解了 Redis AOF。这篇将从源码的形式, 进行深入的了解。
1 Redis 整个 AOF 主要功能Redis 的 AOF 功能概括起来">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Redis AOF 源码 | Lcn29</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Lcn29" type="application/atom+xml">
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.svg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">Lcn29</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友链</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.svg" class="logo-img circle responsive-img">
        
        <div class="logo-name">Lcn29</div>
        <div class="logo-desc">
            
            Technical System
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友链
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/lcn29" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #121317;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/lcn29" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/22.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Redis AOF 源码</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Redis/">
                                <span class="chip bg-color">Redis</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-12-20
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2024-10-10
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    13.6k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    55 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>在上篇, 我们已经从使用 &#x2F; 机制 &#x2F; AOF 过程中涉及的辅助功能等方面简单了解了 Redis AOF。<br>这篇将从源码的形式, 进行深入的了解。</p>
<h2 id="1-Redis-整个-AOF-主要功能"><a href="#1-Redis-整个-AOF-主要功能" class="headerlink" title="1 Redis 整个 AOF 主要功能"></a>1 Redis 整个 AOF 主要功能</h2><p>Redis 的 AOF 功能概括起来就 2 个功能</p>
<blockquote>
<ol>
<li>AOF 同步: 将客户端发送的变更命令, 保存到 AOF 文件中</li>
<li>AOF 重写: 随着 Redis 的运行, AOF 文件会不断变大, 在文件达到配置的条件时, 触发重写机制, 缩小文件的大小</li>
</ol>
</blockquote>
<h2 id="2-AOF-同步-将变更命令写入到文件"><a href="#2-AOF-同步-将变更命令写入到文件" class="headerlink" title="2 AOF 同步 - 将变更命令写入到文件"></a>2 AOF 同步 - 将变更命令写入到文件</h2><p><img src="https://pic.imgdb.cn/item/65a3caec871b83018a0217d0.png" alt="Alt &#39;AOF 同步过程&#39;"></p>
<p>如图 Redis AOF 同步过程</p>
<blockquote>
<ol>
<li>Redis 收到客户端发送的变更命令, 执行这个命令, 其间会修改在内存中数据库的数据</li>
<li>Redis 将这个变更命令同步到一个 <strong>AOF 缓冲区</strong></li>
<li>Redis 将 <strong>AOF 缓冲区</strong>中的数据同步到 AOF 文件中</li>
</ol>
</blockquote>
<p>整个 AOF 同步过程, 我们拆成 2 个部分进行分析</p>
<blockquote>
<ol>
<li>命令写入 AOF 缓冲区</li>
<li>AOF 缓冲区写入 AOF 文件</li>
</ol>
</blockquote>
<h3 id="2-1-变更命令写入-AOF-缓冲区"><a href="#2-1-变更命令写入-AOF-缓冲区" class="headerlink" title="2.1 变更命令写入 AOF 缓冲区"></a>2.1 变更命令写入 AOF 缓冲区</h3><h4 id="2-1-1-前置知识梳理"><a href="#2-1-1-前置知识梳理" class="headerlink" title="2.1.1 前置知识梳理"></a>2.1.1 前置知识梳理</h4><p>在 AOF 同步过程中, 在客户端的变更命令和 AOF 文件中, 有一个 <strong>AOF 缓冲区</strong>的存在。<br>主要作用是在 AOF 过程中, 可以缓冲客户端发送的命令, 后面可以将这些命令一次性多条写入到 AOF 文件中。</p>
<p>其本身的定义很简单, 就是一个字符串, 也就是 sds。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 很简单就是一个字符串, 后面的命令追加到这个字符串的后面</span>
    sds aof_buf<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span></code></pre>

<p>客户端发送的变更命令转为 RESP 协议格式的字符串, 然后追加到已有的字符串后面即可, 这样就形成了一个命令的缓冲区。</p>
<h4 id="2-1-2-逻辑触发入口"><a href="#2-1-2-逻辑触发入口" class="headerlink" title="2.1.2 逻辑触发入口"></a>2.1.2 逻辑触发入口</h4><p>在 AOF 开启过程中, 客户端的命令会在执行完成后, 再保存一份到 <strong>AOF 缓冲区</strong>, 这个保存的入口就是在 Redis 执行所有命令的 call 函数中。<br>可以简单理解为, Redis 接收到了客户端的命令后, 就会调用 call 函数, call 函数里面会在<strong>命令执行前</strong>做一些处理, 然后执行命令, 最后在<strong>命令执行后</strong>再做一些处理。</p>
<pre class="language-c" data-language="c"><code class="language-c">
call 函数的逻辑如下<span class="token operator">:</span> 
```c
<span class="token comment">/**
 * Redis 命令执行过程
 * @param c 客户端
 * @param flags 一个标识, 通过二进制的形式封装了很多功能的标识, 比如当前命令是否需要 AOF 传播, 是否需要记录日志等
 */</span>
<span class="token keyword">void</span> <span class="token function">call</span><span class="token punctuation">(</span>client <span class="token operator">*</span>c<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 省略</span>

    <span class="token comment">// 执行对应的客户端命令</span>
    c<span class="token operator">-></span>cmd<span class="token operator">-></span><span class="token function">proc</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 省略</span>

    <span class="token comment">// 入参的 flags 设置了 CMD_CALL_PROPAGATE 标识, 表示当前的命令需要传播</span>
    <span class="token comment">// 同时对应的客户端内部的标识不是 CLIENT_PREVENT_PROP (客户端的命令阻止传播)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> CMD_CALL_PROPAGATE <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c<span class="token operator">-></span>flags <span class="token operator">&amp;</span> CLIENT_PREVENT_PROP<span class="token punctuation">)</span> <span class="token operator">!=</span> CLIENT_PREVENT_PROP<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 省略</span>

        <span class="token comment">// 命令传播标识, 默认为 none, 即什么都不做</span>
        <span class="token keyword">int</span> propagate_flags <span class="token operator">=</span> PROPAGATE_NONE<span class="token punctuation">;</span>
        
        <span class="token comment">// 命令导致数据脏了, 也就是修改了数据, 需要 aof 和 repl 传播 (repl 也就是主从复制, 同步给从节点)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dirty<span class="token punctuation">)</span> 
            <span class="token comment">// 修改命令传播标识为需要 AOF 和 repl 传播</span>
            propagate_flags <span class="token operator">|=</span> <span class="token punctuation">(</span>PROPAGATE_AOF<span class="token operator">|</span>PROPAGATE_REPL<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token comment">// 当前的客户端设置了需要强制同步传播, 更新命令传播标识为需要 repl 传播</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-></span>flags <span class="token operator">&amp;</span> CLIENT_FORCE_REPL<span class="token punctuation">)</span> 
            propagate_flags <span class="token operator">|=</span> PROPAGATE_REPL<span class="token punctuation">;</span>   
            
        <span class="token comment">// 当前的客户端设置了需要强制 AOF 传播, 更新命令传播标识为需要 AOF 传播</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-></span>flags <span class="token operator">&amp;</span> CLIENT_FORCE_AOF<span class="token punctuation">)</span> 
            propagate_flags <span class="token operator">|=</span> PROPAGATE_AOF<span class="token punctuation">;</span>   
        
        <span class="token comment">// CLIENT_PREVENT_REPL_PROP  这个标识表示当前的客户端的命令不需要 repl 传播          </span>
        <span class="token comment">// 命令的执行过程 (上面的 proc 函数就是调用各个命令各自的执行逻辑), 内部可以通过 preventCommandPropagation() 等函数</span>
        <span class="token comment">// 给当前的客户端的 flags 设置 CLIENT_PREVENT_REPL_PROP 等标识, 也就是不需要主从复制的标识</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-></span>flags <span class="token operator">&amp;</span> CLIENT_PREVENT_REPL_PROP <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> CMD_CALL_PROPAGATE_REPL<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 取消 命令传播标识 中的命令复制传播标识    </span>
            propagate_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>PROPAGATE_REPL<span class="token punctuation">;</span>     

        <span class="token comment">// 同上一步的取消主从复制传播标识</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token operator">-></span>flags <span class="token operator">&amp;</span> CLIENT_PREVENT_AOF_PROP <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> CMD_CALL_PROPAGATE_AOF<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 取消 命令传播标识 中的 AOF 保存标识    </span>
            propagate_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>PROPAGATE_AOF<span class="token punctuation">;</span>  
            
        <span class="token comment">//  命令传播标识 不为 none, 且当前的命令不是模块命令</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>propagate_flags <span class="token operator">!=</span> PROPAGATE_NONE <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>c<span class="token operator">-></span>cmd<span class="token operator">-></span>flags <span class="token operator">&amp;</span> CMD_MODULE<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token comment">// 调用 propagate 进行命令的传播</span>
            <span class="token function">propagate</span><span class="token punctuation">(</span>c<span class="token operator">-></span>cmd<span class="token punctuation">,</span>c<span class="token operator">-></span>db<span class="token operator">-></span>id<span class="token punctuation">,</span>c<span class="token operator">-></span>argv<span class="token punctuation">,</span>c<span class="token operator">-></span>argc<span class="token punctuation">,</span>propagate_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * Redis 命令传播
 * @param cmd Redis 命令
 * @param dbid Redis 命令执行的数据库号
 * @param argv Redis 命令的参数
 * @param argc Redis 命令的参数个数
 * @param flags 命令标识
 */</span>
<span class="token keyword">void</span> <span class="token function">propagate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> <span class="token operator">*</span>cmd<span class="token punctuation">,</span> <span class="token keyword">int</span> dbid<span class="token punctuation">,</span> robj <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// AOF 开启了, 同时命令传播标识为 需要 AOF 传播</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_state <span class="token operator">!=</span> AOF_OFF <span class="token operator">&amp;&amp;</span> flags <span class="token operator">&amp;</span> PROPAGATE_AOF<span class="token punctuation">)</span>
        <span class="token comment">// 将当前的命令保存到 AOF 缓冲区</span>
        <span class="token function">feedAppendOnlyFile</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span>dbid<span class="token punctuation">,</span>argv<span class="token punctuation">,</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 命令传播标识为 需要 repl 传播  </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> PROPAGATE_REPL<span class="token punctuation">)</span>
        <span class="token comment">// 将当前的没拿过来同步给从节点</span>
        <span class="token function">replicationFeedSlaves</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>slaves<span class="token punctuation">,</span>dbid<span class="token punctuation">,</span>argv<span class="token punctuation">,</span>argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>上面就是<strong>命令写入 AOF 缓冲区</strong>的触发入口, 而真正的<strong>命令写入 AOF 缓冲区</strong> 的过程的话就是 feedAppendOnlyFile 函数了。</p>
<h4 id="2-1-3-具体的实现逻辑"><a href="#2-1-3-具体的实现逻辑" class="headerlink" title="2.1.3 具体的实现逻辑"></a>2.1.3 具体的实现逻辑</h4><p>feedAppendOnlyFile 函数的定义如下</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * 命令写入 AOF 缓冲区
 *
 * @param cmd Redis 命令
 * @param dictid Redis 命令执行的数据库号
 * @param argv Redis 命令的参数
 * @param argc Redis 命令的参数个数
 */</span>
<span class="token keyword">void</span> <span class="token function">feedAppendOnlyFile</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> <span class="token operator">*</span>cmd<span class="token punctuation">,</span> <span class="token keyword">int</span> dictid<span class="token punctuation">,</span> robj <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 缓存字符串, 用于临时存放命令的文本</span>
    sds buf <span class="token operator">=</span> <span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    robj <span class="token operator">*</span>tmpargv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 命令写入的数据库和当前 AOF 选中的数据库不是配置的, 手动加入一段, select 对应的数据库</span>
    <span class="token comment">// 后面通过 AOF 文件恢复数据, 才能恢复到正确的数据库中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dictid <span class="token operator">!=</span> server<span class="token punctuation">.</span>aof_selected_db<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
        <span class="token keyword">char</span> seldb<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 将当前命令选中的数据库号数 (0, 1, 2, 3) 写入到字符数组 seldb 中</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>seldb<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>seldb<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"%d"</span><span class="token punctuation">,</span>dictid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 拼接出一个 select 数据库号 的语句, 这个语句是遵守 RESP 协议 </span>
        buf <span class="token operator">=</span> <span class="token function">sdscatprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"*2\r\n$6\r\nSELECT\r\n$%lu\r\n%s\r\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token function">strlen</span><span class="token punctuation">(</span>seldb<span class="token punctuation">)</span><span class="token punctuation">,</span>seldb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 修改 aof 当前的选中的数据库号数</span>
        server<span class="token punctuation">.</span>aof_selected_db <span class="token operator">=</span> dictid<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

        <span class="token comment">// expire / pexpire / expireat 这三个命令, 在 AOF 保存的时候, 会转为 expireat key 具体的过期时间 (单位毫秒) 的格式存入到 AOF 文件中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd<span class="token operator">-></span>proc <span class="token operator">==</span> expireCommand <span class="token operator">||</span> cmd<span class="token operator">-></span>proc <span class="token operator">==</span> pexpireCommand <span class="token operator">||</span> cmd<span class="token operator">-></span>proc <span class="token operator">==</span> expireatCommand<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
        <span class="token comment">// 转为过期对应的文本, 同时追加到 buf 中</span>
        buf <span class="token operator">=</span> <span class="token function">catAppendOnlyExpireAtCommand</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>cmd<span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd<span class="token operator">-></span>proc <span class="token operator">==</span> setexCommand <span class="token operator">||</span> cmd<span class="token operator">-></span>proc <span class="token operator">==</span> psetexCommand<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
        <span class="token comment">// setnx / psetex 2 个命令拆分为 set 和 expireat 2 个命令进行处理</span>
        tmpargv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createStringObject</span><span class="token punctuation">(</span><span class="token string">"SET"</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tmpargv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        tmpargv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 往 buf 中追加 set 命令</span>
        buf <span class="token operator">=</span> <span class="token function">catAppendOnlyGenericCommand</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>tmpargv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 创建的对象手动修改引用计数, 便于内存回收</span>
        <span class="token function">decrRefCount</span><span class="token punctuation">(</span>tmpargv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 往 buf 中追加 expireat 命令, 同理会转弯为 expireat key 具体的过期时间 (单位毫秒) 的格式</span>
        buf <span class="token operator">=</span> <span class="token function">catAppendOnlyExpireAtCommand</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>cmd<span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmd<span class="token operator">-></span>proc <span class="token operator">==</span> setCommand <span class="token operator">&amp;&amp;</span> argc <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// set 命令同时参数大于 3 个, 也就是带有超时时间了</span>

        <span class="token keyword">int</span> i<span class="token punctuation">;</span>
        robj <span class="token operator">*</span>exarg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span>pxarg <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 同样是, 先写入 set 命令</span>
        buf <span class="token operator">=</span> <span class="token function">catAppendOnlyGenericCommand</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 计算后面的超时时间</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>ptr<span class="token punctuation">,</span> <span class="token string">"ex"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> exarg <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcasecmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-></span>ptr<span class="token punctuation">,</span> <span class="token string">"px"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> pxarg <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">serverAssert</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>exarg <span class="token operator">&amp;&amp;</span> pxarg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据计算出来的超时时间, 转为 RESP 协议的文本</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>exarg<span class="token punctuation">)</span>
            buf <span class="token operator">=</span> <span class="token function">catAppendOnlyExpireAtCommand</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>server<span class="token punctuation">.</span>expireCommand<span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> exarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pxarg<span class="token punctuation">)</span>
            buf <span class="token operator">=</span> <span class="token function">catAppendOnlyExpireAtCommand</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>server<span class="token punctuation">.</span>pexpireCommand<span class="token punctuation">,</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pxarg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        
        <span class="token comment">// 其他的命令直接转为 RESP 协议的字符串进行追加</span>
        buf <span class="token operator">=</span> <span class="token function">catAppendOnlyGenericCommand</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>argc<span class="token punctuation">,</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 如果 AOF 功能开启中, 则将命令追加到 AOF 缓冲区中</span>
    <span class="token comment">// 后续在进入事件循环之前，这些命令会被保存到磁盘上，并向给对应的 client 回复执行结果</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_state <span class="token operator">==</span> AOF_ON<span class="token punctuation">)</span>
        <span class="token comment">// 3 个缓冲区中的一个, AOF 缓冲区, 保存变更的 Redis 命令</span>
        server<span class="token punctuation">.</span>aof_buf <span class="token operator">=</span> <span class="token function">sdscatlen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token comment">// 如果后台正在进行重写，那么将命令再追加一份到重写缓冲区中，以便我们记录重写时 AOF 文件和当前数据库的差异</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">// 这里不展开, 后面聊</span>
        <span class="token function">aofRewriteBufferAppend</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">&#125;</span></code></pre>

<p>变更命令到 <strong>AOF 命令缓冲区</strong>的过程到这里结束了, 接下来就是 AOF 缓冲区到 AOF 文件的过程了。</p>
<h3 id="2-2-AOF-缓冲区写入-AOF-文件"><a href="#2-2-AOF-缓冲区写入-AOF-文件" class="headerlink" title="2.2 AOF 缓冲区写入 AOF 文件"></a>2.2 AOF 缓冲区写入 AOF 文件</h3><h4 id="2-2-1-前置知识梳理"><a href="#2-2-1-前置知识梳理" class="headerlink" title="2.2.1 前置知识梳理"></a>2.2.1 前置知识梳理</h4><p><strong>1. write + fsync 函数</strong>  </p>
<p>在操作系统中, 将应用的内存数据保存到真正的磁盘文件中, 实际需要通过 2 个函数</p>
<blockquote>
<ol>
<li>write 函数, 将缓冲区中的数据写入到<strong>系统缓冲</strong>中, 一般是达到一定数量或者时间, 才会真正的写入到磁盘中, 单独的通过 write 函数, 无法 100% 保证数据的完整性</li>
<li>fsync 函数, 一个比较耗时的操作, 可以立刻将<strong>系统缓冲</strong>中的数据写入到磁盘中</li>
</ol>
</blockquote>
<p><strong>2. Redis 线程池 RIO</strong></p>
<p>因为 fsync 函数比较耗时, 所以 Redis 维护了一个线程池 (Redis 内部叫做 BIO), 用来处理一些比较耗时的操作。<br>现在 Redis 这个线程池只处理 3 种任务类型</p>
<blockquote>
<ol>
<li>close 函数, 也就是关闭文件</li>
<li>fsync 函数, 立即刷新系统缓冲到磁盘</li>
<li>Redis 内部的延长删除无用内存</li>
</ol>
</blockquote>
<p>所以在 AOF 缓存区写入到 AOF 文件中, 会先通过 write 将里面的数据写入到<strong>系统缓冲</strong>,<br>然后根据当前的 AOF 保存策略, 决定是否需要执行 fsync 函数和 fsync 的执行能否交给线程池。</p>
<p><strong>3. AOF 文件同步策略</strong><br>将 AOF 缓冲区中的数据写入到 AOF 文件, Redis 提供了 3 种策略</p>
<blockquote>
<ol>
<li>no: 不进行同步, 由操作系统自己决定, 也就是只执行 write 函数</li>
<li>always: 每次 write 后, 都立即执行 fsync</li>
<li>everysec: 每次 write 后, 不会立即执行 fsync, 理论是每秒执行一次 fsync, 同时内部会将 fysnc 的执行交由线程池执行</li>
</ol>
</blockquote>
<p><strong>4. everysec 的特殊性</strong><br>同步策略为 everysec 时, 为了性能, fsync 函数的执行不是由 Redis 的主线程处理的, 而是通过向线程池提交一个 fsync 的任务, 由后台线程池执行。<br>那么就存在一种特殊情况</p>
<blockquote>
<ol>
<li>主线程在 flushAppendOnlyFile (AOF 缓存区写入到文件的函数) 完了 write, 提交了一个任务到后台线程, 假设此时的数据量很大, fsync 需要执行很长时间</li>
<li>主线程又执行到了 flushAppendOnlyFile 了, 而上一次的 fsync 函数还没执行完, Redis 会选择<strong>延迟执行</strong>, 将一个变量 aof_flush_postponed_start 设置为当前时间, 结束</li>
<li>后面主线程执行到定时任务时, 会判断这个变量是否大于 0, 是的话, 会再次执行 flushAppendOnlyFile, 也就是这次 AOF 同步延迟到定时处进行执行</li>
<li>但是延迟到定时任务处触发, 还是无法保证后台线程一定执行完了 fsync 了, 所以 flushAppendOnlyFile, 会根据当前的时间和变量里面存储的时间进行比较, 还是在 2 秒内, 不做任何处理, 而大于 2 秒, 立即执行 AOF 缓冲区写入文件的逻辑</li>
</ol>
</blockquote>
<p>理解了上面 3 个点, 下面 AOF 缓冲区的数据写入到 AOF 文件的过程就简单很多了。</p>
<h4 id="2-2-2-逻辑触发入口"><a href="#2-2-2-逻辑触发入口" class="headerlink" title="2.2.2 逻辑触发入口"></a>2.2.2 逻辑触发入口</h4><p>将缓冲区中的数据写入到文件的函数为 <strong>flushAppendOnlyFile</strong>, 而在 Redis 中会触发这个函数的有 5 个地方</p>
<blockquote>
<ol>
<li>通过命令动态地关闭 AOF 功能时, 会进行一次保存, 即动态的将 appendonly yes 设置为 appendonly no</li>
<li>Redis 服务器正常关闭之前, 会执行一次</li>
<li>在 AE 事件循环中配置的 beforesleep 函数中就会调用一次, 这个是 AOF 功能的主要的保存入口</li>
<li>Redis 的定时器函数 serverCron  (默认为 100 毫秒执行一次), 会判断上次执行的 flushAppendOnlyFile 是不是延迟执行, 是会调一次 (这个延迟的行为, 在 flushAppendOnlyFile 中有分析)</li>
<li>最后一个就是定时器函数 serverCron (默认为 1000 毫秒执行一次), 判断上次 AOF 写入状态, 失败就执行一次</li>
</ol>
</blockquote>
<p>后面 2 种都是在 serverCron 中, 代码如下</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">serverCron</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">aeEventLoop</span> <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 省略</span>

    <span class="token comment">// 上次的 AOF 写文件时, 没有执行, 而是将 aof_flush_postponed_start 设置为 true, 表示需要延迟处理, 则在这里进行判断出来 </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_flush_postponed_start<span class="token punctuation">)</span> 
        <span class="token function">flushAppendOnlyFile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">run_with_period</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 上次的写文件失败了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_last_write_status <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span>
            <span class="token function">flushAppendOnlyFile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 省略</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="2-2-3-具体的实现逻辑"><a href="#2-2-3-具体的实现逻辑" class="headerlink" title="2.2.3 具体的实现逻辑"></a>2.2.3 具体的实现逻辑</h4><p>整个 AOF 缓冲区的数据写入到 AOF 文件的实现函数就是 flushAppendOnlyFile, 定义如下</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * AOF 缓冲区数据写入文件
 *
 * 当持久策略被设置为 everysec, 实际上会由后台线程进行处理, 那么当前这次刷新写入时, 后台可能有线程还在写入, 所以这时的操作会延迟写入
 * 
 * @param force 1：表示无视后台的 fsync, 直接写入, 0: 表示可以延迟, 一般 AOF 过程都是 0
 */</span>
<span class="token keyword">void</span> <span class="token function">flushAppendOnlyFile</span><span class="token punctuation">(</span><span class="token keyword">int</span> force<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">ssize_t</span> nwritten<span class="token punctuation">;</span>
    <span class="token keyword">int</span> sync_in_progress <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">mstime_t</span> latency<span class="token punctuation">;</span>

    <span class="token comment">// 缓冲区没有数据, 正常缓冲区没有数据, 就可以结束了</span>
    <span class="token comment">// 但是 Redis 在里面对一个极端情况的兼容, 有点绕, 有兴趣可以了解一下, 也可以跳过</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sdslen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token comment">// 即使在缓冲区数据为空的情况下, 也需要检查一次是否需要执行 fsync 操作 (fsync: 将缓冲区数据写回磁盘)</span>
        <span class="token comment">// 因为在 everysec 模式下, fsync 仅在 AOF 缓冲区不为空时调用</span>
        <span class="token comment">// 如果在一秒钟调用一次的 fsync 之前, 用户停止了写命令 (stop write commands, 也就是没有发送任何变更的命令), 将会导致缓冲中的数据无法及时刷新</span>
        <span class="token comment">// 这种情况的分析, 个人的猜测在后面的备注中进行分析</span>

        <span class="token comment">// 1. 配置的持久化策略为 everysec 每秒执行一次 fsync </span>
        <span class="token comment">// 2. 已经同步到磁盘的内容大小 != 当前 AOF 文件的内容大小</span>
        <span class="token comment">// 3. 当前的时间 > 上次 AOF fsync 的时间</span>
        <span class="token comment">// 4. 当前没有请求 fsync 的任务在线程池中</span>
        <span class="token comment">// 4 个条件都符合, 尝试进行 fsync, 否则直接返回</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fsync <span class="token operator">==</span> AOF_FSYNC_EVERYSEC <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>aof_fsync_offset <span class="token operator">!=</span> server<span class="token punctuation">.</span>aof_current_size 
            <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>unixtime <span class="token operator">></span> server<span class="token punctuation">.</span>aof_last_fsync <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>sync_in_progress <span class="token operator">=</span> <span class="token function">aofFsyncInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">goto</span> try_fsync<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 持久策略为每秒 fsync 一次, 判断后台的线程池是否有线程在执行 fsync </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fsync <span class="token operator">==</span> AOF_FSYNC_EVERYSEC<span class="token punctuation">)</span>
        <span class="token comment">// aofFsyncInProgress 返回值为 true, 表示当前有 BIO 线程在执行 fsync </span>
        sync_in_progress <span class="token operator">=</span> <span class="token function">aofFsyncInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 持久策略为每秒 fsync 一次, 同时不需要强制写入文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fsync <span class="token operator">==</span> AOF_FSYNC_EVERYSEC <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>force<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    

        <span class="token comment">// 当前有 BIO 线程在执行 fsync</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_in_progress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
            <span class="token comment">// 0 表示当前没有延迟执行</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_flush_postponed_start <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

                <span class="token comment">// 当前有后台线程在执行 fsync, 那么先延长一下, 设置 aof_flush_postponed_start 为当前时间， 然后结束, 后面定时器执行到了, 判断这个值大于 0, </span>
                <span class="token comment">// 重新进入 flushAppendOnlyFile 函数进行 AOF 缓冲区保存, 也就是延迟执行</span>
                server<span class="token punctuation">.</span>aof_flush_postponed_start <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 如果之前有设置延迟执行, 然后又进入到这个函数(大部分场景是定时器触发), 此次后台还是有线程在执行 fsync,</span>
            <span class="token comment">// 但是当前时间和上一次设置的延迟时间小于 2 秒, 可以接受, 暂时还是不做任何处理</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>unixtime <span class="token operator">-</span> server<span class="token punctuation">.</span>aof_flush_postponed_start <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 直接返回</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> 
            
            <span class="token comment">// 上面的情况分析</span>
            <span class="token comment">// 第一次执行完 flushAppendOnlyFile 后, 但是数据量很大, 导致 fsync 很耗时, </span>
            <span class="token comment">// 那么第二次 flushAppendOnlyFile 极端情况需要在 2 秒后才会进行</span>

            <span class="token comment">// 延迟 fsync 的次数 + 1</span>
            <span class="token comment">// 到了这一步表示线程池中有请求 fsync 的任务, 同时上次延迟距离当前时间超过 2 秒了</span>
            server<span class="token punctuation">.</span>aof_delayed_fsync<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token comment">// 记录日志</span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"Asynchronous AOF fsync is taking too long (disk is busy?). Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> 
    <span class="token punctuation">&#125;</span>        
  
    <span class="token comment">// 下面的 latency 开头的函数基本都是延迟统计相关的, 不影响具体的逻辑, 可以跳过</span>
    <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 步骤 BB, 后面备注分析在缓存区没有数据还需要执行 fsync 用到</span>

    <span class="token comment">// 调用 write 函数将缓冲区中的数据写入到文件 (此时还在系统级缓存, 还没写入到磁盘, 可以通过 fsync 强制刷入到磁盘)</span>
    nwritten <span class="token operator">=</span> <span class="token function">aofWrite</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fd<span class="token punctuation">,</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sync_in_progress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"aof-write-pending-fsync"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"aof-write-active-child"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"aof-write-alone"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"aof-write"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 将缓冲区中的数据 write 到系统后, 可以把延迟执行设置为 0</span>
    server<span class="token punctuation">.</span>aof_flush_postponed_start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 写入到系统的数据长度不等于当前 AOF 缓冲区的长度, 进入异常处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nwritten <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">ssize_t</span><span class="token punctuation">)</span><span class="token function">sdslen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">static</span> <span class="token class-name">time_t</span> last_write_error_log <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> can_log <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 上次记录错误日志的时间距离现在 30 秒了, 需要再记录多一次移除日志</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>unixtime <span class="token operator">-</span> last_write_error_log<span class="token punctuation">)</span> <span class="token operator">></span> AOF_WRITE_LOG_ERROR_RATE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            can_log <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            last_write_error_log <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">// -1, 没有写入任何数据, 就直接失败了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nwritten <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 写入失败</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>can_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Error writing to the AOF file: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token comment">// 保存错误到 redisServer 的 aof_last_write_errno</span>
                server<span class="token punctuation">.</span>aof_last_write_errno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        
            <span class="token comment">// 大于 -1 但是不等于缓冲区的大小, 写入成功了一部分, </span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>can_log<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 记录日志</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// 将 AOF 的文件大小修改为 aof_current_size 的大小, 返回值 0 成功, -1 失败</span>
            <span class="token comment">// 也就是恢复回写入前的文件内容</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ftruncate</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fd<span class="token punctuation">,</span> server<span class="token punctuation">.</span>aof_current_size<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 记录日志</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 设置为 -1, 表示 AOF 中没有写入成功的部分数据</span>
                nwritten <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            server<span class="token punctuation">.</span>aof_last_write_errno <span class="token operator">=</span> ENOSPC<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 同步策略为 always</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fsync <span class="token operator">==</span> AOF_FSYNC_ALWAYS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 这种情况无法处理了, 已经告知客户端写入成功了, 但是当前写入失败了, 直接退出程序。</span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Can't recover from AOF write error when the AOF fsync policy is 'always'. Exiting..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        
            <span class="token comment">// 设置上一次写入状态为异常, 在定时器中会判断这个状态, 再次触发 flushAppendOnlyFile </span>
            server<span class="token punctuation">.</span>aof_last_write_status <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>nwritten <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 更新当前 aof 文件的大小 = 当前的大小 + 写入部分的大小, 同时将缓冲区中这部分大小的数据移除</span>
                <span class="token comment">// 表示这部分写入成功了, 剩余部分下次调用继续</span>
                server<span class="token punctuation">.</span>aof_current_size <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
                <span class="token function">sdsrange</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">,</span>nwritten<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 写入成功</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_last_write_status <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 最新最近一次写的状态为 C_OK</span>
            server<span class="token punctuation">.</span>aof_last_write_status <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 更新当前 AOF 文件的大小</span>
    server<span class="token punctuation">.</span>aof_current_size <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>

    <span class="token comment">// 如果当前 AOF 缓冲区足够小，小于 4K，那么重用这个缓存，否则释放 AOF 缓冲区, 然后重新分配一个</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">sdslen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">sdsavail</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4000</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">sdsclear</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">sdsfree</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>aof_buf <span class="token operator">=</span> <span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

try_fsync<span class="token operator">:</span>

    <span class="token comment">// no-appendfsync-on-rewrite (正在重写, 不执行 fsync) 被设置为 yes</span>
    <span class="token comment">// 正在执行 后台保存 RDB  或者 后台保存 AOF, 直接返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_no_fsync_on_rewrite <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
        
    <span class="token comment">// 持久策略为 always </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fsync <span class="token operator">==</span> AOF_FSYNC_ALWAYS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 宏定义, 在 Linux 系统中执行 fdatasync 函数, 其他系统执行 fsync 函数</span>
        <span class="token function">redis_fsync</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fd<span class="token punctuation">)</span><span class="token punctuation">;</span> 

        <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"aof-fsync-always"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新 aof_fsync_offset 为当前的 AOF 文件大小</span>
        server<span class="token punctuation">.</span>aof_fsync_offset <span class="token operator">=</span> server<span class="token punctuation">.</span>aof_current_size<span class="token punctuation">;</span>
        <span class="token comment">// 上次 fsync 为当前的时间</span>
        server<span class="token punctuation">.</span>aof_last_fsync <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fsync <span class="token operator">==</span> AOF_FSYNC_EVERYSEC <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>unixtime <span class="token operator">></span> server<span class="token punctuation">.</span>aof_last_fsync<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 持久策略为 everysec 同时当前的时间大于上次 fsync 的时间</span>

        <span class="token comment">// 步骤 AA, 后面备注分析在缓存区没有数据还需要执行 fsync 用到</span>

        <span class="token comment">// 当前没有请求 fsync 的任务在线程池中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sync_in_progress<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 提交一个任务, 最终就是一个后台线程执行一次 redis_fsync 函数</span>
            <span class="token function">aof_background_fsync</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新 aof_fsync_offset 为当前的页的大小</span>
            server<span class="token punctuation">.</span>aof_fsync_offset <span class="token operator">=</span> server<span class="token punctuation">.</span>aof_current_size<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        server<span class="token punctuation">.</span>aof_last_fsync <span class="token operator">=</span> server<span class="token punctuation">.</span>unixtime<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>    
<span class="token punctuation">&#125;</span>

<span class="token comment">// 返回 true, 如果当前已经有一个请求 fsync 的任务了, 返回 true</span>
<span class="token keyword">int</span> <span class="token function">aofFsyncInProgress</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">bioPendingJobsOfType</span><span class="token punctuation">(</span>BIO_AOF_FSYNC<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Redis 的 BIO 更像是一个线程池, 下面的方法是提交一个任务到对应任务链表</span>
<span class="token comment">// 同时会尝试唤醒线程池对应的线程去执行任务, 具体的实现可以看一下 bio.c 这个文件</span>
<span class="token keyword">void</span> <span class="token function">aof_background_fsync</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">bioCreateBackgroundJob</span><span class="token punctuation">(</span>BIO_AOF_FSYNC<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>fd<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 调用 write 函数, 写入数据到文件</span>
<span class="token class-name">ssize_t</span> <span class="token function">aofWrite</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">ssize_t</span> nwritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> totwritten <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 调用 write 函数将 server.aof_buf 中的数据写入到系统级缓存中</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        nwritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nwritten <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token keyword">return</span> totwritten <span class="token operator">?</span> totwritten <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        len <span class="token operator">-=</span> nwritten<span class="token punctuation">;</span>
        buf <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
        totwritten <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 写入的内容大小</span>
    <span class="token keyword">return</span> totwritten<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>上面就是一个将 AOF 缓冲区中的数据写入到系统的过程, 一个<strong>正常</strong>的流程如下：</p>
<blockquote>
<ol>
<li>如果当前同步策略是每秒 fsync, 同时有 BIO 线程在后台处理 fsync 了, 设置 redisServer 的延迟 AOF 时间 aof_flush_postponed_start 为当前时间, 等待下次执行, 结束</li>
<li>调用 write 把 AOF 缓冲区的数据写入到系统级缓存中</li>
<li>获取写入到系统级缓存的数据长度</li>
<li>写入到系统级缓存的数据长度不等于 AOF 缓冲区的数据长度, 进行异常处理, 结束</li>
<li>长度一样, 更新 redisServer 的最新 AOF 写入状态 aof_last_write_status 为成功状态</li>
<li>更新当前 AOF 文件的大小 aof_current_size 为 aof_current_size + 最新写入的数据长度</li>
<li>清空 AOF 缓冲区的数据</li>
<li>如果配置的持久策略为 always, 立即执行 fsync</li>
<li>如果配置的持久策略为 everysec, 当前的时间大于上次 fsync 的时间, 同时线程池中没有 fsync 任务, 提交一个到线程池, 更新当前的 fsync 写入量的 aof_fsync_offset 为当前的 AOF 文件大小</li>
<li>更新最新的 AOF fsync 时间为当前时间</li>
</ol>
</blockquote>
<p>备注:<br>在上面的代码中, 在 AOF 缓冲区没有数据的情况下, 还会进行条件的判断后, 尝试进行 fsync 的操作, 需要进行这种情况的情景, 个人猜测如下</p>
<blockquote>
<ol>
<li>第一次走入这个方法, sync_in_progress 为 false, 走到下面的步骤 AA, 开启了一个后台 BIO 线程进行 fsync, 假设当前的 aof_fsync_offset &#x3D; aof_current_size &#x3D; xx</li>
<li>第二次走入到这个方法, sync_in_progress 为 true, 走到步骤 BB 时, 后台的 BIO 线程已经完成任务, 结束了, 所以这时候 sync_in_progress 理论应该为 false 了, 但是此时还是为 true</li>
<li>第二次同样走到了下面的步骤 AA, 这是 aof_current_size 已经是追加到了最新的大小了, 设为 yy, 因为 sync_in_progress 为 true, aof_fsync_offset 还是 xx, 最新的数据已经 write 到系统级缓存了, 但是没有 fsync</li>
<li>如果这时候用户没有在向 Redis 中进行更改命令, AOF 缓冲区就会一直为空, 无论走几次到这个方法, 都不会走到下面的逻辑, 这时候就存在 AOF 文件中的数据和真正的数据有偏差</li>
<li>所以在 AOF 缓冲区为空的情况下, 还要进行多一次判断, 进行 fsync</li>
</ol>
</blockquote>
<h2 id="3-AOF-重写-AOF-文件瘦身"><a href="#3-AOF-重写-AOF-文件瘦身" class="headerlink" title="3 AOF 重写 - AOF 文件瘦身"></a>3 AOF 重写 - AOF 文件瘦身</h2><p>整个 AOF 重写过程, 会稍微复杂一些, 因为涉及到 2 个进程。</p>
<p><img src="https://pic.imgdb.cn/item/65a3caf0871b83018a022af8.png" alt="Alt &#39;AOF 重写过程&#39;"></p>
<p>如图是整个 AOF 重写过程</p>
<p>当 Redis 服务端发现整个 AOF 文件达到配置的重写条件了</p>
<blockquote>
<ol>
<li>立即创建出 6 个 Pipe 通道 (这些通道主要用于父子进程的通信)</li>
<li>父进程通过 fork 操作, 创建出子进程 (fork 可以理解为克隆, 此时子进程和父进程完全一样, 拥有父进程所有数据的快照), 由子进程会执行 AOF 重写的过程</li>
</ol>
</blockquote>
<p>fork 操作后, 父进程将继续运行</p>
<blockquote>
<ol>
<li>在收到客户端的变更命令后, 处理完同步到内存数据库中, 写入到 <strong>AOF 缓冲区</strong>, 此时还会写入一份到 <strong>AOF 重写缓冲区</strong>中</li>
<li>后面不断将 <strong>AOF 重写缓冲区</strong>中的数据通过 Pipe 通道同步给子进程</li>
</ol>
</blockquote>
<p>备注: 在子进程重写的这段过程, 命令还是会写入到 AOF 缓冲区中, 并同步写入 AOF 文件中</p>
<p>fork 出来的子进程, 此时不会有任何的数据变更了</p>
<blockquote>
<ol start="3">
<li>根据自身<strong>内存数据库</strong>, 将里面的数据写入到一个新的 AOF 临时文件</li>
<li>在将内存数据写入到 AOF 临时文件中, 会按照每写入 10m 数据到文件时, 就通过 Pipe 将父进程同步过来的差异命令保存到自身的 <strong>AOF 子进程差异缓冲区</strong>中</li>
<li>当内存数据库中的数据全部写入到 AOF 临时文件后, 通过 Pipe 向父级发送一个 !, 通知父进程停止同步差异命令</li>
<li>父进程收到子进程发送过来的 !, 会停止向子进程同步差异命令, 并通过 Pipe 发送一个 !, 进行响应</li>
<li>子进程收到父进程发送过来的 ! 后, 会将自身的 <strong>AOF 子进程差异缓冲区</strong> 中的数据写入到 AOF 临时文件中</li>
</ol>
</blockquote>
<p>备注: 此时子进程任务完成 </p>
<p>父进程运行过程中, 会不断检查 AOF 子进程的状态</p>
<blockquote>
<ol start="8">
<li>当发现子进程已经停止了, 父进程进行将 <strong>AOF 重写缓冲区</strong>中的省略的数据写入到 AOF 临时文件中</li>
<li>写入完成后, 将 AOF 临时文件替换掉旧的 AOF 文件, AOF 重写过程完成, 后面收到的 Redis 命令, 会写入到新的 AOF 文件中</li>
</ol>
</blockquote>
<p>至此, 这个 AOF 重写过程就完成了。</p>
<p>将上面的过程, 再概括一下就是</p>
<blockquote>
<ol>
<li>fork 出来的子进程, 拥有了和父进程一样的内存数据, 子进程先把这些内存数据写入到一个 AOF 临时文件</li>
<li>父进程在子进程同步内存数据到文件的过程中, 还在处理客户端请求, 将这段时间的变更命令保存下来</li>
<li>子进程内存数据同步到临时文件完成了, 将父进程这段时间保存下来的变更命令拿过来, 继续追加到 AOF 临时文件中</li>
<li>父进程在子进程将变更命令追加到临时文件的过程中, 继续把这段时间的变更命令保存下来</li>
<li>子进程将第一次同步过来的的变更命令追加到 AOF 临时文件后, 完成任务, 结束</li>
<li>父进程在子进程结束后, 自己剩余的变更命令同步到 AOF 临时文件，这个 AOF 临时文件就是完整的数据了</li>
</ol>
</blockquote>
<h3 id="3-1-前置知识梳理"><a href="#3-1-前置知识梳理" class="headerlink" title="3.1 前置知识梳理"></a>3.1 前置知识梳理</h3><h4 id="3-1-1-AOF-重写过程中涉及到的-Pipe-通道"><a href="#3-1-1-AOF-重写过程中涉及到的-Pipe-通道" class="headerlink" title="3.1.1 AOF 重写过程中涉及到的 Pipe 通道"></a>3.1.1 AOF 重写过程中涉及到的 Pipe 通道</h4><p>整个 AOF 重写的过程是需要父子 2 个进程共同合作完成的, 那么这个过程就涉及到通讯, 在 Redis 中, 通讯的方式是通过 Pipe 管道来实现的。<br>从 Redis 对 Pipe 的使用可以得出下面的特点,</p>
<blockquote>
<ol>
<li>Pipe 需要两两配合使用, 比如 A 和 B 2个 Pipe 组成一对, 父进程向 A Pipe 写入数据, 子进程可通过 B Pipe 读取到父进程同步过来的数据</li>
<li>一对 Pipe 组合的数据同步方向是不可逆的, 父进程通过 A Pipe 同步给子进程, 子进程没法反着过来通过 B  Pipe 同步数据给父进程</li>
</ol>
</blockquote>
<p>从上面的流程图中可以看到有 6 个 Pipe, 共 3 组</p>
<blockquote>
<ol>
<li>aof_pipe_write_data_to_child 和 aof_pipe_read_data_from_parent, 主要是父进程将子进程重写过程中产生的变更命令同步给子进程</li>
<li>aof_pipe_write_ack_to_parent 和 aof_pipe_read_ack_from_child, 主要是用于子进程通知父进程停止同步变更命令</li>
<li>aof_pipe_write_ack_to_child 和 aof_pipe_read_ack_from_parent, 主要用于父进程响应子进程的停止同步变更命令的请求</li>
</ol>
</blockquote>
<h4 id="3-1-2-AOF-重写过程涉及到的-2-个缓冲区"><a href="#3-1-2-AOF-重写过程涉及到的-2-个缓冲区" class="headerlink" title="3.1.2 AOF 重写过程涉及到的 2 个缓冲区"></a>3.1.2 AOF 重写过程涉及到的 2 个缓冲区</h4><p><strong>1. AOF 重写缓冲区</strong>  </p>
<p>AOF 重写缓冲区, 主要是在 AOF 重写过程中, 缓冲这段时间修改了内存数据的命令。<br>fork 出来的子进程, 根据自身的内存数据库快照, 生成一个新的 AOF 临时文件后。<br>生成的过程中, 父进程还在处理客户端的命令, 这些命令会导致数据变更, 需要把这些命令追加到 AOF 临时文件, 才是最终完整的数据。<br>而这个缓存区中就是父进程保存子进程重写过程中, 导致数据变更的命令。</p>
<p>那么这个缓冲区是什么样的呢？</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 重写缓存链表, 当前正在进行重写时, 会把命令写入到这个列表, 待重写完成后, 再追加到文件</span>
    list <span class="token operator">*</span>aof_rewrite_buf_blocks<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * AOF 重写缓存列表的节点定义
 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">aofrwblock</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 下面的缓存数组已经使用的空间和剩余的空间</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">,</span> free<span class="token punctuation">;</span>

    <span class="token comment">// 用来缓存需要写入到文件的命令文本内容, 当数组所有空间使用完了, 会新建一个新的缓存节点</span>
    <span class="token comment">// AOF_RW_BUF_BLOCK_SIZE = 1024*1024*10</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span>AOF_RW_BUF_BLOCK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span> aofrwblock<span class="token punctuation">;</span></code></pre>

<p>一个链表, 链表的节点就是一个 10kb 的字节数组, 即每个节点可以存储 10kb 的数据, 写满了就再新建一个节点。</p>
<p>这个缓冲区的作用和写入的时机, 实际在上面的 AOF 重写同步中已经有遇到了, 这里对数据写入的时机和逻辑进行一个代码级别的整理。</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * 在上面 AOF 命令写入缓冲区中, 可以知道, 在执行命令执行后, 会有个命令传播的逻辑, 里面会调用到这个 feedAppendOnlyFile 函数
 * 这个函数会判断当前是否正在进行 AOF 重写, 如果是, 会将命令追加一份到 AOF 重写缓冲区中, 保存子进程重写过程中, 主进程这段时间处理的变更命令
 */</span>
<span class="token keyword">void</span> <span class="token function">feedAppendOnlyFile</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">redisCommand</span> <span class="token operator">*</span>cmd<span class="token punctuation">,</span> <span class="token keyword">int</span> dictid<span class="token punctuation">,</span> robj <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">,</span> <span class="token keyword">int</span> argc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 省略</span>

    <span class="token comment">// 如果后台正在进行重写，那么将命令追加到重写缓冲区中，以便我们记录重写时 AOF 文件和当前数据库的差异</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">// 这里就是将变更命令写入到 AOF 重写缓冲区</span>
        <span class="token function">aofRewriteBufferAppend</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/**
 * @param s: 需要写入的数据
 * @param len: 需要写入的数据长度
 */</span>
<span class="token keyword">void</span> <span class="token function">aofRewriteBufferAppend</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取重写缓冲区列表</span>
    listNode <span class="token operator">*</span>ln <span class="token operator">=</span> <span class="token function">listLast</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_rewrite_buf_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    aofrwblock <span class="token operator">*</span>block <span class="token operator">=</span> ln <span class="token operator">?</span> ln<span class="token operator">-></span>value <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
        <span class="token comment">// 重写缓冲列表已经有数据了</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            
            <span class="token comment">// 当前列表的最后一个节点需要分配多少的长度出来</span>
            <span class="token comment">// 剩余的空间 &lt; 需要的空间 ? 剩余多少分配多少 : 存储内容需要的长度</span>
            <span class="token keyword">unsigned</span> <span class="token keyword">long</span> thislen <span class="token operator">=</span> <span class="token punctuation">(</span>block<span class="token operator">-></span>free <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token operator">?</span> block<span class="token operator">-></span>free <span class="token operator">:</span> len<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>thislen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 当前的节点空间还有剩余的</span>
                <span class="token function">memcpy</span><span class="token punctuation">(</span>block<span class="token operator">-></span>buf<span class="token operator">+</span>block<span class="token operator">-></span>used<span class="token punctuation">,</span> s<span class="token punctuation">,</span> thislen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                block<span class="token operator">-></span>used <span class="token operator">+=</span> thislen<span class="token punctuation">;</span>
                block<span class="token operator">-></span>free <span class="token operator">-=</span> thislen<span class="token punctuation">;</span>
                s <span class="token operator">+=</span> thislen<span class="token punctuation">;</span>
                <span class="token comment">// 计算出还需要多少空间</span>
                len <span class="token operator">-=</span> thislen<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        
        <span class="token comment">// len > 0, 说明还需要空间, 但是当前的节点没有空间了, 需要新建一个节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>len<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 还需要空间</span>

            <span class="token keyword">int</span> numblocks<span class="token punctuation">;</span>
            <span class="token comment">// 分配以新的缓存节点, 同时放到列表的尾部</span>
            block <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            block<span class="token operator">-></span>free <span class="token operator">=</span> AOF_RW_BUF_BLOCK_SIZE<span class="token punctuation">;</span>
            block<span class="token operator">-></span>used <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">listAddNodeTail</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_rewrite_buf_blocks<span class="token punctuation">,</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 获取当前的重写缓存列表的节点长度</span>
            numblocks <span class="token operator">=</span> <span class="token function">listLength</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_rewrite_buf_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 加 1 后是 10 的倍数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>numblocks<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 记录日志</span>
                <span class="token keyword">int</span> level <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>numblocks<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> LL_WARNING <span class="token operator">:</span> LL_NOTICE<span class="token punctuation">;</span>
                <span class="token function">serverLog</span><span class="token punctuation">(</span>level<span class="token punctuation">,</span><span class="token string">"Background AOF buffer size: %lu MB"</span><span class="token punctuation">,</span> <span class="token function">aofRewriteBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// 回到循环的头部, 再来一次循环</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 注册一个文件事件, 用来将缓冲区的数据写入到 aof_pipe_write_data_to_child 中, 然后在 Pipe 的作用下, 可以同步到 aof_pipe_read_data_from_parent</span>
    <span class="token comment">// 只需要注册一个就可以了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeGetFileEvents</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>server<span class="token punctuation">.</span>aof_pipe_write_data_to_child<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">aeCreateFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span> server<span class="token punctuation">.</span>aof_pipe_write_data_to_child<span class="token punctuation">,</span> AE_WRITABLE<span class="token punctuation">,</span> aofChildWriteDiffData<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 把当前的 AOF 缓冲区同步到 aof_pipe_write_data_to_child, 在 Pipe 的作用下间接同步到 aof_pipe_read_data_from_parent</span>
<span class="token keyword">void</span> <span class="token function">aofChildWriteDiffData</span><span class="token punctuation">(</span>aeEventLoop <span class="token operator">*</span>el<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">,</span> <span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    listNode <span class="token operator">*</span>ln<span class="token punctuation">;</span>
    aofrwblock <span class="token operator">*</span>block<span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> nwritten<span class="token punctuation">;</span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>privdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">UNUSED</span><span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
        <span class="token comment">// 获取头节点</span>
        ln <span class="token operator">=</span> <span class="token function">listFirst</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_rewrite_buf_blocks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        block <span class="token operator">=</span> ln <span class="token operator">?</span> ln<span class="token operator">-></span>value <span class="token operator">:</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

        <span class="token comment">// 停止同步或者没有 AOF 缓冲区时, 删除这个事件</span>
        <span class="token comment">// 后续如果停止同步的标识还是 true, 又有缓冲区数据, 在 aofRewriteBufferAppend 会重新新建一个这个事件, 可以重新开始执行</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_stop_sending_diff <span class="token operator">||</span> <span class="token operator">!</span>block<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 删除这个事件</span>
            <span class="token function">aeDeleteFileEvent</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>el<span class="token punctuation">,</span>server<span class="token punctuation">.</span>aof_pipe_write_data_to_child<span class="token punctuation">,</span> AE_WRITABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token operator">-></span>used <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 把 block 的数据写入到 aof_pipe_write_data_to_child</span>
            nwritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_pipe_write_data_to_child<span class="token punctuation">,</span> block<span class="token operator">-></span>buf<span class="token punctuation">,</span> block<span class="token operator">-></span>used<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nwritten <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token function">memmove</span><span class="token punctuation">(</span>block<span class="token operator">-></span>buf<span class="token punctuation">,</span>block<span class="token operator">-></span>buf<span class="token operator">+</span>nwritten<span class="token punctuation">,</span>block<span class="token operator">-></span>used<span class="token operator">-</span>nwritten<span class="token punctuation">)</span><span class="token punctuation">;</span>
            block<span class="token operator">-></span>used <span class="token operator">-=</span> nwritten<span class="token punctuation">;</span>
            block<span class="token operator">-></span>free <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token operator">-></span>used <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
            <span class="token function">listDelNode</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_rewrite_buf_blocks<span class="token punctuation">,</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>看起来很长的一段逻辑, 实际概括起来就 2 个步骤。</p>
<p><img src="https://pic.imgdb.cn/item/65a3caf2871b83018a0233a0.png" alt="Alt &#39;AOF 重写缓冲区写入过程&#39;"></p>
<blockquote>
<ol>
<li>将客户端的命令转为 RESP 协议格式的字符串</li>
<li>将 RESP 协议格式的字符串写入到 AOF 缓冲区中<blockquote>
<p>2.1 写入的 AOF 缓冲区本质是一个链表, 尾节点还有空间, 那么尾结点能写多少就写多少<br>2.2 尾节点写完了, 就重新分配一个节点, 然后继续写入, 直到现在的命令字符串写完</p>
</blockquote>
</li>
</ol>
</blockquote>
<p><strong>2. AOF 子进程差异缓冲区</strong>  </p>
<p>通过上面的简单流程, 我们知道: 整个 AOF 重写过程是在通过 fork 函数, 克隆出一个子进程进行操作。<br>因为正常整个 Redis 的内存会很大, 重写的时间会很长, 如果把这个过程放在父进程, 过程会影响到 Redis 的正常运行,</p>
<p>同理, 整个 Redis 的内存很大, 所以整个 AOF 重写的过程不会很快, 那么这段时间产生的新的变更命令 (存放在上面的 AOF 重写缓冲区), 可能也会很多。<br>如果这些命令追加到新的 AOF 文件中放在父进程, 也可能会影响到 Redis 的正常运行。  </p>
<p>所以 Redis 重写过程中，会通过 Pipe 通道, 将这些命令同步给子进程自己的一个缓存区。<br>子进程在根据内存数据库重写完成后, 随便将这个缓冲区的数据追加到新的 AOF 文件中, 即把这段重写过程中产生的变更命令还是让子进程来处理。  </p>
<p>而这个缓冲区就是 <strong>AOF 子进程差异缓冲区</strong>，定义如下</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">redisServer</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// AOF 子进程差异缓冲区</span>
    sds aof_child_diff<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span></code></pre>
<p>同样是一个字符串 sds。</p>
<p>子进程通过 Pipe 将 AOF 重写缓存区的数据同步到这个 AOF 子进程差异缓冲区的逻辑如下:</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 将 aof_pipe_read_data_from_parent 中的数据读取到 server.aof_child_diff 中</span>
<span class="token class-name">ssize_t</span> <span class="token function">aofReadDiffFromParent</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">65536</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> nread<span class="token punctuation">,</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 aof_pipe_read_data_from_parent 中的数据读取到 buf 中</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nread <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_pipe_read_data_from_parent<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 把 buf 的数据拼接到 aof_child_diff 中</span>
        server<span class="token punctuation">.</span>aof_child_diff <span class="token operator">=</span> <span class="token function">sdscatlen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_diff<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>nread<span class="token punctuation">)</span><span class="token punctuation">;</span>
        total <span class="token operator">+=</span> nread<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> total<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>备注: 这里还有个问题, 子进程将重写过程 AOF 变更命令追加到 AOF 文件的过程中, 还是会产生新的变更命令 (此时还是存放在 AOF 重写缓冲区中),<br>Redis 将这段时间的变更命令的写入文件放在了父进程执行了。</p>
<p>整个 AOF 重写的过程, 需要的了解的前提知识大概就这些了, 后面进入代码的逻辑分析。</p>
<h3 id="3-2-逻辑触发入口"><a href="#3-2-逻辑触发入口" class="headerlink" title="3.2 逻辑触发入口"></a>3.2 逻辑触发入口</h3><p>在 Redis 触发重写机制的方式有 2 个</p>
<blockquote>
<ol>
<li>通过 bgrewriteaof 命令</li>
<li>定时器, 定时检查 AOF 文件, 如果满足配置文件里面设置的条件, 就触发</li>
</ol>
</blockquote>
<p>bgrewriteaof 命令方式对应的逻辑函数为 <strong>bgrewriteaofCommand</strong>, 里面的逻辑如下</p>
<blockquote>
<ol>
<li>如果已经在执行重写中了, 返回错误提示</li>
<li>如果当前正在执行 RDB 保存时, 只会先将 redisServer 中的 aof_rewrite_scheduled 属性设置为 true, 返回提示后, 结束, 后面通过定时器判断这个状态确定是否需要触发</li>
<li>调用 rewriteAppendOnlyFileBackground 执行重写</li>
</ol>
</blockquote>
<p>而定时器的触发代码如下</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">serverCron</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">aeEventLoop</span> <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 代码省略</span>

    <span class="token comment">// 后台没有进程在 RDB 和 AOF, 同时通过 bgrewriteaof 命令设置了定时刷新重写 AOF  </span>
    <span class="token comment">// 当用户调用 bgrewriteaof 命令时, Redis 正在 RDB, 会先将 aof_rewrite_scheduled 设置为 true, 然后返回, 而不是执行 AOF </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>aof_rewrite_scheduled<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">rewriteAppendOnlyFileBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 后台有进程在 RDB 或者 AOF</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> <span class="token function">ldbPendingChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
        <span class="token comment">// 代码省略</span>
        
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    
        <span class="token comment">// 代码省略</span>

        <span class="token comment">// 1. 开启了 AOF 功能</span>
        <span class="token comment">// 2. 后台没有进程在 RDB 和 AOF</span>
        <span class="token comment">// 3. 配置了目前 AOF 文件大小超过上次重写的 AOF 文件的百分比</span>
        <span class="token comment">// 4. 当前的 AOF 文件大小超过了配置的需要触发重写的最小大小</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_state <span class="token operator">==</span> AOF_ON <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span>
            server<span class="token punctuation">.</span>aof_rewrite_perc <span class="token operator">&amp;&amp;</span> server<span class="token punctuation">.</span>aof_current_size <span class="token operator">></span> server<span class="token punctuation">.</span>aof_rewrite_min_size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            
            <span class="token comment">// 计算当前的文件增长的比例</span>
            <span class="token keyword">long</span> <span class="token keyword">long</span> base <span class="token operator">=</span> server<span class="token punctuation">.</span>aof_rewrite_base_size <span class="token operator">?</span> server<span class="token punctuation">.</span>aof_rewrite_base_size <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> <span class="token keyword">long</span> growth <span class="token operator">=</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_current_size<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span>base<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">;</span>  

            <span class="token comment">// 超过了就调用 rewriteAppendOnlyFileBackground 进行重写</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>growth <span class="token operator">>=</span> server<span class="token punctuation">.</span>aof_rewrite_perc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">rewriteAppendOnlyFileBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>  
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 代码省略</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>上面就是 AOF 重写触发的入口了, 而 AOF 重写的逻辑最终都是统一到了 <strong>rewriteAppendOnlyFileBackground</strong> 函数。</p>
<h3 id="3-3-具体的实现逻辑"><a href="#3-3-具体的实现逻辑" class="headerlink" title="3.3 具体的实现逻辑"></a>3.3 具体的实现逻辑</h3><h4 id="3-3-1-父进程执行-rewriteAppendOnlyFileBackground-函数-AOF-重写前的操作"><a href="#3-3-1-父进程执行-rewriteAppendOnlyFileBackground-函数-AOF-重写前的操作" class="headerlink" title="3.3.1 父进程执行 rewriteAppendOnlyFileBackground 函数, AOF 重写前的操作"></a>3.3.1 父进程执行 rewriteAppendOnlyFileBackground 函数, AOF 重写前的操作</h4><pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">rewriteAppendOnlyFileBackground</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token class-name">pid_t</span> childpid<span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token keyword">long</span> start<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>

    <span class="token comment">// 创建 Pipe 通道, 用于父子进程之间通信</span>
    <span class="token comment">// 内部会创建父子通讯需要的 6 个 Pipe</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aofCreatePipes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> C_OK<span class="token punctuation">)</span> 
        <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>  

    <span class="token comment">// 开通另一组通道, 不涉及主流程</span>
    <span class="token comment">// 用于子进程向父子进程通讯, 在 AOF 中主要用于通知父进程, 子进程此次重写使用了多少额外内存</span>
    <span class="token function">openChildInfoPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取当前时间</span>
    start <span class="token operator">=</span> <span class="token function">ustime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>childpid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    
        <span class="token comment">// 子进程 </span>
        <span class="token comment">// fork 完成, 子进程, 从这里开始执行逻辑</span>

        <span class="token comment">// 清除子进程不需要的资源</span>
        <span class="token function">closeClildUnusedResourceAfterFork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置标题</span>
        <span class="token function">redisSetProcTitle</span><span class="token punctuation">(</span><span class="token string">"redis-aof-rewrite"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建临时文件, 文件名 temp-rewriteaof-bg-进程ID.aof</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token string">"temp-rewriteaof-bg-%d.aof"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 执行 rewriteAppendOnlyFile 函数, 进行 AOF 文件的重写 </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rewriteAppendOnlyFile</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">)</span> <span class="token operator">==</span> C_OK<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token comment">// 子进程重写完成的一些收尾工作, 基本不涉及主流程, 通知父进程过程中子进程修改了多少数据</span>

            <span class="token comment">// 计算当前进程使用修改了多少内存</span>
            <span class="token class-name">size_t</span> private_dirty <span class="token operator">=</span> <span class="token function">zmalloc_get_private_dirty</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>private_dirty<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span> <span class="token string">"AOF rewrite: %zu MB of memory used by copy-on-write"</span><span class="token punctuation">,</span> private_dirty<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            server<span class="token punctuation">.</span>child_info_data<span class="token punctuation">.</span>cow_size <span class="token operator">=</span> private_dirty<span class="token punctuation">;</span>
            <span class="token comment">// 子进程的信息发送给父进程, 也就是拷贝到 server.child_info_pipe[2] 中</span>
            <span class="token function">sendChildInfo</span><span class="token punctuation">(</span>CHILD_INFO_TYPE_AOF<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 结束</span>
            <span class="token function">exitFromChild</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token function">exitFromChild</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 父进程</span>
        <span class="token comment">// fork 完成, 父进程, 从这里开始执行逻辑</span>

        <span class="token comment">// 计算 fork 消耗的时间</span>
        server<span class="token punctuation">.</span>stat_fork_time <span class="token operator">=</span> <span class="token function">ustime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start<span class="token punctuation">;</span>
        <span class="token comment">// 计算 fork 的速率，GB/每秒</span>
        server<span class="token punctuation">.</span>stat_fork_rate <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token function">zmalloc_used_memory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000000</span> <span class="token operator">/</span> server<span class="token punctuation">.</span>stat_fork_time <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 延迟统计</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"fork"</span><span class="token punctuation">,</span>server<span class="token punctuation">.</span>stat_fork_time<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childpid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// fork 失败 关闭通道</span>
            <span class="token function">closeChildInfoPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Can't rewrite append only file in background: fork: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">aofClosePipes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"Background append only file rewriting started by pid %d"</span><span class="token punctuation">,</span>childpid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        server<span class="token punctuation">.</span>aof_rewrite_scheduled <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>aof_rewrite_time_start <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">=</span> childpid<span class="token punctuation">;</span>

        <span class="token comment">// 和 RDB 类似, 更新全局的 dict.dict_can_resize 进行字典扩容的控制, 控制存储数据的 dict 扩容</span>
        <span class="token function">updateDictResizePolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        server<span class="token punctuation">.</span>aof_selected_db <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">// 清空 redisServer 的 repl_scriptcache_dict 字典和 repl_scriptcache_fifo 这个列表</span>
        <span class="token comment">// 和主从复制相关</span>
        <span class="token function">replicationScriptCacheFlush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<h4 id="3-3-2-子进程执行的-rewriteAppendOnlyFile-函数就是-AOF-重写真正过程"><a href="#3-3-2-子进程执行的-rewriteAppendOnlyFile-函数就是-AOF-重写真正过程" class="headerlink" title="3.3.2 子进程执行的 rewriteAppendOnlyFile 函数就是 AOF 重写真正过程"></a>3.3.2 子进程执行的 rewriteAppendOnlyFile 函数就是 AOF 重写真正过程</h4><pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">// 这里的入参 filename 格式为 temp-rewriteaof-bg-进程 ID, 而不是真正的 AOF 文件名</span>
<span class="token keyword">int</span> <span class="token function">rewriteAppendOnlyFile</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    rio aof<span class="token punctuation">;</span>
    FILE <span class="token operator">*</span>fp<span class="token punctuation">;</span>
    <span class="token keyword">char</span> tmpfile<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> byte<span class="token punctuation">;</span>

    <span class="token comment">// 重新根据进程ID 获取一个文件名 temp-rewriteaof-进程ID.aof 的文件</span>
    <span class="token comment">// 数据先写入到这个文件, 后面在重命名为入参的 filename</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token string">"temp-rewriteaof-%d.aof"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fp <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fp<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Opening the temp file for AOF rewrite in rewriteAppendOnlyFile(): %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 清空 aof_child_diff 的数据, 这个就是 AOF 子进程差异缓冲区</span>
    server<span class="token punctuation">.</span>aof_child_diff <span class="token operator">=</span> <span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始 rio 流, 也就是 IO 流, 用于写入数据到文件</span>
    <span class="token function">rioInitWithFile</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>aof<span class="token punctuation">,</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置文件自动同步</span>
    <span class="token comment">// 当写入的字节数达到了 REDIS_AUTOSYNC_BYTES (1024*1024*32) 的倍数, 就执行一次 fsync,</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_rewrite_incremental_fsync<span class="token punctuation">)</span>
        <span class="token function">rioSetAutoSync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>aof<span class="token punctuation">,</span>REDIS_AUTOSYNC_BYTES<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Redis 4.0 的特性, AOF 和 RDB 混用</span>
    <span class="token comment">// 先将当前的数据以 RDB 的格式存储下来, 添加的这段时间, 在缓冲区的再以 AOF 的方式存储</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_use_rdb_preamble<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">int</span> error<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rdbSaveRio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>aof<span class="token punctuation">,</span><span class="token operator">&amp;</span>error<span class="token punctuation">,</span>RDB_SAVE_AOF_PREAMBLE<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            errno <span class="token operator">=</span> error<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 将当前 Redis 内存数据库中的数据写入到 AOF 文件中</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rewriteAppendOnlyFileRio</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>aof<span class="token punctuation">)</span> <span class="token operator">==</span> C_ERR<span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> 

    <span class="token comment">// 当前的内存数据库的数据都写入完成</span>
    <span class="token comment">// 执行 fflush 函数, 更新缓存中的数据到文件中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fflush</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>  

    <span class="token comment">// 执行 fsync 函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fsync</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>

    <span class="token keyword">int</span> nodata <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">mstime_t</span> start <span class="token operator">=</span> <span class="token function">mstime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 尽量 将内存数据写入到 AOF 临时文件过程中 产生的差异命令同步过来</span>
    <span class="token comment">// 当前时间和重写的开始时间差在 1 秒内, 同时没有连续 20 次读取到空数据</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">mstime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start <span class="token operator">&lt;</span> <span class="token number">1000</span> <span class="token operator">&amp;&amp;</span> nodata <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 尝试从通道 aof_pipe_read_data_from_parent 也就是重写缓冲区中读取数据, 每次阻塞 1 毫秒</span>
        <span class="token comment">// 读取到的数据长度小于等于 0, 进入下一次循环, 为读取到数据次数 + 1</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aeWait</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_pipe_read_data_from_parent<span class="token punctuation">,</span> AE_READABLE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            nodata<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        nodata <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
        <span class="token comment">// 从重写缓冲区读数据到 aof_child_diff</span>
        <span class="token function">aofReadDiffFromParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>



    <span class="token comment">// 写入一个 ！ 到 aof_pipe_write_ack_to_parent, 通过通道间接同步到父级的 aof_pipe_read_ack_from_child</span>
    <span class="token comment">// 请求父进程停止发送差异数据, 也就是重写缓冲区</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">write</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_pipe_write_ack_to_parent<span class="token punctuation">,</span><span class="token string">"!"</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>

    <span class="token comment">// 将从父级读取 ack 的 aof_pipe_read_ack_from_parent 设置为非阻塞的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">anetNonBlock</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span>server<span class="token punctuation">.</span>aof_pipe_read_ack_from_parent<span class="token punctuation">)</span> <span class="token operator">!=</span> ANET_OK<span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>

    <span class="token comment">// 在 5000ms 之内，从 aof_pipe_read_ack_from_parent 读取 1 个字节的数据保存在 byte 中, 同时判断 byte 是否为 '!'</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">syncRead</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_pipe_read_ack_from_parent<span class="token punctuation">,</span><span class="token operator">&amp;</span>byte<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5000</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> byte <span class="token operator">!=</span> <span class="token char">'!'</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>

    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"Parent agreed to stop sending diffs. Finalizing AOF..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 此时父进程不会在同步差异命令过来了, 再做最后一次同步, 将 Pipe 通道中残留的数据同步过来</span>
    <span class="token comment">// 再次从父级中读取差异数据</span>
    <span class="token function">aofReadDiffFromParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span> <span class="token string">"Concatenating %.2f MB of AOF diff received from parent."</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token function">sdslen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_diff<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 将 aof_child_diff 中的数据写入到 aof 文件中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWrite</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>aof<span class="token punctuation">,</span>server<span class="token punctuation">.</span>aof_child_diff<span class="token punctuation">,</span><span class="token function">sdslen</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_diff<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fflush</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fsync</span><span class="token punctuation">(</span><span class="token function">fileno</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>

    <span class="token comment">// 重命名文件名</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rename</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span>filename<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Error moving temp append only file on the final destination: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unlink</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"SYNC append only file rewrite performed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

werr<span class="token operator">:</span>
    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"Write error writing append only file on disk: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">unlink</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>   
<span class="token punctuation">&#125;</span></code></pre>

<p><strong>子进程将自身内存数据库中的数据写入到 AOF 临时文件的逻辑</strong></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">/**
 * 将 Redis 数据库中的数据都写入到文件
 * 原理就是变量数据库中的数据, 然后将每个 key 和 key 对应的 value 写入到文件中
 * 同时为较小文件的大小, 会使用批量相关的命令来替代单个命令
 * 比如向 list 类型的结构添加数据, 可以通过 lset 一个一个元素的添加, 也可以通过 RPUSH 一次添加多个
 * 所以 Redis AOF 文件能缩小的原因就是这个
 * 
 * 同时内部为了安全性, 单个批量命令内部的元素会控制不超过 AOF_REWRITE_ITEMS_PER_CMD 64 个
 */</span>
<span class="token keyword">int</span> <span class="token function">rewriteAppendOnlyFileRio</span><span class="token punctuation">(</span>rio <span class="token operator">*</span>aof<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    dictIterator <span class="token operator">*</span>di <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    dictEntry <span class="token operator">*</span>de<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> processed <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> j<span class="token punctuation">;</span>

    <span class="token comment">// 逐个遍历所有的数据库</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> server<span class="token punctuation">.</span>dbnum<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

        <span class="token keyword">char</span> selectcmd<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"*2\r\n$6\r\nSELECT\r\n"</span><span class="token punctuation">;</span>
        redisDb <span class="token operator">*</span>db <span class="token operator">=</span> server<span class="token punctuation">.</span>db<span class="token operator">+</span>j<span class="token punctuation">;</span>
        dict <span class="token operator">*</span>d <span class="token operator">=</span> db<span class="token operator">-></span>dict<span class="token punctuation">;</span>

        <span class="token comment">// 对应的数据库没有数据, 跳过</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dictSize</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
            
        <span class="token comment">// 字典迭代器</span>
        di <span class="token operator">=</span> <span class="token function">dictGetSafeIterator</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 向文件中写入 *2\r\n$6\r\nSELECT\r\n数据库的编号的长度\r\n数据库的编号, 也就是 select 数据库</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWrite</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span>selectcmd<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>selectcmd<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWriteBulkLongLong</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span>j<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>de <span class="token operator">=</span> <span class="token function">dictNext</span><span class="token punctuation">(</span>di<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    
            sds keystr<span class="token punctuation">;</span>
            robj key<span class="token punctuation">,</span> <span class="token operator">*</span>o<span class="token punctuation">;</span>
            <span class="token keyword">long</span> <span class="token keyword">long</span> expiretime<span class="token punctuation">;</span>

            keystr <span class="token operator">=</span> <span class="token function">dictGetKey</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
            o <span class="token operator">=</span> <span class="token function">dictGetVal</span><span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将字符串的 key 转为 redisObject 对象, 编码 encoding 默认为 OBJ_ENCODING_RAW, 引用次数 refcount 为 1</span>
            <span class="token function">initStaticStringObject</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>keystr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
            expiretime <span class="token operator">=</span> <span class="token function">getExpire</span><span class="token punctuation">(</span>db<span class="token punctuation">,</span><span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>type <span class="token operator">==</span> OBJ_STRING<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

                <span class="token keyword">char</span> cmd<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"*3\r\n$3\r\nSET\r\n"</span><span class="token punctuation">;</span>
                <span class="token comment">// 写入上面的文本</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWrite</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span>cmd<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
                <span class="token comment">// 写入 key </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWriteBulkObject</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span><span class="token operator">&amp;</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
                <span class="token comment">// 写入 value</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWriteBulkObject</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span>o<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>

            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>type <span class="token operator">==</span> OBJ_LIST<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rewriteListObject</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span><span class="token operator">&amp;</span>key<span class="token punctuation">,</span>o<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>type <span class="token operator">==</span> OBJ_SET<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 下面的几个写入和 list 类型跳过</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rewriteSetObject</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span><span class="token operator">&amp;</span>key<span class="token punctuation">,</span>o<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>type <span class="token operator">==</span> OBJ_ZSET<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rewriteSortedSetObject</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span><span class="token operator">&amp;</span>key<span class="token punctuation">,</span>o<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>type <span class="token operator">==</span> OBJ_HASH<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rewriteHashObject</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span><span class="token operator">&amp;</span>key<span class="token punctuation">,</span>o<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>type <span class="token operator">==</span> OBJ_STREAM<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rewriteStreamObject</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span><span class="token operator">&amp;</span>key<span class="token punctuation">,</span>o<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>type <span class="token operator">==</span> OBJ_MODULE<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rewriteModuleObject</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span><span class="token operator">&amp;</span>key<span class="token punctuation">,</span>o<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"Unknown object type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

                        <span class="token comment">// 如果 key 设置了过期时间, 写入过期时间</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>expiretime <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">char</span> cmd<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">"*3\r\n$9\r\nPEXPIREAT\r\n"</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWrite</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span>cmd<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWriteBulkObject</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span><span class="token operator">&amp;</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWriteBulkLongLong</span><span class="token punctuation">(</span>aof<span class="token punctuation">,</span>expiretime<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> werr<span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// AOF_READ_DIFF_INTERVAL_BYTES = 1024*10</span>
            <span class="token comment">// 重写文件每写入 10 M,  就通过通道从父级中读取差异</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>aof<span class="token operator">-></span>processed_bytes <span class="token operator">></span> processed <span class="token operator">+</span> AOF_READ_DIFF_INTERVAL_BYTES<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 更新已写的字节数</span>
                processed <span class="token operator">=</span> aof<span class="token operator">-></span>processed_bytes<span class="token punctuation">;</span>
                <span class="token comment">// 通过通道 aof_pipe_read_data_from_parent 将重写缓冲区中的数据读取到 aof_child_diff 中</span>
                <span class="token function">aofReadDiffFromParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> C_OK<span class="token punctuation">;</span>

werr<span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>di<span class="token punctuation">)</span>
        <span class="token function">dictReleaseIterator</span><span class="token punctuation">(</span>di<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> C_ERR<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// list 类型的数据写入</span>
<span class="token keyword">int</span> <span class="token function">rewriteListObject</span><span class="token punctuation">(</span>rio <span class="token operator">*</span>r<span class="token punctuation">,</span> robj <span class="token operator">*</span>key<span class="token punctuation">,</span> robj <span class="token operator">*</span>o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">long</span> <span class="token keyword">long</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> items <span class="token operator">=</span> <span class="token function">listTypeLength</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>o<span class="token operator">-></span>encoding <span class="token operator">==</span> OBJ_ENCODING_QUICKLIST<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
        quicklist <span class="token operator">*</span>list <span class="token operator">=</span> o<span class="token operator">-></span>ptr<span class="token punctuation">;</span>
        quicklistIter <span class="token operator">*</span>li <span class="token operator">=</span> <span class="token function">quicklistGetIterator</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> AL_START_HEAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        quicklistEntry entry<span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">quicklistNext</span><span class="token punctuation">(</span>li<span class="token punctuation">,</span><span class="token operator">&amp;</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                
                <span class="token comment">// 获取当前  rpush 的元素个数, 最大为 AOF_REWRITE_ITEMS_PER_CMD 64 个</span>
                <span class="token keyword">int</span> cmd_items <span class="token operator">=</span> <span class="token punctuation">(</span>items <span class="token operator">></span> AOF_REWRITE_ITEMS_PER_CMD<span class="token punctuation">)</span> <span class="token operator">?</span>  AOF_REWRITE_ITEMS_PER_CMD <span class="token operator">:</span> items<span class="token punctuation">;</span>

                <span class="token comment">// 写入参数个数 *参数个数</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWriteBulkCount</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span><span class="token char">'*'</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token operator">+</span>cmd_items<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment">// 写入 rpush 命令</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWriteBulkString</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span><span class="token string">"RPUSH"</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment">// 写入 key 值</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWriteBulkObject</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// 依次写入元素</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWriteBulkString</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>entry<span class="token punctuation">.</span>value<span class="token punctuation">,</span>entry<span class="token punctuation">.</span>sz<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rioWriteBulkLongLong</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>entry<span class="token punctuation">.</span>longval<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>

            <span class="token comment">// 写入一次 count + 1 次, 当 count == 上限的 64 个, 重新值为 0</span>
            <span class="token comment">// 从而可以重新写入一个 rpush</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">==</span> AOF_REWRITE_ITEMS_PER_CMD<span class="token punctuation">)</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            items<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">quicklistReleaseIterator</span><span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">serverPanic</span><span class="token punctuation">(</span><span class="token string">"Unknown list encoding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>整个 AOF 重写的因为涉及到了子进程, 所以复杂度就上去了, 整理如下:</p>
<p>父进程</p>
<blockquote>
<ol>
<li>定时器判断满足重写条件或者执行了 bgrewriteaof 命令, 触发 AOF 重写</li>
<li>父进程创建出 6 个文件描述符, 用来创建 6 个通道, 分别用于: 父进程将数据写给子进程, 子进程通知父进程 ack, 父进程通知子进程 ack</li>
<li>创建完通道后, 设置 aof_stop_sending_diff 为 0, 也就是 false, 表示可以将重写缓冲区的数据继续推送给子进程</li>
<li>父进程 fork 出一个子进程, 然后进行一些统计相同的配置后, 进行处理其他的命令 (此处是子进程的开始地方)</li>
<li>父进程处理到修改性质的命令时, 依旧是会进行把当前命令的变更写的已有的 AOF 文件中, 同时判断到当前在进行 AOF 重写, 会把当前命令对应的文本保存到 AOF 重写缓存区  aof_rewrite_buf_blocks</li>
<li>判断当前的 AE 循环中是否有 aof_pipe_write_data_to_child 这个文件描述符 (这个就是上面 6 个文件描述符之一) 对应的文件, 没有则创建 1 个文件, 执行的逻辑为 aofChildWriteDiffData</li>
<li>因为有事件存在, 每次 AE 循环时, 都会执行到 aofChildWriteDiffData 函数, 逻辑就是将 AOF 重写缓存区 aof_rewrite_buf_blocks 中的数据全部写到 aof_pipe_write_data_to_child 中, 同时在 aof_stop_sending_diff 为 true 或者 aof_rewrite_buf_blocks 中的数据转移完成时, 删除这个事件。写入到 aof_pipe_write_data_to_child 的数据在通道的作用下, 会自动同步到子进程的 aof_pipe_read_data_from_parent 中</li>
</ol>
</blockquote>
<p>上面就是父进程的逻辑, 下面的子进程的逻辑  </p>
<blockquote>
<ol>
<li>因为子进程是通过 fork 操作创建出来的, 所以子进程和父进程是完全一样的, 也就是当前子进程拥有着和父进程一样的字典, 存放着所有键值对的数据, 同时不受父进程的影响, 也就是快照</li>
<li>临时创建出一个 temp-rewriteaof-bg-进程ID.aof 文件, 用来保存当前的数据</li>
<li>判断 server.aof_use_rdb_preamble 是否为 true, 也就是是否开启了 RDB 和 AOF 混用的功能, 开启了, 就先将当前的数据字典的数据以 RDB 的方式进行保存, 否则就是根据数据字典执行命令重写</li>
<li>命令重写的逻辑: 用批量相关的命令来替代单个命令, 同时在执行的过程中不断的将 aof_pipe_read_data_from_parent 中的数据读取到自身的 aof_child_diff 中</li>
<li>数据字典中的数据都处理完成后, 子进程向 aof_pipe_write_ack_to_parent 写入一个 !, 在通道的同步下, 同步到父进程的 aof_pipe_read_ack_from_child 中 (父级收到了, 先将 aof_stop_sending_diff 设置为 true, 向 aof_pipe_write_ack_to_child 写入了一个 ！, 同样在管道的同步下, 最终到了子进程的 aof_pipe_read_ack_from_parent, 最后删除这个 aof_pipe_read_ack_from_child 描述符的事件)</li>
<li>向 aof_pipe_write_ack_to_parent 写入 ! 后, 等待 5000ms, 从 aof_pipe_read_ack_from_parent 中读取数据, 超时读取, 读取到的不是 !, 异常处理, 结束</li>
<li>从 aof_pipe_read_ack_from_parent 读取到了 ！, 表示读取到了父级的确认 ack, 最后一次从 aof_pipe_read_data_from_parent 读取数据到 aof_child_diff, 确保在文件描述符中没有父进程写向子进程的数据了</li>
<li>把 aof_child_diff 中的数据追加到临时的 AOF 文件中</li>
<li>通过 rename 函数将临时文件重命名为配置的入参的文件名 (AOF 重写入参的文件名为: temp-rewriteaof-bg-进程ID.aof,  rename 函数会先将同名的文件, 文件夹删除)</li>
</ol>
</blockquote>
<p>从上面的过程中看起来, 好像完美了, 但是别忘了这里涉及到了并发, 在父子进程互相 ack 确认时, 父进程收到 ack 时, 只是把 aof_stop_sending_diff 设置为 true, 也就是确保 AOF 重写缓存区的数据不会再写给子进程。<br>而子进程收到 ack, 只是把当前所有的 AOF 重写缓存区中的数据写入到文件中, 子进程自己的任务到此就结束了。  </p>
<p>而这个过程, 父进程还会继续处理其他的命令, 这些新的命令只能由父进程自己处理</p>
<blockquote>
<ol>
<li>将当前 AOF 重写缓存区中的数据写入到 AOF 临时文件</li>
<li>重命名 AOF 临时文件, 整个 AOF 重写正式完成</li>
</ol>
</blockquote>
<h4 id="3-3-3-父进程监听子进程结束-AOF-重写收尾"><a href="#3-3-3-父进程监听子进程结束-AOF-重写收尾" class="headerlink" title="3.3.3 父进程监听子进程结束, AOF 重写收尾"></a>3.3.3 父进程监听子进程结束, AOF 重写收尾</h4><p>首先入口, 还是在定时器 serveCron 中, 定时的检查子进程的状态是否为结束了, 是的话, 执行结束逻辑</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">serverCron</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">aeEventLoop</span> <span class="token operator">*</span>eventLoop<span class="token punctuation">,</span> <span class="token keyword">long</span> <span class="token keyword">long</span> id<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>clientData<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 省略</span>

    <span class="token comment">// 检查是否有 RDB 子进程或者 AOF 重写子进程结束了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>rdb_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> <span class="token function">ldbPendingChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

        <span class="token keyword">int</span> statloc<span class="token punctuation">;</span>
        <span class="token class-name">pid_t</span> pid<span class="token punctuation">;</span>
        
        <span class="token comment">// wait3 可以获取所有的进程是否有一个进程退出状态的, 有的话, 进行彻底的销毁，同时返回其进程 id</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pid <span class="token operator">=</span> <span class="token function">wait3</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>statloc<span class="token punctuation">,</span>WNOHANG<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

            <span class="token keyword">int</span> exitcode <span class="token operator">=</span> <span class="token function">WEXITSTATUS</span><span class="token punctuation">(</span>statloc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> bysignal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WIFSIGNALED</span><span class="token punctuation">(</span>statloc<span class="token punctuation">)</span><span class="token punctuation">)</span> 
                bysignal <span class="token operator">=</span> <span class="token function">WTERMSIG</span><span class="token punctuation">(</span>statloc<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 异常情况, 打印日志</span>
                <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span><span class="token string">"wait3() returned an error: %s. rdb_child_pid = %d, aof_child_pid = %d"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> server<span class="token punctuation">.</span>rdb_child_pid<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> server<span class="token punctuation">.</span>aof_child_pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> server<span class="token punctuation">.</span>rdb_child_pid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// rdb 进程逻辑省略</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> server<span class="token punctuation">.</span>aof_child_pid<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 进程 id 为 AOF 重写进程 id</span>
                <span class="token comment">// 执行最终的清除逻辑</span>
                <span class="token function">backgroundRewriteDoneHandler</span><span class="token punctuation">(</span>exitcode<span class="token punctuation">,</span>bysignal<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bysignal <span class="token operator">&amp;&amp;</span> exitcode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> 
                    <span class="token comment">// 获取子进程发送给父进程的信息</span>
                    <span class="token function">receiveChildInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// 其他的情况</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ldbRemoveChild</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Warning, detected child with unmatched pid: %ld"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>  

            <span class="token comment">// 重新设置字典的可以扩容标识为 true</span>
            <span class="token function">updateDictResizePolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 关闭 Pipe </span>
            <span class="token function">closeChildInfoPipe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">&#125;</span>

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    
        <span class="token comment">// 判断是否需要进行 RDB 或者 AOF 重写</span>

        <span class="token comment">// 省略</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 省略</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 父进程对 AOF 重写最后的处理</span>
<span class="token keyword">void</span> <span class="token function">backgroundRewriteDoneHandler</span><span class="token punctuation">(</span><span class="token keyword">int</span> exitcode<span class="token punctuation">,</span> <span class="token keyword">int</span> bysignal<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// exitcode == 0 表示子进程是执行完逻辑后, 主动退出的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bysignal <span class="token operator">&amp;&amp;</span> exitcode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
        <span class="token keyword">int</span> newfd<span class="token punctuation">,</span> oldfd<span class="token punctuation">;</span>
        <span class="token keyword">char</span> tmpfile<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token function">ustime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">mstime_t</span> latency<span class="token punctuation">;</span>

        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span> <span class="token string">"Background AOF rewrite terminated with success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 再次通过子进程的进程 ID 获取到 AOF 重写的临时文件名 temp-rewriteaof-bg-进程ID.aof, 也就是 AOF 重写临时文件</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token string">"temp-rewriteaof-bg-%d.aof"</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>server<span class="token punctuation">.</span>aof_child_pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 打开文件</span>
        newfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span>O_WRONLY<span class="token operator">|</span>O_APPEND<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>newfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Unable to open the temporary AOF produced by the child: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// 把最后剩余的信息从 aof_rewrite_buf_blocks 写入到指定的文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">aofRewriteBufferWrite</span><span class="token punctuation">(</span>newfd<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Error trying to flush the parent diff to the rewritten AOF: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        
        <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"aof-rewrite-diff-write"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span><span class="token string">"Residual parent diff successfully flushed to the rewritten AOF (%.2f MB)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> <span class="token function">aofRewriteBufferSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// aof_fd 为当前的 AOF 文件的文件描述符, 等于 -1, 应该是 AOF 功能停用了</span>
        <span class="token comment">// 这时为了下面的流程能走下去, 从配置文件中获取到配置的文件名, 尝试打开禁用前的文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            oldfd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_filename<span class="token punctuation">,</span>O_RDONLY<span class="token operator">|</span>O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            oldfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">latencyStartMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将临时文件重命名为配置的文件名</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rename</span><span class="token punctuation">(</span>tmpfile<span class="token punctuation">,</span>server<span class="token punctuation">.</span>aof_filename<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Error trying to rename the temporary AOF file %s into %s: %s"</span><span class="token punctuation">,</span> tmpfile<span class="token punctuation">,</span> server<span class="token punctuation">.</span>aof_filename<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span>oldfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> cleanup<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">latencyEndMonitor</span><span class="token punctuation">(</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">latencyAddSampleIfNeeded</span><span class="token punctuation">(</span><span class="token string">"aof-rename"</span><span class="token punctuation">,</span>latency<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">close</span><span class="token punctuation">(</span>newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>

            oldfd <span class="token operator">=</span> server<span class="token punctuation">.</span>aof_fd<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>aof_fd <span class="token operator">=</span> newfd<span class="token punctuation">;</span>

            <span class="token comment">// 根据同步策略进行 fsync</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fsync <span class="token operator">==</span> AOF_FSYNC_ALWAYS<span class="token punctuation">)</span>
                <span class="token function">redis_fsync</span><span class="token punctuation">(</span>newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_fsync <span class="token operator">==</span> AOF_FSYNC_EVERYSEC<span class="token punctuation">)</span>
                <span class="token function">aof_background_fsync</span><span class="token punctuation">(</span>newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

            server<span class="token punctuation">.</span>aof_selected_db <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
            <span class="token comment">// 更新当前 AOF 文件的大小</span>
            <span class="token function">aofUpdateCurrentSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新最新的 AOF 文件大小和重写大小</span>
            server<span class="token punctuation">.</span>aof_rewrite_base_size <span class="token operator">=</span> server<span class="token punctuation">.</span>aof_current_size<span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>aof_fsync_offset <span class="token operator">=</span> server<span class="token punctuation">.</span>aof_current_size<span class="token punctuation">;</span>   

            <span class="token function">sdsfree</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
            server<span class="token punctuation">.</span>aof_buf <span class="token operator">=</span> <span class="token function">sdsempty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">&#125;</span>

        server<span class="token punctuation">.</span>aof_lastbgrewrite_status <span class="token operator">=</span> C_OK<span class="token punctuation">;</span>

        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_NOTICE<span class="token punctuation">,</span> <span class="token string">"Background AOF rewrite finished successfully"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_state <span class="token operator">==</span> AOF_WAIT_REWRITE<span class="token punctuation">)</span>
            server<span class="token punctuation">.</span>aof_state <span class="token operator">=</span> AOF_ON<span class="token punctuation">;</span>

        <span class="token comment">// 关闭打开的文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldfd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
            <span class="token function">bioCreateBackgroundJob</span><span class="token punctuation">(</span>BIO_CLOSE_FILE<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>oldfd<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    

        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_VERBOSE<span class="token punctuation">,</span><span class="token string">"Background AOF rewrite signal handler took %lldus"</span><span class="token punctuation">,</span> <span class="token function">ustime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>   

    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bysignal <span class="token operator">&amp;&amp;</span> exitcode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 非正常退出</span>
        server<span class="token punctuation">.</span>aof_lastbgrewrite_status <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>
        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Background AOF rewrite terminated with error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 非正常退出</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bysignal <span class="token operator">!=</span> SIGUSR1<span class="token punctuation">)</span>
            server<span class="token punctuation">.</span>aof_lastbgrewrite_status <span class="token operator">=</span> C_ERR<span class="token punctuation">;</span>

        <span class="token function">serverLog</span><span class="token punctuation">(</span>LL_WARNING<span class="token punctuation">,</span> <span class="token string">"Background AOF rewrite terminated by signal %d"</span><span class="token punctuation">,</span> bysignal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

cleanup<span class="token operator">:</span>
    <span class="token comment">// 清除工作</span>
    <span class="token function">aofClosePipes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">aofRewriteBufferReset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">aofRemoveTempFile</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_child_pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>aof_child_pid <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>aof_rewrite_time_last <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">-</span>server<span class="token punctuation">.</span>aof_rewrite_time_start<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>aof_rewrite_time_start <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_state <span class="token operator">==</span> AOF_WAIT_REWRITE<span class="token punctuation">)</span>
        server<span class="token punctuation">.</span>aof_rewrite_scheduled <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
<span class="token punctuation">&#125;</span>

<span class="token comment">// AOF 重写缓冲区数据写入文件</span>
<span class="token class-name">ssize_t</span> <span class="token function">aofRewriteBufferWrite</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    listNode <span class="token operator">*</span>ln<span class="token punctuation">;</span>
    listIter li<span class="token punctuation">;</span>
    <span class="token class-name">ssize_t</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">listRewind</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span>aof_rewrite_buf_blocks<span class="token punctuation">,</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ln <span class="token operator">=</span> <span class="token function">listNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>li<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        aofrwblock <span class="token operator">*</span>block <span class="token operator">=</span> <span class="token function">listNodeValue</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ssize_t</span> nwritten<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>block<span class="token operator">-></span>used<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            nwritten <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>block<span class="token operator">-></span>buf<span class="token punctuation">,</span>block<span class="token operator">-></span>used<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nwritten <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">ssize_t</span><span class="token punctuation">)</span>block<span class="token operator">-></span>used<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>nwritten <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> errno <span class="token operator">=</span> EIO<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
            count <span class="token operator">+=</span> nwritten<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> count<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>

<p>到了这一步, 整个 AOF 的重写过程才真正的结束了。</p>
<h2 id="4-参考"><a href="#4-参考" class="headerlink" title="4 参考"></a>4 参考</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/men_wen/article/details/71375513">Redis源码剖析和注释（十八）— Redis AOF持久化机制</a></p>

                
            </div>
            <hr/>
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/article/2022/277668067/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="如何计算 MySQL 单表中能存放多少条数据">
                        
                        <span class="card-title">如何计算 MySQL 单表中能存放多少条数据</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-04-08
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            敲代码的小小酥
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%BD%AC%E8%BD%BD/">
                        <span class="chip bg-color">转载</span>
                    </a>
                    
                    <a href="/tags/MySQL/">
                        <span class="chip bg-color">MySQL</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/article/2021/3668008816/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/3.jpg" class="responsive-img" alt="Redis AOF 基础">
                        
                        <span class="card-title">Redis AOF 基础</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-12-19
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            Lcn29
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Redis/">
                        <span class="chip bg-color">Redis</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2024</span>
            
            <br/>

            Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            &nbsp; | &nbsp;&nbsp;Theme <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>

            
            <br>
            
            
                <span id="busuanzi_container_site_pv">
                    总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>
                </span>
            
            
                <span id="busuanzi_container_site_uv">
                    &nbsp; | &nbsp;&nbsp;总访问人数:&nbsp; <span id="busuanzi_value_site_uv" class="white-color"></span>
                </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
